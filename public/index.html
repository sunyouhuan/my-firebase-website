<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MatchAI - AI é©…å‹•çš„ç¶²ç´…è¡ŒéŠ·å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* cool gray 50 */
        }
        .view, .dashboard-content {
            display: none;
        }
        .view.active, .dashboard-content.active {
            display: block;
        }
        .sidebar-link {
            transition: all 0.2s;
        }
        .sidebar-link.active, .sidebar-link:hover {
            background-color: #f1f5f9; /* slate 100 */
            color: #1e293b; /* slate 800 */
            transform: translateX(4px);
            border-left: 3px solid #0d9488; /* teal 600 */
        }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            color: #0d9488; /* teal 600 */
            border-bottom-color: #0d9488;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body>

    <div id="app">

        <div id="login-view" class="view active">
            <div class="min-h-screen bg-slate-100 flex flex-col justify-center items-center p-4">
                <div class="text-4xl font-bold text-gray-800 mb-2">Match<span class="text-teal-500">AI</span></div>
                <p class="text-gray-600 mb-8">ç”¨ AI é è¦‹è¡ŒéŠ·æˆæ•ˆ</p>
                <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-slate-800">ç™»å…¥æ‚¨çš„å¸³è™Ÿ</h2>
                    <form id="login-form" class="space-y-4" onsubmit="return false;">
                        <div>
                            <label for="email" class="text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                            <input id="email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div>
                            <label for="password" class="text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                            <input id="password" name="password" type="password" autocomplete="current-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button type="button" onclick="handleLogin()" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 transition-colors">ç™»å…¥</button>
                            <button type="button" onclick="handleRegister()" class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition-colors">è¨»å†Šæ–°å¸³è™Ÿ</button>
                        </div>
                        <div class="relative flex py-3 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-400 text-sm">æˆ–</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>

                        <button type="button" onclick="handleGoogleLogin()" class="w-full flex justify-center items-center bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 transition-colors">
                            <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                                <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.021,35.592,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                            </svg>
                            ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                        </button>
                    </form>

                </div>
            </div>
        </div>


        <div id="role-selection-view" class="view">
            <div class="min-h-screen bg-slate-100 flex flex-col justify-center items-center p-4">
                <div class="text-4xl font-bold text-gray-800 mb-2">Match<span class="text-teal-500">AI</span></div>
                <p class="text-gray-600 mb-8">ç”¨ AI é è¦‹è¡ŒéŠ·æˆæ•ˆ</p>
                <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-slate-800">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†</h2>
                    <div class="flex flex-col space-y-4">
                        <button onclick="enterDashboard('merchant')" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 transition-colors">æˆ‘æ˜¯å•†å®¶</button>
                        <button onclick="enterDashboard('influencer')" class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition-colors">æˆ‘æ˜¯ç¶²ç´…</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="merchant-dashboard-view" class="view">
            <div class="flex h-screen bg-slate-50">
                <div id="merchant-sidebar" class="w-64 bg-white shadow-md flex-shrink-0 fixed inset-y-0 left-0 z-30 transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0">
                    <div class="p-6 text-2xl font-bold text-gray-800 border-b">Match<span class="text-teal-500">AI</span></div>
                    <nav class="mt-6">
                        <a href="#" onclick="switchTab('merchant', 'dashboard')" class="sidebar-link active block py-3 px-6 text-gray-600 font-semibold">ç¸½è¦½</a>
                        <a href="#" onclick="switchTab('merchant', 'campaigns')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">è¡ŒéŠ·æ´»å‹•</a>
                        <a href="#" onclick="switchTab('merchant', 'reports')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">æˆæ•ˆå ±å‘Š</a>
                        <a href="#" onclick="switchTab('merchant', 'finance')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">è²¡å‹™ç®¡ç†</a>
                        <a href="#" onclick="switchTab('merchant', 'settings')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">è¨­å®š</a>
                        <a href="#" onclick="handleLogout()" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold mt-10">ç™»å‡º</a>
                    </nav>
                </div>

                <div class="flex-1 flex flex-col overflow-hidden w-full">
                    <header class="flex justify-between items-center p-4 bg-white border-b flex-shrink-0">
                        <button onclick="toggleMenu('merchant')" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-800 z-40">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                                </svg>
                            </button>
                        <h1 id="merchant-header-title" class="text-2xl font-bold text-slate-800">ç¸½è¦½</h1>
                        <div class="flex items-center space-x-4">
                            <span id="user-email-display" class="text-gray-600"></span>
                            <button onclick="handleLogout()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 hidden">ç™»å‡º</button>
                        </div>
                    </header>

                    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-50 p-8">
                        <div id="merchant-dashboard-content" class="dashboard-content active">
<div id="company-card" class="bg-white p-6 rounded-xl shadow mb-6 hidden">
  <div class="flex items-start gap-4">
    <img id="company-card-logo" class="w-14 h-14 rounded-lg object-cover bg-slate-100" src="" alt="">
    <div class="flex-1">
      <div class="flex items-center gap-3">
        <h3 id="company-card-name" class="text-xl font-bold text-slate-800">å…¬å¸åç¨±</h3>
        <span id="company-card-regno" class="px-2 py-0.5 rounded text-xs bg-slate-100 text-slate-600"></span>
      </div>
      <div id="company-card-lines" class="text-sm text-gray-600 flex flex-wrap gap-x-4 mt-1">
        <span id="company-card-phone"></span>
        <span id="company-card-address"></span>
        <a id="company-card-website" class="text-teal-600 hover:underline" target="_blank" rel="noopener"></a>
      </div>
    </div>
  </div>
</div>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                <div class="bg-white p-6 rounded-xl shadow"><h3 class="text-sm font-medium text-gray-500">ç¸½èŠ±è²»</h3><p class="text-3xl font-bold text-slate-800 mt-2">NT$ 150,000</p></div>
                                <div class="bg-white p-6 rounded-xl shadow"><h3 class="text-sm font-medium text-gray-500">ç¸½æ›å…‰æ•¸</h3><p class="text-3xl font-bold text-slate-800 mt-2">1.2M</p></div>
                                <div class="bg-white p-6 rounded-xl shadow"><h3 class="text-sm font-medium text-gray-500">å¹³å‡ ROAS</h3><p class="text-3xl font-bold text-green-500 mt-2">350%</p></div>
                                <div class="bg-white p-6 rounded-xl shadow"><h3 class="text-sm font-medium text-gray-500">é€²è¡Œä¸­æ´»å‹•</h3><p class="text-3xl font-bold text-slate-800 mt-2">3</p></div>
                            </div>
                            <div class="bg-slate-700 text-white rounded-xl p-8 flex justify-between items-center"><h2 class="text-2xl font-bold">æº–å‚™å¥½ç™¼èµ·æ–°çš„è¡ŒéŠ·æ´»å‹•äº†å—ï¼Ÿ</h2><button onclick="openAIChat()" class="bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition-transform hover:scale-105">èˆ‡ AI é¡§å•é–‹å§‹</button></div>
                        </div>
                        
                        <div id="merchant-campaign-detail-content" class="dashboard-content"></div>

                        <div id="merchant-campaigns-content" class="dashboard-content">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-slate-800">æ‰€æœ‰è¡ŒéŠ·æ´»å‹•</h2>
                                <button onclick="openModal('new-campaign-modal')" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800 transition-colors flex items-center space-x-2">
                                <span>+</span>
                                <span>å»ºç«‹æ–°æ´»å‹•</span>
                            </button>                           
                            </div>
                          
                            <div id="campaigns-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            </div>
                        </div>                        

                        <div id="merchant-reports-content" class="dashboard-content">
                            <div class="bg-white rounded-xl shadow p-6"><h3 class="font-bold text-slate-800 mb-4">æ›å…‰ & é»æ“Šè¶¨å‹¢</h3><div class="h-80"><canvas id="performanceLineChart"></canvas></div></div>
                        </div>
                        
                        <div id="merchant-finance-content" class="dashboard-content">
                             <div class="bg-white rounded-xl shadow p-6 mb-6"><h3 class="text-lg font-medium text-gray-500">å¸³æˆ¶é¤˜é¡</h3><p class="text-4xl font-bold text-slate-800 mt-2">NT$ 88,500</p></div>
                             <div class="bg-white rounded-xl shadow p-8"><h2 class="text-xl font-bold text-slate-800 mb-4">ç·šä¸Šå„²å€¼ (å…¥é‡‘)</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><button class="border-2 border-teal-500 text-teal-500 font-bold p-4 rounded-lg">ä¿¡ç”¨å¡</button><button class="border border-gray-300 p-4 rounded-lg">éŠ€è¡Œè½‰å¸³</button><button class="border border-gray-300 p-4 rounded-lg">é›»å­æ”¯ä»˜</button></div><div class="space-y-4"><div><label class="text-sm font-medium">å„²å€¼é‡‘é¡</label><input type="number" placeholder="NT$ 10,000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div><button class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800">ç¢ºèªå„²å€¼</button></div></div>
                        </div>

                        <div id="merchant-settings-content" class="dashboard-content">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- è¡¨å–® -->
    <div class="bg-white rounded-xl shadow p-8 lg:col-span-2">
      <h2 class="text-xl font-bold text-slate-800 mb-6">å…¬å¸è¨­å®š</h2>
      <form id="company-form" class="space-y-5" onsubmit="return false;">
        <div>
          <label class="block text-sm font-medium text-gray-700">å…¬å¸åç¨±</label>
          <input id="company-name" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="ä¾‹ï¼šMatchAI Inc.">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">çµ±ä¸€ç·¨è™Ÿ</label>
            <input id="company-regno" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="ä¾‹ï¼š12345678">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">è¯çµ¡é›»è©±</label>
            <input id="company-phone" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="ä¾‹ï¼š02-1234-5678">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">å…¬å¸åœ°å€</label>
          <input id="company-address" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="ä¾‹ï¼šå°åŒ—å¸‚å¤§å®‰å€â€¦">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">å…¬å¸å®˜ç¶²</label>
          <input id="company-website" type="url" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="https://example.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Logo åœ–ç‰‡ URL</label>
          <input id="company-logo" type="url" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="https://â€¦/logo.png">
          <p class="text-xs text-gray-500 mt-1">ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä¸Šå‚³æª”æ¡ˆï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå®Œæˆå¾Œæœƒè‡ªå‹•å¡«å…¥é€™å€‹æ¬„ä½ã€‚</p>
        </div>
        <div class="mt-3">
          <label class="block text-sm font-medium text-gray-700">æˆ–ä¸Šå‚³ Logo æª”æ¡ˆ</label>
          <input id="company-logo-file" type="file" accept="image/*" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
          <div class="flex items-center gap-3 mt-2">
            <button id="upload-logo-btn" class="bg-teal-600 text-white font-semibold py-1.5 px-3 rounded hover:bg-teal-700" onclick="uploadCompanyLogo()">ä¸Šå‚³ Logo</button>
            <progress id="logo-upload-progress" value="0" max="100" class="w-40"></progress>
            <span id="logo-upload-status" class="text-xs text-gray-600"></span>
          </div>
          <p class="text-xs text-gray-500 mt-1">ä¸Šå‚³å®Œæˆå¾Œï¼Œæœƒè‡ªå‹•æŠŠä¸‹è¼‰é€£çµå¡«å…¥ä¸Šé¢çš„ã€ŒLogo åœ–ç‰‡ URLã€ã€‚</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">å…¬å¸æè¿°</label>
          <textarea id="company-desc" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="ç°¡è¿°ä½ çš„å“ç‰Œèˆ‡ç”¢å“â€¦"></textarea>
        </div>
        <div class="flex gap-3 pt-2">
          <button id="company-save-btn" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800" onclick="handleSaveCompany()">å„²å­˜</button>
          <button class="bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200" onclick="resetCompanyForm()">é‡è¨­</button>
          <span id="company-save-hint" class="text-sm text-gray-500 self-center hidden">å·²å„²å­˜ï¼</span>
        </div>
      </form>
    </div>

    <!-- é è¦½ -->
    <div class="bg-white rounded-xl shadow p-8">
      <h3 class="font-bold text-slate-800 mb-4">å³æ™‚é è¦½</h3>
      <div id="company-preview" class="border rounded-lg p-4 flex items-start gap-4">
        <img id="company-preview-logo" class="w-16 h-16 rounded-lg object-cover bg-slate-100" src="" alt="">
        <div>
          <div id="company-preview-name" class="text-lg font-bold text-slate-800">ï¼ˆå°šæœªè¨­å®šï¼‰</div>
          <div id="company-preview-lines" class="text-sm text-gray-600 space-y-0.5">
            <div id="preview-line-phone"></div>
            <div id="preview-line-address"></div>
            <a id="preview-line-website" class="text-teal-600 hover:underline" target="_blank" rel="noopener"></a>
          </div>
          <p id="company-preview-desc" class="text-sm text-gray-600 mt-2"></p>
        </div>
      </div>
    </div>
  </div>
</div></div>
                    </main>
                </div>
            </div>
         <div id="merchant-sidebar-overlay" onclick="toggleMenu('merchant')" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        </div>

        
        <div id="influencer-dashboard-view" class="view">
             <div class="flex h-screen bg-slate-50">
                <div id="influencer-sidebar" class="w-64 bg-white shadow-md flex-shrink-0 fixed inset-y-0 left-0 z-30 transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0">
                    <div class="p-6 text-2xl font-bold text-gray-800 border-b">Match<span class="text-teal-500">AI</span></div>
                    <nav class="mt-6">
                        <a href="#" onclick="switchTab('influencer', 'dashboard')" class="sidebar-link active block py-3 px-6 text-gray-600 font-semibold">ç¸½è¦½</a>
                        <a href="#" onclick="switchTab('influencer', 'value')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">æˆ‘çš„åƒ¹å€¼</a>
                        <a href="#" onclick="switchTab('influencer', 'invitations')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">åˆä½œé‚€è«‹</a>
                        <a href="#" onclick="switchTab('influencer', 'finance')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">è²¡å‹™ç®¡ç†</a>
                        <a href="#" onclick="switchTab('influencer', 'settings')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">è¨­å®š</a>
                        <a href="#" onclick="handleLogout()" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold mt-10">ç™»å‡º</a>
                    </nav>
                </div>

                
                <div class="flex-1 flex flex-col overflow-hidden w-full">
                    
                    <header class="flex justify-between items-center p-4 bg-white border-b flex-shrink-0">
                        <button onclick="toggleMenu('influencer')" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-800 z-40">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                             </svg>
                         </button>

                        <h1 id="influencer-header-title" class="text-2xl font-bold text-slate-800">ç¸½è¦½</h1>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-600"></span>
                            <button onclick="handleLogout()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 hidden">ç™»å‡º</button>
                        </div>
                    </header>

                    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-50 p-8">
                        <div id="influencer-dashboard-content" class="dashboard-content active"><div class="h-80"><canvas id="valueRadarChart"></canvas></div></div>
                        <div id="influencer-value-content" class="dashboard-content"><div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-bold text-slate-800 mb-4">é»æ“Šç¤¾ç¾¤å¹³å°æŸ¥çœ‹è©³ç´°åˆ†æå ±å‘Š</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div onclick="showPlatformDetail('instagram')" class="p-4 border rounded-lg flex items-center space-x-4 cursor-pointer hover:bg-slate-50"><img src="https://placehold.co/48x48/E1306C/FFFFFF?text=IG" class="rounded-full" /><div><p class="font-bold">hsi_daily</p><p class="text-sm text-gray-500">Instagram</p></div></div><div onclick="showPlatformDetail('youtube')" class="p-4 border rounded-lg flex items-center space-x-4 cursor-pointer hover:bg-slate-50"><img src="https://placehold.co/48x48/FF0000/FFFFFF?text=YT" class="rounded-full" /><div><p class="font-bold">å°å¸Œçš„æ¢ç´¢é »é“</p><p class="text-sm text-gray-500">YouTube</p></div></div><div class="p-4 border border-dashed rounded-lg flex items-center space-x-4 text-gray-400"><img src="https://placehold.co/48x48/000000/FFFFFF?text=TK" class="rounded-full" /><div><p class="font-bold">é€£çµ TikTok</p><p class="text-sm">å°šæœªé€£çµ</p></div></div></div></div></div>
                        <div id="influencer-invitations-content" class="dashboard-content"><div class="space-y-6"><div class="bg-white rounded-xl shadow p-6"><div class="flex flex-col md:flex-row justify-between"><div><p class="font-bold text-sm text-teal-600">A å…¬å¸</p><h3 class="font-bold text-xl mt-1 text-slate-800">è¯åç„¡ç·šè€³æ©Ÿé ç†±</h3><p class="text-sm text-gray-500 mt-2">å…§å®¹å½¢å¼: 1 å‰‡ Instagram åœ–æ–‡ + 3 å‰‡é™æ™‚å‹•æ…‹</p></div><div class="mt-4 md:mt-0 text-left md:text-right"><p class="font-bold text-xl text-slate-800">NT$ 8,000 - 12,000</p><p class="text-sm text-gray-500">é ç®—ç¯„åœ</p></div></div><div class="mt-4 pt-4 border-t flex flex-col md:flex-row items-center justify-between"><p class="text-sm text-gray-500">æˆªæ­¢æ—¥æœŸ: 2025-10-15</p><div class="flex space-x-2 mt-3 md:mt-0"><button class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">å©‰æ‹’</button><button class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800">æŸ¥çœ‹è©³æƒ…ä¸¦æ¥å—</button></div></div></div></div></div>
                        <div id="influencer-finance-content" class="dashboard-content"><div class="bg-white rounded-xl shadow p-6 mb-6"><h3 class="text-lg font-medium text-gray-500">å¯æé ˜é‡‘é¡</h3><p class="text-4xl font-bold text-green-500 mt-2">NT$ 25,600</p></div><div class="bg-white rounded-xl shadow p-8"><h2 class="text-xl font-bold text-slate-800 mb-4">ç”³è«‹æé ˜ (å‡ºé‡‘)</h2><div class="space-y-4"><div><label class="text-sm font-medium">æé ˜éŠ€è¡Œ</label><select class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><option>ä¸­åœ‹ä¿¡è¨— (822)</option><option>åœ‹æ³°ä¸–è¯ (013)</option></select></div><div><label class="text-sm font-medium">éŠ€è¡Œå¸³è™Ÿ</label><input type="text" value="1234-5678-9012-3456" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div><div><label class="text-sm font-medium">æé ˜é‡‘é¡</label><input type="number" placeholder="æœ€é«˜å¯æé ˜ NT$ 25,600" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div><button class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600">ç¢ºèªæé ˜</button></div></div></div>
                        <div id="influencer-settings-content" class="dashboard-content"><div class="bg-white rounded-xl shadow p-8 max-w-2xl mx-auto"><h2 class="text-xl font-bold text-slate-800">å€‹äººè¨­å®š</h2></div></div>
                    </main>
                </div>
            </div>
        <div id="influencer-sidebar-overlay" onclick="toggleMenu('influencer')" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        </div>

        <div id="new-campaign-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col h-[90vh] transform scale-95 transition-transform duration-300">
                <div class="p-5 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800">å»ºç«‹æ–°çš„è¡ŒéŠ·éœ€æ±‚</h2>
                    <button onclick="closeModal('new-campaign-modal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>

                <form id="campaign-form">
                    <div class="flex-1 p-6 overflow-y-auto space-y-6">
                        <div>
                            <label for="brief-product-name" class="block text-sm font-medium text-gray-700">ç”¢å“åç¨±</label>
                            <input type="text" id="brief-product-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„é…·ç‚«ç„¡ç·šè€³æ©Ÿ">
                        </div>
                        <div>
                            <label for="brief-product-desc" class="block text-sm font-medium text-gray-700">ç”¢å“æè¿°èˆ‡ç‰¹è‰²</label>
                            <textarea id="brief-product-desc" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="æè¿°æ‚¨çš„ç”¢å“ï¼Œä»¥åŠå¸Œæœ›ç¶²ç´…å¼·èª¿çš„è³£é»"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="brief-impressions" class="block text-sm font-medium text-gray-700">é æœŸæ›å…‰æ¬¡æ•¸</label>
                                <input type="number" id="brief-impressions" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="ä¾‹å¦‚ï¼š100000">
                            </div>
                            <div>
                                <label for="brief-budget" class="block text-sm font-medium text-gray-700">é ç®—ç¯„åœ (NT$)</label>
                                <input type="number" id="brief-budget" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="ä¾‹å¦‚ï¼š50000">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="brief-influencer-count" class="block text-sm font-medium text-gray-700">å¸Œæœ›ç¶²ç´…æ•¸é‡</label>
                                <input type="number" id="brief-influencer-count" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="ä¾‹å¦‚ï¼š10">
                            </div>
                            <div>
                                <label for="brief-follower-range" class="block text-sm font-medium text-gray-700">ç¶²ç´…ç²‰çµ²æ•¸å€é–“</label>
                                <select id="brief-follower-range" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <option>ä¸é™</option>
                                    <option>1è¬ - 5è¬</option>
                                    <option>5è¬ - 10è¬</option>
                                    <option>10è¬ä»¥ä¸Š</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å¸Œæœ›ç™¼å¸ƒå¹³å°</label>
                            <div id="brief-platforms" class="mt-2 flex flex-wrap gap-4">
                                <label class="inline-flex items-center"><input type="checkbox" value="Instagram" class="rounded border-gray-300"> <span class="ml-2">Instagram</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" value="YouTube" class="rounded border-gray-300"> <span class="ml-2">YouTube</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" value="Facebook" class="rounded border-gray-300"> <span class="ml-2">Facebook</span></label>
                                        <label class="inline-flex items-center"><input type="checkbox" value="TikTok" class="rounded border-gray-300"> <span class="ml-2">TikTok</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" value="XiaoHongShu" class="rounded border-gray-300"> <span class="ml-2">å°ç´…æ›¸</span></label>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="p-5 border-t bg-slate-50">
                    <button onclick="handleSaveBrief()" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 transition-colors">å„²å­˜éœ€æ±‚ä¸¦é–‹å§‹é…å°</button>
                </div>
            </div>
        </div>

        <div id="ai-chat-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col h-[70vh] transform scale-95 transition-transform duration-300"><div class="p-4 border-b flex justify-between items-center"><h2 class="text-lg font-bold text-slate-800">AI è¡ŒéŠ·é¡§å•</h2><button onclick="closeAIChat()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4"></div><div class="p-4 border-t"><div class="flex space-x-2"><input id="chat-input" type="text" class="flex-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="è«‹è¼¸å…¥æ‚¨çš„å›è¦†..."><button onclick="sendChatMessage()" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800">ç™¼é€</button></div></div></div></div>
        <div id="platform-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0"><div id="platform-detail-content" class="bg-slate-50 rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col transform scale-95 transition-transform duration-300"></div></div>
    </div>

    <script type="module">import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js';

    // --- 1. Firebase åˆå§‹åŒ– (é€™éƒ¨åˆ†ä¸è®Š) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            GoogleAuthProvider, 
            signInWithRedirect, 
            getRedirectResult,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    // === ä¿®æ”¹éƒ¨åˆ† STARTï¼šå¾ Firestore åŒ¯å…¥æ›´å¤šæˆ‘å€‘éœ€è¦çš„åŠŸèƒ½ ===
        import { 
            getFirestore, 
            collection, 
            addDoc,
            query,
            where,
            getDocs,
            doc,
            getDoc,
            setDoc,
            updateDoc,       // æ–°å¢ï¼šç”¨æ–¼æ›´æ–°æ–‡ä»¶ (ä¾‹å¦‚ï¼šè»Ÿåˆªé™¤)
            onSnapshot,      // æ–°å¢ï¼šç”¨æ–¼å³æ™‚ç›£è½è³‡æ–™è®ŠåŒ–
            orderBy,       // æ–°å¢ï¼šç”¨æ–¼æ’åºæŸ¥è©¢çµæœ
            serverTimestamp,   // â¬…ï¸ æ–°å¢
            limit
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    // === ä¿®æ”¹éƒ¨åˆ† END ===

        const firebaseConfig = {
          apiKey: "AIzaSyCtOwoKYJfrSshSfkipfMH9lTngRsfQLDc",
          authDomain: "test-b493a.firebaseapp.com",
          projectId: "test-b493a",
          storageBucket: "test-b493a.firebasestorage.app",
          messagingSenderId: "1089014108157",
          appId: "1:1089014108157:web:2ac36c728f861795909394",
          measurementId: "G-1GY922PWL9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        getRedirectResult(auth)
            .then((result) => {
                if (result) {
                    console.log('Google é‡æ–°å°å‘ç™»å…¥æˆåŠŸ:', result.user);
                }
            }).catch((error) => {
                console.error('Google é‡æ–°å°å‘å¤±æ•—:', error);
                alert('Google ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            });

    // --- 2. æ ¸å¿ƒ UI å°èˆªèˆ‡æ§åˆ¶å‡½å¼ ---
        function navigateTo(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            }
            window.scrollTo(0, 0);
        }

        const headerTitles = {
            merchant: { dashboard: 'ç¸½è¦½', campaigns: 'è¡ŒéŠ·æ´»å‹•', reports: 'æˆæ•ˆå ±å‘Š', finance: 'è²¡å‹™ç®¡ç†', settings: 'è¨­å®š' },
            influencer: { dashboard: 'ç¸½è¦½', value: 'æˆ‘çš„åƒ¹å€¼', invitations: 'åˆä½œé‚€è«‹', finance: 'è²¡å‹™ç®¡ç†', settings: 'è¨­å®š' }
        };
    
    // === ä¿®æ”¹éƒ¨åˆ† STARTï¼šä¿®æ”¹ switchTab ä»¥æ”¯æ´è©³æƒ…é  ===
        function switchTab(role, tabId) {
            const sidebarLinks = document.querySelectorAll(`#${role}-dashboard-view .sidebar-link`);
            const contents = document.querySelectorAll(`#${role}-dashboard-view .dashboard-content`);
            const headerTitle = document.getElementById(`${role}-header-title`);
        
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
            // å¦‚æœæ˜¯è©³æƒ…é ï¼Œå‰‡è®“ 'campaigns' ä¿æŒ active
                const linkTab = tabId === 'campaign-detail' ? 'campaigns' : tabId;
                if (link.getAttribute('onclick').includes(`'${linkTab}'`)) {
                    link.classList.add('active');
                }
            });

            contents.forEach(content => content.classList.remove('active'));
            const activeContent = document.getElementById(`${role}-${tabId}-content`);
            if (activeContent) activeContent.classList.add('active');
        
        // åªæœ‰åœ¨ headerTitles ä¸­æœ‰å®šç¾©æ™‚æ‰æ›´æ–°æ¨™é¡Œï¼Œé¿å…è¦†è“‹è©³æƒ…é çš„è‡ªè¨‚æ¨™é¡Œ
            if (headerTitles[role][tabId]) {
                headerTitle.textContent = headerTitles[role][tabId];
            }
        }
    // === ä¿®æ”¹éƒ¨åˆ† END ===

    // --- 3. å°‡å‡½å¼æ›è¼‰åˆ° windowï¼Œè®“ HTML å¯ä»¥å‘¼å« ---
        window.navigateTo = navigateTo;
        window.switchTab = switchTab;
    
        window.toggleMenu = function(role) {
            const sidebar = document.getElementById(`${role}-sidebar`);
            const overlay = document.getElementById(`${role}-sidebar-overlay`);
            if (sidebar && overlay) {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }
        }

        window.openModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('div > div').classList.remove('scale-95');
                }, 10);
            }
        }
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.add('opacity-0');
                modal.querySelector('div > div').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }


// ========== Gemini Chatï¼ˆFirestore æ“´å……ç¨‹å¼ï¼‰æ•´åˆ ==========

// è®“èŠå¤©å¿«å–ç›®å‰çš„ç›£è½å™¨ï¼Œé—œé–‰è¦–çª—æ™‚å–æ¶ˆç›£è½
let chatUnsub = null;

// å°‡ä¸€å‰‡è¨Šæ¯æ¸²æŸ“åˆ°è¦–çª—
function appendChatBubble(text, role = 'bot') {
  const $chat = document.getElementById('chat-window');
  if (!$chat) return;
  const wrap = document.createElement('div');
  wrap.className = role === 'me'
    ? 'bg-slate-700 text-white rounded-xl px-4 py-3 max-w-[80%] ml-auto'
    : 'bg-slate-100 text-slate-800 rounded-xl px-4 py-3 max-w-[80%]';
  wrap.textContent = text;
  const row = document.createElement('div');
  row.className = 'w-full flex ' + (role === 'me' ? 'justify-end' : 'justify-start');
  row.appendChild(wrap);
  $chat.appendChild(row);
  $chat.scrollTop = $chat.scrollHeight;
}

// æ¸…ç©ºè¦–çª—
function resetChatWindow() {
  const $chat = document.getElementById('chat-window');
  if ($chat) $chat.innerHTML = '';
}

// å•Ÿå‹•ç›£è½ï¼šä¾ createTime ç”±å°åˆ°å¤§é¡¯ç¤ºæœ€æ–° 100 å‰‡
function startChatListener(uid) {
  if (chatUnsub) chatUnsub(); // å…ˆé—œèˆŠç›£è½ï¼Œé¿å…é‡è¤‡

  const msgsRef = collection(db, 'users', uid, 'messages');
  // âœ… ç”¨ createTimeMs æ’åºï¼Œç«‹å³ç©©å®š
  const q = query(msgsRef, orderBy('createTimeMs', 'asc'), limit(100));

  chatUnsub = onSnapshot(q, (snap) => {
    // âœ… å…¨é‡é‡ç¹ªï¼Œæ°¸é æœƒåƒåˆ° modified å¾Œçš„ response
    const $chat = document.getElementById('chat-window');
    if (!$chat) return;
    $chat.innerHTML = '';

    snap.docs.forEach(docSnap => {
      const d = docSnap.data();
      if (d.prompt) appendChatBubble(d.prompt, 'me');
      if (d.response) appendChatBubble(d.response, 'bot');
      else if (d.status) appendChatBubble(`ï¼ˆç‹€æ…‹ï¼š${d.status}ï¼‰`, 'bot');
    });

    $chat.scrollTop = $chat.scrollHeight;
  }, (err) => {
    console.error('èŠå¤©ç›£è½å¤±æ•—ï¼š', err);
    appendChatBubble('ç³»çµ±ï¼šç›£è½è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚', 'bot');
  });
}




// === çµ¦ HTML å‘¼å«çš„ 3 å€‹å‡½å¼ ===
window.openAIChat = function openAIChat() {
  const user = auth.currentUser;
  if (!user) {
    alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨ AI é¡§å•');
    return;
  }
  // æ‰“é–‹ modalï¼ˆæ²¿ç”¨ä½ ç¾æœ‰çš„é–‹é—œå‹•ç•«é‚è¼¯ï¼‰
  const modal = document.getElementById('ai-chat-modal');
  modal.classList.remove('hidden');
  setTimeout(() => {
    modal.classList.remove('opacity-0');
    modal.querySelector('div > div').classList.remove('scale-95');
  }, 10);

  resetChatWindow();
  appendChatBubble('ğŸ‘‹ æˆ‘æ˜¯ä½ çš„ AI è¡ŒéŠ·é¡§å•ï¼Œè¼¸å…¥ä½ çš„éœ€æ±‚å§ï¼', 'bot');

  // é–‹å§‹ç›£è½ Firestore è¨Šæ¯
  startChatListener(user.uid);
};

window.closeAIChat = function closeAIChat() {
  // é—œé–‰ç›£è½
  if (chatUnsub) { chatUnsub(); chatUnsub = null; }

  // é—œé–‰ modalï¼ˆæ²¿ç”¨ä½ ç¾æœ‰çš„å‹•ç•«ï¼‰
  const modal = document.getElementById('ai-chat-modal');
  modal.classList.add('opacity-0');
  modal.querySelector('div > div').classList.add('scale-95');
  setTimeout(() => { modal.classList.add('hidden'); }, 300);
};

window.sendChatMessage = async function sendChatMessage() {
  const user = auth.currentUser;
  if (!user) return alert('è«‹å…ˆç™»å…¥');

  const $input = document.getElementById('chat-input');
  const text = ($input.value || '').trim();
  if (!text) return;

  // ç«‹åˆ»åœ¨å‰ç«¯å…ˆé¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯ï¼ˆå¥½æœ‰å³æ™‚æ„Ÿï¼‰
  appendChatBubble(text, 'me');

  try {
    const msgsRef = collection(db, 'users', user.uid, 'messages');
    await addDoc(msgsRef, {
      prompt: text,              // æ“´å……ç¨‹å¼è®€é€™å€‹æ¬„ä½
      createTime: serverTimestamp(),
      createTimeMs: Date.now() 
      // ä½ ä¹Ÿå¯åœ¨é€™è£¡å˜—è©¦æ“´å……ç¨‹å¼æ”¯æ´çš„åƒæ•¸ï¼ˆè‹¥ç‰ˆæœ¬æ”¯æ´ï¼‰ï¼š
      // temperature: 0.4, topP: 0.95, topK: 32,
    });
    // æ“´å……ç¨‹å¼æœƒåœ¨èƒŒæ™¯å‘¼å« Geminiï¼Œå¹¾ç§’å¾ŒæŠŠ response å¯«å›åŒç­†æ–‡ä»¶
  } catch (err) {
    console.error('é€å‡ºå¤±æ•—ï¼š', err);
    appendChatBubble('ï¼ˆé€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ï¼‰', 'bot');
  } finally {
    $input.value = '';
    $input.focus();
  }
};








    // === æ–°å¢éƒ¨åˆ† START: é€™è£¡æ˜¯æ‰€æœ‰æ–°å¢åŠ ç”¨ä¾†é¡¯ç¤ºã€åˆªé™¤ã€æŸ¥çœ‹æ´»å‹•çš„åŠŸèƒ½ ===

    // åŠŸèƒ½ 1: æ ¹æ“šå‚³å…¥çš„æ´»å‹•è³‡æ–™ï¼Œç”¢ç”Ÿ HTML å¡ç‰‡
        function renderCampaigns(campaigns) {
            const listElement = document.getElementById('campaigns-list');
            if (!listElement) return;

            if (campaigns.length === 0) {
                listElement.innerHTML = `<p class="col-span-full text-center text-gray-500">ç›®å‰æ²’æœ‰ä»»ä½•è¡ŒéŠ·æ´»å‹•ï¼Œé»æ“Šå³ä¸Šè§’å»ºç«‹ä¸€å€‹å§ï¼</p>`;
                return;
            }

            let campaignsHTML = '';
            campaigns.forEach(campaign => {
                const data = campaign.data;
                const id = campaign.id;

                let statusBadge = '';
                switch (data.status) {
                    case 'pending_match':
                        statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">æ­£åœ¨é…å°ä¸­</span>`;
                        break;
                    case 'matched':
                        statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">é…å°å®Œæˆ</span>`;
                        break;
                    case 'in_progress':
                        statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">åŸ·è¡Œä¸­</span>`;
                        break;
                    default:
                        statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">æœªçŸ¥</span>`;
                }
            
                let deleteButtonHTML = '';
                if (data.status === 'pending_match') {
                    deleteButtonHTML = `<button onclick="handleDeleteCampaign('${id}')" class="w-1/2 text-center bg-red-50 py-2 rounded-lg font-semibold text-red-600 hover:bg-red-100">åˆªé™¤</button>`;
                }

                campaignsHTML += `
                    <div class="bg-white rounded-xl shadow p-6 flex flex-col justify-between">
                        <div>
                            ${statusBadge}
                            <h3 class="font-bold text-lg mt-2 text-slate-800">${data.productName}</h3>
                            <p class="text-sm text-gray-500 mt-1">é ç®—: NT$ ${data.budget.toLocaleString()}</p>
                            <p class="text-sm text-gray-500 mt-1">å¸Œæœ›ç¶²ç´…æ•¸: ${data.influencerCount} ä½</p>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button onclick="showCampaignDetail('${id}')" class="w-full text-center bg-gray-100 py-2 rounded-lg font-semibold text-gray-700 hover:bg-gray-200">æŸ¥çœ‹è©³æƒ…</button>
                            ${deleteButtonHTML}
                        </div>
                    </div>
                `;
            });
            listElement.innerHTML = campaignsHTML;
        }

    // åŠŸèƒ½ 2: å»ºç«‹ä¸€å€‹å³æ™‚ç›£è½å™¨ï¼Œç•¶è³‡æ–™åº«æœ‰è®ŠåŒ–æ™‚è‡ªå‹•æ›´æ–°ç•«é¢
        let unsubscribeCampaigns = null; 
        function listenForCampaigns() {
            const user = auth.currentUser;
            if (!user) return;
            if (unsubscribeCampaigns) unsubscribeCampaigns();

            const briefsRef = collection(db, "briefs");
            const q = query(briefsRef, 
                where("merchantId", "==", user.uid),// åªæŸ¥è©¢å±¬æ–¼ç•¶å‰å•†å®¶çš„
                where("isDeleted", "==", false), // åªæŸ¥è©¢æœªè¢«è»Ÿåˆªé™¤çš„
                orderBy("createdAt", "desc") // æŒ‰ç…§å»ºç«‹æ™‚é–“å€’åºæ’åˆ—
            );

            unsubscribeCampaigns = onSnapshot(q, (querySnapshot) => {
                const campaigns = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderCampaigns(campaigns);// å°‡ç²å–çš„è³‡æ–™å‚³éçµ¦æ¸²æŸ“å‡½å¼
            }, (error) => {
                console.error("ç›£è½æ´»å‹•å¤±æ•—: ", error);
                 // å¯ä»¥åœ¨æ­¤è™•åŠ å…¥éŒ¯èª¤æç¤º UI
            });
        }

    // åŠŸèƒ½ 3: è™•ç†åˆªé™¤æ´»å‹•çš„é‚è¼¯ (è»Ÿåˆªé™¤)
        window.handleDeleteCampaign = async function(campaignId) {
            if (!campaignId || !confirm("æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡ŒéŠ·æ´»å‹•å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) return;
            try {
                const campaignDocRef = doc(db, "briefs", campaignId);
                await updateDoc(campaignDocRef, { isDeleted: true });
                alert("æ´»å‹•å·²åˆªé™¤ã€‚");
            } catch (error) {
                console.error("åˆªé™¤æ´»å‹•å¤±æ•—: ", error);
                alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
       }

    // åŠŸèƒ½ 4: è™•ç†é¡¯ç¤ºæ´»å‹•è©³æƒ…çš„é‚è¼¯
        window.showCampaignDetail = async function(campaignId) {
            if (!campaignId) return;
            try {
                const docSnap = await getDoc(doc(db, "briefs", campaignId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const contentArea = document.getElementById('merchant-campaign-detail-content');
                    contentArea.innerHTML = `
                        <div class="bg-white rounded-xl shadow p-6 mb-6">
                            <h2 class="text-xl font-bold text-slate-800">${data.productName}</h2>
                            <p class="text-gray-600 mt-2">${data.productDesc}</p>
                            <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 border-t pt-4">
                                <div><p class="text-sm text-gray-500">ç‹€æ…‹</p><p class="font-bold">${data.status}</p></div>
                                <div><p class="text-sm text-gray-500">é ç®—</p><p class="font-bold">NT$ ${data.budget.toLocaleString()}</p></div>
                                <div><p class="text-sm text-gray-500">é æœŸæ›å…‰</p><p class="font-bold">${data.impressions.toLocaleString()}</p></div>
                                <div><p class="text-sm text-gray-500">å¸Œæœ›ç¶²ç´…æ•¸</p><p class="font-bold">${data.influencerCount}</p></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow">
                            <h3 class="p-6 font-bold text-slate-800 border-b">åˆä½œç¶²ç´…åˆ—è¡¨ (é–‹ç™¼ä¸­)</h3>
                            <div class="p-6 text-center text-gray-500">é…å°å®Œæˆå¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºåˆä½œçš„ç¶²ç´…åå–®èˆ‡æˆæ•ˆã€‚</div>
                        </div>
                    `;
                    switchTab('merchant', 'campaign-detail');
                    document.getElementById('merchant-header-title').textContent = `æ´»å‹•è©³æƒ…: ${data.productName}`;
                } else {
                    alert("ç„¡æ³•è¼‰å…¥æ´»å‹•è©³æƒ…ã€‚");
                }
            } catch (error) {
                console.error("è®€å–è©³æƒ…å¤±æ•—: ", error);
                alert("è®€å–è©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
            }
        }
    // === æ–°å¢éƒ¨åˆ† END ===

    // === ä¿®æ”¹éƒ¨åˆ† START: ä¿®æ”¹ handleSaveBrief ä»¥ç¬¦åˆæ–°æ¶æ§‹ ===
        window.handleSaveBrief = async function() {
            const user = auth.currentUser;
            if (!user) return alert('è«‹å…ˆç™»å…¥ï¼');

            const briefData = {
                productName: document.getElementById('brief-product-name').value,
                productDesc: document.getElementById('brief-product-desc').value,
                impressions: parseInt(document.getElementById('brief-impressions').value) || 0,
                budget: parseInt(document.getElementById('brief-budget').value) || 0,
                influencerCount: parseInt(document.getElementById('brief-influencer-count').value) || 0,
                followerRange: document.getElementById('brief-follower-range').value,
               platforms: Array.from(document.querySelectorAll('#brief-platforms input:checked')).map(el => el.value),
                status: 'pending_match',
                isDeleted: false, // æ–°å¢ï¼šè»Ÿåˆªé™¤æ¨™è¨˜
                merchantId: user.uid,
                merchantEmail: user.email,
                createdAt: new Date()
            };

            if (!briefData.productName) return alert('è«‹è‡³å°‘å¡«å¯«ç”¢å“åç¨±ï¼');

            try {
                await addDoc(collection(db, "briefs"), briefData);
                alert('æ‚¨çš„éœ€æ±‚å·²æˆåŠŸé€å‡ºï¼');
                closeModal('new-campaign-modal');
            // æ¸…ç©ºè¡¨å–®ï¼Œæ³¨æ„: é€™éœ€è¦ä½ åœ¨ HTML ä¸­ç”¨ <form> æ¨™ç±¤åŒ…ä½ modal çš„å…§å®¹
                document.getElementById('campaign-form').reset();
            } catch (error) {
                console.error("å„²å­˜éœ€æ±‚å–®å¤±æ•—:", error);
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console çš„éŒ¯èª¤è¨Šæ¯ã€‚');
            }
        }
    // === ä¿®æ”¹éƒ¨åˆ† END ===

    // --- 4. Firebase é©—è­‰åŠŸèƒ½ (é€™éƒ¨åˆ†ä¸è®Š) ---
        window.handleRegister = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert('è¨»å†ŠæˆåŠŸï¼ç¾åœ¨æ‚¨å¯ä»¥ç™»å…¥äº†ã€‚');
            } catch (error) {
                alert('è¨»å†Šå¤±æ•—ï¼š' + error.message);
            }
        };

        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
            }
        };

        window.handleLogout = async function() {
            try {
            await signOut(auth);
            } catch (error) {
                alert('ç™»å‡ºå¤±æ•—ï¼š' + error.message);
            }
        };

        window.handleGoogleLogin = async function() {
            const provider = new GoogleAuthProvider();
            try {
                // ç›´æ¥ä½¿ç”¨æˆ‘å€‘åœ¨é ‚éƒ¨åŒ¯å…¥çš„ signInWithPopup
                const result = await signInWithPopup(auth, provider);
                console.log("Google å½ˆå‡ºè¦–çª—ç™»å…¥æˆåŠŸ:", result.user);
            } catch (error) {
                console.error("Google ç™»å…¥å¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯:", error);
                alert("Google ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤: " + error.message);
            }
        };

        window.enterDashboard = function(role) {
            const user = auth.currentUser;
            if (!user) {
                alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥ï¼');
                navigateTo('login-view');
                return;
            }

            if (role === 'merchant') {
                navigateTo('merchant-dashboard-view');
                document.getElementById('user-email-display').textContent = `ä½ å¥½, ${user.email}`;
                document.querySelector('#merchant-dashboard-view header button').classList.remove('hidden');
                switchTab('merchant', 'dashboard');
            } else if (role === 'influencer') {
                navigateTo('influencer-dashboard-view');
                document.querySelector('#influencer-dashboard-view header .text-gray-600').textContent = `ä½ å¥½, ${user.displayName || user.email}`;
                document.querySelector('#influencer-dashboard-view header button').classList.remove('hidden');
                switchTab('influencer', 'dashboard');
            }
        };


    // === ä¿®æ”¹éƒ¨åˆ† STARTï¼šä¿®æ”¹ onAuthStateChanged ä»¥å•Ÿå‹•å’Œåœæ­¢ç›£è½å™¨ ===
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œé–‹å§‹ç›£è½æ´»å‹•...');
            // ç•¶ç”¨æˆ¶ç™»å…¥å¾Œï¼Œç«‹åˆ»é–‹å§‹ç›£è½ä»–/å¥¹çš„æ´»å‹•è³‡æ–™
                listenForCampaigns();
                navigateTo('role-selection-view');
            } else {
                console.log('ä½¿ç”¨è€…å·²ç™»å‡ºï¼Œåœæ­¢ç›£è½ã€‚');
            // ç•¶ç”¨æˆ¶ç™»å‡ºå¾Œï¼Œå–æ¶ˆç›£è½ï¼Œé¿å…ä¸å¿…è¦çš„è®€å–å’Œæ½›åœ¨çš„éŒ¯èª¤
                if (unsubscribeCampaigns) {
                    unsubscribeCampaigns();
                }
                navigateTo('login-view');
            }
        });
    // === ä¿®æ”¹éƒ¨åˆ† END ===
    

// === å…¬å¸è¨­å®šï¼šFirestore æ–‡ä»¶ä½ç½® ===
const companyDocRef = (uid) => doc(db, 'users', uid, 'company', 'profile');

// === Firebase Storage åˆå§‹åŒ– ===
const storage = getStorage(app);

// === å…¬å¸å¡ç‰‡æ¸²æŸ“ ===
function renderCompanyCard(data) {
  const card = document.getElementById('company-card');
  if (!card) return;
  if (!data) { card.classList.add('hidden'); return; }
  const S = (id) => document.getElementById(id);
  const { name, regNo, phone, address, website, logoUrl } = data;
  if (S('company-card-logo')) S('company-card-logo').src = logoUrl || '';
  if (S('company-card-name')) S('company-card-name').textContent = name || '(æœªå‘½åå…¬å¸)';
  if (S('company-card-regno')) S('company-card-regno').textContent = regNo ? `çµ±ç·¨ï¼š${regNo}` : '';
  if (S('company-card-phone')) S('company-card-phone').textContent = phone || '';
  if (S('company-card-address')) S('company-card-address').textContent = address || '';
  if (S('company-card-website')) { S('company-card-website').textContent = website || ''; S('company-card-website').href = website || '#'; }
  card.classList.remove('hidden');
}

// === è¨­å®šé é è¦½æ¸²æŸ“ ===
function renderCompanyPreview(data) {
  const S = (id) => document.getElementById(id);
  if (!data) {
    if (S('company-preview-logo')) S('company-preview-logo').src = '';
    if (S('company-preview-name')) S('company-preview-name').textContent = 'ï¼ˆå°šæœªè¨­å®šï¼‰';
    if (S('preview-line-phone')) S('preview-line-phone').textContent = '';
    if (S('preview-line-address')) S('preview-line-address').textContent = '';
    if (S('preview-line-website')) { S('preview-line-website').textContent = ''; S('preview-line-website').href = '#'; }
    if (S('company-preview-desc')) S('company-preview-desc').textContent = '';
    return;
  }
  const { name, phone, address, website, logoUrl, description } = data;
  if (S('company-preview-logo')) S('company-preview-logo').src = logoUrl || '';
  if (S('company-preview-name')) S('company-preview-name').textContent = name || 'ï¼ˆå°šæœªè¨­å®šï¼‰';
  if (S('preview-line-phone')) S('preview-line-phone').textContent = phone ? `é›»è©±ï¼š${phone}` : '';
  if (S('preview-line-address')) S('preview-line-address').textContent = address ? `åœ°å€ï¼š${address}` : '';
  if (S('preview-line-website')) { S('preview-line-website').textContent = website || ''; S('preview-line-website').href = website || '#'; }
  if (S('company-preview-desc')) S('company-preview-desc').textContent = description || '';
}

// === å¸¶å…¥è¡¨å–® ===
function fillCompanyForm(data) {
  const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
  set('company-name', data?.name);
  set('company-regno', data?.regNo);
  set('company-phone', data?.phone);
  set('company-address', data?.address);
  set('company-website', data?.website);
  set('company-logo', data?.logoUrl);
  set('company-desc', data?.description);
}

// === ä¸Šå‚³ Logo åˆ° Storage ===
window.uploadCompanyLogo = function uploadCompanyLogo() {
  try { if (!auth || !auth.currentUser) { alert('è«‹å…ˆç™»å…¥'); return; } } catch (e) { alert('è«‹å…ˆç™»å…¥'); return; }
  const fileEl = document.getElementById('company-logo-file');
  if (!fileEl?.files?.[0]) { alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡æª”'); return; }
  const file = fileEl.files[0];
  const uid = auth.currentUser.uid;
  const ext = (file.name.split('.').pop() || 'png').toLowerCase();
  const path = `logos/${uid}/company_logo_${Date.now()}.${ext}`;
  const refObj = storageRef(storage, path);

  const progressEl = document.getElementById('logo-upload-progress');
  const statusEl = document.getElementById('logo-upload-status');

  const task = uploadBytesResumable(refObj, file, { cacheControl: 'public,max-age=31536000' });
  task.on('state_changed',
    snap => {
      const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
      if (progressEl) progressEl.value = pct;
      if (statusEl) statusEl.textContent = `ä¸Šå‚³ä¸­â€¦ ${pct}%`;
    },
    err => {
      console.error('ä¸Šå‚³å¤±æ•—ï¼š', err);
      if (statusEl) statusEl.textContent = 'ä¸Šå‚³å¤±æ•—';
      alert('ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦');
    },
    async () => {
      try {
        const url = await getDownloadURL(task.snapshot.ref);
        const urlInput = document.getElementById('company-logo');
        if (urlInput) urlInput.value = url;
        const prevImg = document.getElementById('company-preview-logo');
        if (prevImg) prevImg.src = url;
        if (statusEl) statusEl.textContent = 'ä¸Šå‚³å®Œæˆ';
        alert('ä¸Šå‚³å®Œæˆï¼å·²è‡ªå‹•å¡«å…¥ Logo URLï¼Œè«‹æŒ‰ã€Œå„²å­˜ã€ã€‚');
      } catch (e) {
        console.error('å–å¾—ä¸‹è¼‰é€£çµå¤±æ•—ï¼š', e);
        alert('å–å¾—ä¸‹è¼‰é€£çµå¤±æ•—');
      }
    }
  );
};

// === å„²å­˜å…¬å¸è³‡æ–™åˆ° Firestore ===
window.handleSaveCompany = async function handleSaveCompany() {
  const user = auth?.currentUser;
  if (!user) { alert('è«‹å…ˆç™»å…¥ï¼'); return; }
  const data = {
    name: document.getElementById('company-name')?.value.trim() || '',
    regNo: document.getElementById('company-regno')?.value.trim() || '',
    phone: document.getElementById('company-phone')?.value.trim() || '',
    address: document.getElementById('company-address')?.value.trim() || '',
    website: document.getElementById('company-website')?.value.trim() || '',
    logoUrl: document.getElementById('company-logo')?.value.trim() || '',
    description: document.getElementById('company-desc')?.value.trim() || '',
    updatedAt: serverTimestamp(),
  };
  if (!data.name) { alert('è«‹è‡³å°‘å¡«å¯«ã€Œå…¬å¸åç¨±ã€'); return; }
  try {
    const ref = companyDocRef(user.uid);
    const snap = await getDoc(ref);
    await setDoc(ref, { ...(snap.exists() ? {} : { createdAt: serverTimestamp() }), ...data }, { merge: true });
    const hint = document.getElementById('company-save-hint');
    if (hint) { hint.classList.remove('hidden'); setTimeout(() => hint.classList.add('hidden'), 1500); }
  } catch (e) {
    console.error('å„²å­˜å…¬å¸è³‡æ–™å¤±æ•—ï¼š', e);
    alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
};

// === ç™»å…¥å¾Œç›£è½å…¬å¸æ–‡ä»¶ ===
try {
  onAuthStateChanged(auth, (user) => {
    if (user) {
      if (window.__unsubCompany) { window.__unsubCompany(); window.__unsubCompany = null; }
      window.__unsubCompany = onSnapshot(companyDocRef(user.uid), (snap) => {
        const data = snap.exists() ? snap.data() : null;
        renderCompanyCard(data);
        renderCompanyPreview(data);
        fillCompanyForm(data || {});
      }, (err) => console.error('å…¬å¸è³‡æ–™ç›£è½å¤±æ•—ï¼š', err));
    } else {
      if (window.__unsubCompany) { window.__unsubCompany(); window.__unsubCompany = null; }
      renderCompanyCard(null);
      renderCompanyPreview(null);
      fillCompanyForm({});
    }
  });
} catch (e) { console.warn('onAuthStateChanged å°šæœªå¯ç”¨'); }

</script>


</body>
</html>