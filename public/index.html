<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chatbot 測試</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 40px auto; background: #f4f4f4; }
        #chat-container { border: 1px solid #ccc; padding: 20px; background: #fff; height: 400px; overflow-y: scroll; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 10px; }
        .user-message { background: #0084ff; color: white; text-align: right; }
        .bot-message { background: #e5e5ea; color: black; text-align: left; }
        #input-area { display: flex; margin-top: 10px; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; }
        #send-button { padding: 10px 20px; border: none; background: #0084ff; color: white; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Gemini Chatbot 測試</h1>
    <div id="chat-container"></div>
    <div id="input-area">
        <input type="text" id="message-input" placeholder="在這裡輸入訊息...">
        <button id="send-button">送出</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firestore-compat.js"></script>

    <script>
        // TODO: 在下方貼上你的 Firebase 設定物件
        const firebaseConfig = {
          apiKey: "AIzaSyCtOwoKYJfrSshSfkipfMH9lTngRsfQLDc",
          authDomain: "test-b493a.firebaseapp.com",
          projectId: "test-b493a",
          storageBucket: "test-b493a.firebasestorage.app",
          messagingSenderId: "1089014108157",
          appId: "1:1089014108157:web:2ac36c728f861795909394",
          measurementId: "G-1GY922PWL9"
        };


        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 為了測試，我們先寫死一個使用者ID。
        // 這個 ID 就是你在 Firestore 截圖中看到的那個 `GUvBeM2b0e...`
        // 你也可以用任何自訂的字串來代表一個新的使用者。
        const USER_ID = "GUvBeM2b0eQLXNKSNW10"; // 直接使用你截圖中的ID

        // 取得 HTML 元素
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // 這是 "魔法" 發生的地方：監聽資料庫的變化
        // 這個路徑必須跟你的擴充功能設定完全一樣
        const messagesRef = db.collection('users').doc(USER_ID).collection('messages');
        
        messagesRef.orderBy('createTime', 'asc').onSnapshot(snapshot => {
            chatContainer.innerHTML = ''; // 清空聊天室，重新渲染
            snapshot.forEach(doc => {
                const data = doc.data();

                // 顯示使用者自己的訊息
                if (data.prompt) {
                    displayMessage(data.prompt, 'user-message');
                }
                
                // 檢查 Gemini 的回覆是否已經寫入
                if (data.response) {
                    displayMessage(data.response, 'bot-message');
                } else {
                    // 如果還沒有回覆，可以顯示一個 "思考中..." 的提示
                    displayMessage("思考中...", 'bot-message');
                }
            });
            // 捲動到最下面
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // 用來在畫面上顯示訊息的函式
        function displayMessage(text, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + className;
            messageDiv.innerText = text;
            chatContainer.appendChild(messageDiv);
        }

        // 送出訊息的函式
        async function sendMessage() {
            const promptText = messageInput.value.trim();
            if (promptText === '') return;

            messageInput.value = ''; // 清空輸入框

            // 這就是 "寫入資料" 的動作！
            // 我們把使用者的訊息寫入 Firestore
            // 擴充功能會自動偵測到這個新文件
            await messagesRef.add({
                prompt: promptText,
                createTime: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // 綁定事件
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

    </script>
</body>
</html>

