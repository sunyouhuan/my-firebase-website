<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gemini Chat (Firestore Extension)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Noto Sans TC", sans-serif; background:#f7fafc; margin:0; }
    .app { max-width: 760px; margin: 32px auto; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); overflow:hidden; }
    header { padding:16px 20px; border-bottom:1px solid #eef2f7; display:flex; justify-content:space-between; align-items:center; }
    header h1 { font-size:18px; margin:0; }
    #status { font-size:12px; color:#666; }
    .messages { padding:20px; height:60vh; overflow:auto; }
    .msg { padding:12px 14px; margin-bottom:12px; border-radius:12px; line-height:1.55; white-space:pre-wrap; }
    .me { background:#e8f0fe; align-self:flex-end; }
    .bot { background:#f1f5f9; }
    .sys { background:#fef3c7; }
    .composer { display:flex; gap:8px; padding:16px; border-top:1px solid #eef2f7; }
    .composer input { flex:1; padding:12px 14px; border:1px solid #d9e1ec; border-radius:10px; font-size:16px; }
    .composer button { padding:12px 16px; border:none; border-radius:10px; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
    .composer button:disabled { opacity:.5; cursor:not-allowed; }
    .wrap { display:flex; flex-direction:column; gap:8px; }
    .hint { font-size:12px; color:#666; padding:0 20px 16px; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Gemini Chatbot (via Firebase Extension)</h1>
    <div id="status">å°šæœªç™»å…¥â€¦</div>
  </header>

  <div class="hint">æ­¤é é¢æœƒï¼šåŒ¿åç™»å…¥ Firebase â†’ åœ¨ <code>users/{uid}/messages</code> å¯«å…¥ <code>prompt</code> â†’ ç›£è½æ“´å……ç¨‹å¼å¯«å›çš„ <code>response</code>ã€‚</div>

  <div id="messages" class="messages"></div>

  <div class="composer">
    <input id="text" placeholder="è¼¸å…¥è¨Šæ¯ï¼Œä¾‹å¦‚ï¼šå¹«æˆ‘ç”¨ä¸‰é»æ•´ç†ä»Šå¤©å¾…è¾¦" />
    <button id="send">é€å‡º</button>
  </div>
</div>

<script type="module">
  // ---- Firebase SDK (v9 æ¨¡çµ„ç‰ˆ) ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { 
    getAuth, signInAnonymously, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, serverTimestamp, 
    onSnapshot, query, orderBy, limit 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // 1) é€™è£¡æ›æˆä½ çš„å°ˆæ¡ˆè¨­å®šï¼ˆFirebase Consoleâ†’å°ˆæ¡ˆè¨­å®šâ†’ä¸€èˆ¬â†’ä½ çš„Web Appï¼‰
  const firebaseConfig = {
apiKey: "AIzaSyCtOwoKYJfrSshSfkipfMH9lTngRsfQLDc",
authDomain: "test-b493a.firebaseapp.com",
projectId: "test-b493a",
storageBucket: "test-b493a.firebasestorage.app",
messagingSenderId: "1089014108157",
appId: "1:1089014108157:web:2ac36c728f861795909394",
measurementId: "G-1GY922PWL9"
};


  // 2) åˆå§‹åŒ–
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $status = document.getElementById('status');
  const $messages = document.getElementById('messages');
  const $text = document.getElementById('text');
  const $send = document.getElementById('send');

  let uid = null;
  let msgsUnsub = null;

  function pushMsg(html, cls='bot') {
    const div = document.createElement('div');
    div.className = `msg ${cls}`;
    div.textContent = html;
    $messages.appendChild(div);
    $messages.scrollTop = $messages.scrollHeight;
  }

  // 3) åŒ¿åç™»å…¥
  signInAnonymously(auth).catch(e => {
    console.error(e);
    $status.textContent = 'åŒ¿åç™»å…¥å¤±æ•—ï¼š' + e.message;
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    uid = user.uid;
    $status.textContent = 'å·²ç™»å…¥ï¼ˆåŒ¿åï¼‰UIDï¼š' + uid;

    // 4) ç›£è½æœ€æ–°è¨Šæ¯ï¼ˆåŒ…å«æ¨¡å‹å›è¦†ï¼‰
    if (msgsUnsub) msgsUnsub();
    const msgsRef = collection(db, 'users', uid, 'messages');
    const q = query(msgsRef, orderBy('createTime', 'asc'), limit(50));
    msgsUnsub = onSnapshot(q, (snap) => {
      $messages.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        if (d.prompt) pushMsg('ä½ ï¼š' + d.prompt, 'me');
        if (d.response) pushMsg('æ©Ÿå™¨äººï¼š' + d.response, 'bot');
        if (d.status && !d.response) pushMsg('ç‹€æ…‹ï¼š' + d.status, 'sys');
      });
    });
  });

  // 5) é€å‡ºè¨Šæ¯ï¼šåœ¨ messages æ–°å¢ä¸€ç­†å« prompt çš„æ–‡ä»¶
  async function send() {
    const text = $text.value.trim();
    if (!text || !uid) return;
    $send.disabled = true;

    try {
      const msgsRef = collection(db, 'users', uid, 'messages');
      await addDoc(msgsRef, {
        prompt: text,                     // æ“´å……ç¨‹å¼è®€å–çš„æ¬„ä½
        createTime: serverTimestamp(),    // ç”¨ä¾†æ’åº
        // ï¼ˆå¯é¸ï¼‰ä½ ä¹Ÿå¯ä»¥å˜—è©¦åŠ åƒæ•¸ï¼Œå‰ææ˜¯ä½ çš„æ“´å……ç¨‹å¼ç‰ˆæœ¬æ”¯æ´ï¼š
        // temperature: 0.4,
        // topK: 32,
        // topP: 0.95,
      });
      $text.value = '';
      // æ“´å……ç¨‹å¼æœƒåœ¨èƒŒæ™¯å‘¼å« Geminiï¼Œå¹¾ç§’å¾ŒæŠŠ response å¯«å›åŒç­†æ–‡ä»¶ã€‚
    } catch (e) {
      console.error(e);
      alert('é€å‡ºå¤±æ•—ï¼š' + e.message);
    } finally {
      $send.disabled = false;
    }
  }

  $send.addEventListener('click', send);
  $text.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') send();
  });

  // åˆå§‹å¼•å°è¨Šæ¯
  pushMsg('ğŸ‘‹ å—¨ï¼è¼¸å…¥è¨Šæ¯ä¸¦é€å‡ºï¼Œæˆ‘æœƒæŠŠå®ƒå¯«åˆ° Firestore çš„ users/{uid}/messagesã€‚æ“´å……ç¨‹å¼æœƒè‡ªå‹•ç”¨ Gemini å›è¦†ï¼Œå¹¾ç§’å¾Œä½ æœƒçœ‹åˆ° responseã€‚');
</script>
</body>
</html>
