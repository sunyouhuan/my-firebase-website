<!DOCTYPE html>
<!--
  檔名：12.html (v3)
  說明：
  1. [行銷活動] "建立新活動" 的彈出式表單 (new-campaign-modal) 中，新增圖片上傳區塊。
     - 包含一個 <input type="file" multiple>
     - 一個 "上傳選取的圖片" 按鈕
     - 一個預覽區域 (image-preview-area)
     - 一個進度條與狀態文字
  2. [JS] 新增 let uploadedImageUrls = [] 暫存陣列。
  3. [JS] 新增 handleUplorderBy("createdAt", "desc"));oadCampaignImages() 函式，處理多檔案上傳至 Firebase Storage，並將回傳的 URL 存入暫存陣列，同時顯示預覽圖。
  4. [JS] 修改 handleSaveBrief()，將暫存的 uploadedImageUrls 陣列一併存入 Firestore 的 briefs 文件中 (欄位為 imageUrls)。
  5. [JS] 修改 closeModal()，在關閉 "new-campaign-modal" 時，自動清空 uploadedImageUrls 暫存陣列與圖片預覽區。
  6. [JS] 修改 renderCampaigns()，讓行銷活動卡片會抓取 imageUrls[0] (第一張圖) 作為封面圖顯示。
  7. [JS] 修改 showCampaignDetail()，在活動詳情頁中，顯示所有上傳的行銷圖片。
  8. [表單滾輪] 彈出式表單的內容區塊本來就有 overflow-y-auto，在新增圖片預覽後，內容變長，滾輪會自動生效。
-->
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InfluenceAI - AI 驅動的網紅行銷平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* cool gray 50 */
        }
        .view, .dashboard-content {
            display: none;
        }
        .view.active, .dashboard-content.active {
            display: block;
        }
        .sidebar-link {
            transition: all 0.2s;
        }
        .sidebar-link.active, .sidebar-link:hover {
            background-color: #f1f5f9; /* slate 100 */
            color: #1e293b; /* slate 800 */
            transform: translateX(4px);
            border-left: 3px solid #0d9488; /* teal 600 */
        }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            color: #0d9488; /* teal 600 */
            border-bottom-color: #0d9488;
        }
        .modal {
            transition: opacity 0.3s ease;
        }

        /* === 修正 2: 確保註冊頁面的白色卡片浮在動畫之上 === */
          #register-view .w-full.max-w-md {
            position: relative;
            z-index: 10; /* 確保高於背景 blobs */
          }

        /* --- v2 (本次修改): 儲值按鈕的 Active 狀態 --- */
        .payment-btn.active {
            border-color: #0d9488; /* teal 600 */
            background-color: #f0fdfa; /* teal 50 */
            color: #0d9488;
            border-width: 2px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    
/* === Light mode global glow & role-selection background === */
html:not(.dark) .global-glow{
  position: fixed; inset: -60% -60%; width: 220%; height: 220%;
  z-index: 0; pointer-events: none;
  background:
    radial-gradient(circle, rgba(99,102,241,0.35) 0%, rgba(99,102,241,0) 60%),
    radial-gradient(circle at top right, rgba(139,92,246,0.40) 0%, rgba(139,92,246,0) 50%);
  opacity: .70;
  filter: saturate(110%) brightness(108%) contrast(105%);
  animation: rotateGlowV15 22s linear infinite;
}

html:not(.dark) #role-selection-view{ background: transparent !important; position: relative !important; overflow:hidden; }
html:not(.dark) #role-selection-view .min-h-screen{ background: transparent !important; }


/* ==== role-selection 覆寫：讓動畫可見 ==== */
html:not(.dark) #role-selection-view{ background: transparent !important; position: relative !important; overflow: hidden; }
html.dark       #role-selection-view{ background: transparent !important; position: relative !important; overflow: hidden; }
html:not(.dark) #role-selection-view .min-h-screen{ background: transparent !important; }
html.dark       #role-selection-view .min-h-screen{ background: transparent !important; }
/* 角色頁內容浮在動畫之上 */
#role-selection-view > * { position: relative !important; z-index: 1 !important; }
/* 確保動畫層在最底 */
#bg-anim{ z-index: 0 !important; pointer-events: none; }

</style>

<style>
  /* —— 主題顏色（參考「前端測試版本_03」） —— */
  :root {
    --c-bg-dark: #111827;       /* slate-900 */
    --c-side-dark: #1f2937;     /* slate-800 */
    --c-card-dark: #374151;     /* slate-700 */
    --c-border-dark: #4b5563;   /* slate-600 */
    --c-text1-dark: #f9fafb;    /* gray-50 */
    --c-text2-dark: #9ca3af;    /* gray-400 */
    --c-primary: #818cf8;       /* indigo-400 */
    --c-primary-hover: #6366f1; /* indigo-500 */
    --c-success: #34d399;       /* emerald-400 */
    --c-accent: #0d9488;        /* teal-600 */
  }

  /* —— 主開關：html.dark 時啟用覆寫 —— */
  html.dark body { background-color: var(--c-bg-dark) !important; color: var(--c-text1-dark) !important; }

  /* 常見背景類別覆寫（index 現用到的） */
  html.dark .bg-white     { background-color: var(--c-card-dark) !important; color: var(--c-text1-dark) !important; }
  html.dark .bg-slate-50  { background-color: var(--c-bg-dark)  !important; }
  html.dark .bg-slate-100 { background-color: var(--c-side-dark)!important; }
  html.dark .bg-slate-700 { background-color: var(--c-side-dark)!important; }
  html.dark .bg-gray-100  { background-color: #2a3341 !important; }
  html.dark .bg-gray-200  { background-color: #354052 !important; }
  html.dark .bg-slate-700.text-white { background-color: var(--c-side-dark) !important; }

  /* 邊框與陰影 */
  html.dark .border, 
  html.dark .border-gray-300, 
  html.dark .border-slate-200 { border-color: var(--c-border-dark) !important; }
  html.dark .shadow, 
  html.dark .shadow-lg, 
  html.dark .shadow-md { box-shadow: 0 8px 20px rgba(0,0,0,0.35) !important; }

  /* 文字色 */
  html.dark .text-slate-800, 
  html.dark .text-gray-800  { color: var(--c-text1-dark) !important; }
  html.dark .text-gray-700, 
  html.dark .text-gray-600, 
  html.dark .text-slate-600 { color: var(--c-text2-dark) !important; }
  html.dark .text-teal-600  { color: var(--c-primary) !important; }

  /* 互動/主色系 */
  html.dark .hover\:bg-slate-800:hover { background-color: #2b3443 !important; }
  html.dark .bg-teal-500, 
  html.dark .hover\:bg-teal-600:hover  { background-color: var(--c-primary) !important; }
  html.dark .text-green-500 { color: var(--c-success) !important; }

  /* 卡片、Modal、頁首、側邊欄（常見容器） */
  html.dark header.bg-white, 
  html.dark .bg-white.border-b { background-color: var(--c-side-dark) !important; border-color: var(--c-border-dark) !important; }
  html.dark #merchant-sidebar,
  html.dark #influencer-sidebar { background-color: var(--c-side-dark) !important; }
  html.dark #platform-detail-modal > div,
  html.dark #ai-chat-modal > div { background-color: var(--c-card-dark) !important; border-color: var(--c-border-dark) !important; }

  /* 表單元件（input/textarea/select） */
  html.dark input[type="text"],
  html.dark input[type="email"],
  html.dark input[type="password"],
  html.dark input[type="number"],
  html.dark input[type="url"],
  html.dark textarea,
  html.dark select {
    background-color: #1f2937 !important;
    color: var(--c-text1-dark) !important;
    border-color: var(--c-border-dark) !important;
  }
  html.dark ::placeholder { color: #9aa3af !important; }

  /* 登入頁橫幅（index 的 hero 區） */
  html.dark #login-view .min-h-screen { background: transparent !important; }
  html.dark #login-view { background: #111827 !important; }

  /* 提示卡片 */
  html.dark .bg-slate-700.text-white { background-color: #273244 !important; color: var(--c-text1-dark) !important; }

  /* —— 浮動主題按鈕 —— */
  .theme-toggle {
    position: fixed; right: 16px; bottom: 16px; z-index: 1060;
    background: #ffffff; color: #111827; border: 1px solid #e5e7eb;
    padding: 10px 12px; border-radius: 999px; font-weight: 700;
  }
  html.dark .theme-toggle {
    background: var(--c-side-dark); color: var(--c-text1-dark); border-color: var(--c-border-dark);
  }
</style>


<style>
  /* ===== Dark Theme (matched to 前端測試版本_03) ===== */
  :root {
    --background: #111827;       /* slate-900 */
    --sidebar:    #1f2937;       /* slate-800 */
    --card:       #374151;       /* slate-700 */
    --border:     #4b5563;       /* slate-600 */
    --text-primary:   #f9fafb;   /* gray-50 */
    --text-secondary: #9ca3af;   /* gray-400 */
    --primary:        #818cf8;   /* indigo-400 */
    --primary-hover:  #6366f1;   /* indigo-500 */
    --success:        #34d399;   /* emerald-400 */
  }

  /* Root switch */
  html.dark body {
    background-color: var(--background) !important;
    color: var(--text-primary) !important;
  }

  /* --- Utility mappings (common Tailwind classes in index) --- */
  /* Backgrounds */
  html.dark .bg-white       { background-color: var(--card) !important; }
  html.dark .bg-gray-50,
  html.dark .bg-slate-50    { background-color: var(--background) !important; }
  html.dark .bg-gray-100,
  html.dark .bg-slate-100   { background-color: var(--sidebar) !important; }
  html.dark .bg-gray-200,
  html.dark .bg-slate-200   { background-color: #2b3443 !important; }
  html.dark .bg-gray-700,
  html.dark .bg-slate-700   { background-color: var(--sidebar) !important; }
  html.dark .bg-gray-800,
  html.dark .bg-slate-800   { background-color: var(--sidebar) !important; }

  /* Borders & shadows */
  html.dark .border,
  html.dark .border-gray-200,
  html.dark .border-gray-300,
  html.dark .border-slate-200,
  html.dark .border-slate-300 { border-color: var(--border) !important; }
  html.dark .divide-gray-200,
  html.dark .divide-slate-200 { border-color: var(--border) !important; }
  html.dark .shadow, html.dark .shadow-md, html.dark .shadow-lg {
    box-shadow: 0 10px 24px rgba(0,0,0,0.35) !important;
  }

  /* Text colors */
  html.dark .text-black,
  html.dark .text-gray-900,
  html.dark .text-slate-900,
  html.dark .text-gray-800,
  html.dark .text-slate-800,
  html.dark .text-white     { color: var(--text-primary) !important; }
  html.dark .text-gray-700,
  html.dark .text-gray-600,
  html.dark .text-slate-600,
  html.dark .text-gray-500,
  html.dark .text-slate-500 { color: var(--text-secondary) !important; }
  html.dark .text-green-500,
  html.dark .text-emerald-500 { color: var(--success) !important; }
  html.dark .text-teal-600,
  html.dark .text-indigo-500,
  html.dark .text-indigo-600 { color: var(--primary) !important; }

  /* Brand/Action backgrounds */
  html.dark .bg-teal-500,
  html.dark .bg-indigo-500,
  html.dark .bg-blue-600,
  html.dark .bg-emerald-500,
  html.dark .bg-green-500 { background-color: var(--primary) !important; }
  html.dark .hover\:bg-teal-600:hover,
  html.dark .hover\:bg-indigo-600:hover,
  html.dark .hover\:bg-blue-700:hover { background-color: var(--primary-hover) !important; }

  /* Cards, headers, sidebars, modals */
  html.dark header.bg-white,
  html.dark .bg-white.border-b { background-color: var(--sidebar) !important; border-color: var(--border) !important; }
  html.dark #merchant-sidebar, html.dark #influencer-sidebar { background-color: var(--sidebar) !important; }
  html.dark #platform-detail-modal > div,
  html.dark #ai-chat-modal > div { background-color: var(--card) !important; border-color: var(--border) !important; }

  /* Inputs */
  html.dark input[type="text"],
  html.dark input[type="email"],
  html.dark input[type="password"],
  html.dark input[type="number"],
  html.dark input[type="url"],
  html.dark textarea,
  html.dark select {
    background-color: var(--sidebar) !important;
    color: var(--text-primary) !important;
    border-color: var(--border) !important;
  }
  html.dark ::placeholder { color: var(--text-secondary) !important; }

  /* --- Dark UI accents aligned with 前端測試版本_03 --- */
  /* Login view animated radial gradient */
  html.dark #login-view { position: relative; background: var(--background) !important; overflow: hidden; }
  html.dark #login-view::before {
    content: ''; position: absolute; width: 200%; height: 200%; top: -50%; left: -50%; z-index: 0;
    background:
      radial-gradient(circle, rgba(99, 102, 241, 0.4) 0%, rgba(99, 102, 241, 0) 60%),
      radial-gradient(circle at top right, rgba(139, 92, 246, 0.5) 0%, rgba(139, 92, 246, 0) 50%);
    animation: rotateBG 25s linear infinite;
  }
  @keyframes rotateBG { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* Sidebar link hover/active effect */
  html.dark .sidebar-link { transition: all 0.2s; }
  html.dark .sidebar-link:hover,
  html.dark .sidebar-link.active {
    background-color: rgba(75, 85, 99, 0.125); /* #4b556320 */
    color: var(--primary) !important;
    transform: translateX(4px);
    border-left: 3px solid var(--primary);
  }

  /* Pills / badges */
  html.dark .badge, html.dark .chip, html.dark .rounded-full.bg-yellow-400\/20 {
    border-color: var(--border) !important;
  }

  /* Optional helpers if index uses these semantic classes */
  html.dark .bg-background { background-color: var(--background) !important; }
  html.dark .bg-sidebar    { background-color: var(--sidebar) !important; }
  html.dark .bg-card       { background-color: var(--card) !important; }
  html.dark .border-border { border-color: var(--border) !important; }
  html.dark .text-text-primary   { color: var(--text-primary) !important; }
  html.dark .text-text-secondary { color: var(--text-secondary) !important; }
  html.dark .text-primary        { color: var(--primary) !important; }
  html.dark .text-success        { color: var(--success) !important; }
  html.dark .bg-primary          { background-color: var(--primary) !important; }
  html.dark .hover\:bg-primary-hover:hover { background-color: var(--primary-hover) !important; }

  /* Toggle button */
  .theme-toggle {
    position: fixed; right: 16px; bottom: 16px; z-index: 1060;
    background: #ffffff; color: #111827; border: 1px solid #e5e7eb;
    padding: 10px 12px; border-radius: 999px; font-weight: 700;
  }
  html.dark .theme-toggle {
    background: var(--sidebar); color: var(--text-primary); border-color: var(--border);
  }
</style>


<style>
  /* --- Fix: login radial overlay blocking clicks & causing hazy layer --- */
  html.dark #login-view { position: relative !important; }
  html.dark #login-view::before {
    pointer-events: none !important;
    z-index: 0 !important;
    opacity: 0.45 !important; /* slightly lower for less haze */
  }
  html.dark #login-view > * {
    position: relative !important;
    z-index: 1 !important;
  }

  /* --- Fix: keep .text-white actually white in dark mode --- */
  html.dark .text-white { color: #ffffff !important; }

  /* --- Logo accent for "InfluenceAI" (common patterns) --- */
  html.dark #login-view h1 span:last-child,
  html.dark header h1 span:last-child,
  html.dark .brand .accent,
  html.dark .logo .accent,
  html.dark .logo-accent,
  html.dark .text-brand-accent {
    color: var(--primary) !important;
  }
</style>


<style>
  /* === v4 tuning === */

  /* 3) Richer purple animated background, locked behind content */
  html.dark #login-view::before {
    background:
      radial-gradient(circle at 35% 40%, rgba(129,140,248,0.45) 0%, rgba(129,140,248,0) 55%),
      radial-gradient(circle at 75% 20%, rgba(167,139,250,0.55) 0%, rgba(167,139,250,0) 52%),
      radial-gradient(circle at 10% 85%, rgba(56,189,248,0.18) 0%, rgba(56,189,248,0) 45%);
    filter: saturate(110%);
    opacity: 0.50 !important;
  }

  /* 2) Lighter card / panel surfaces (灰白一點) */
  html.dark .bg-white,
  html.dark .bg-card,
  html.dark .bg-slate-800\/50,
  html.dark .bg-slate-800,
  html.dark .bg-gray-800,
  html.dark .bg-sidebar {
    background-color: rgba(55, 65, 81, 0.50) !important; /* slate-700 with 50% */
    -webkit-backdrop-filter: blur(6px);
    backdrop-filter: blur(6px);
  }
  html.dark .border,
  html.dark .border-border,
  html.dark .border-slate-700,
  html.dark .border-slate-600,
  html.dark .border-slate-200,
  html.dark .border-gray-300,
  html.dark .border-gray-200 {
    border-color: rgba(148,163,184,0.35) !important; /* slate-400 with alpha */
  }
  html.dark .shadow,
  html.dark .shadow-lg,
  html.dark .shadow-md {
    box-shadow: 0 12px 40px rgba(2, 6, 23, 0.45) !important; /* stronger, deeper */
  }

  /* Inputs slightly brighter */
  html.dark input[type="text"],
  html.dark input[type="email"],
  html.dark input[type="password"],
  html.dark input[type="number"],
  html.dark input[type="url"],
  html.dark textarea,
  html.dark select {
    background-color: rgba(30, 41, 59, 0.65) !important; /* slate-800, 65% */
    border-color: rgba(148,163,184,0.35) !important;
  }

  /* 1) Logo accent selection */
  .logo-accent { color: var(--primary); }
  html.dark #login-view h1 span.logo-accent,
  html.dark header h1 span.logo-accent,
  html.dark .brand .logo-accent { color: var(--primary) !important; }

  /* Keep pure whites where explicitly used */
  html.dark .text-white { color: #ffffff !important; }
</style>


<style>
  /* === v5: Brighter purple background & animation, while staying behind UI === */
  html.dark body {
    background: radial-gradient(1200px 800px at 15% 20%, #3b2e9a 0%, rgba(59,46,154,0) 55%),
                radial-gradient(1000px 700px at 85% 25%, #6d4cf6 0%, rgba(109,76,246,0) 55%),
                linear-gradient(135deg, #1b1e36 0%, #1e2350 100%) !important;
    background-attachment: fixed !important;
  }

  html.dark #login-view { position: relative !important; overflow: hidden; }
  html.dark #login-view::before {
    content: ''; position: absolute; inset: -40% -30% -30% -40%;
    pointer-events: none !important; z-index: 0 !important;
    background:
      radial-gradient(circle at 35% 40%, rgba(129,140,248,0.70) 0%, rgba(129,140,248,0.00) 58%),
      radial-gradient(circle at 72% 28%, rgba(167,139,250,0.75) 0%, rgba(167,139,250,0.00) 54%),
      radial-gradient(circle at 10% 88%, rgba(232,121,249,0.40) 0%, rgba(232,121,249,0.00) 42%);
    filter: saturate(125%) brightness(110%);
    animation: rotateBGv5 26s linear infinite;
    opacity: 0.65 !important;
    transform-origin: 50% 50%;
  }
  @keyframes rotateBGv5 { from { transform: rotate(0deg) scale(1.05);} to { transform: rotate(360deg) scale(1.05);} }

  /* Slightly lighter glass cards to match brighter background */
  html.dark .bg-white,
  html.dark .bg-card,
  html.dark .bg-sidebar {
    background-color: rgba(55, 65, 81, 0.46) !important;
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
  }
  html.dark .border,
  html.dark .border-gray-200,
  html.dark .border-gray-300,
  html.dark .border-slate-200,
  html.dark .border-slate-300 {
    border-color: rgba(203, 213, 225, 0.32) !important; /* slate-300 w/ alpha */
  }

  /* Buttons: brighten primary hover for better contrast on light-purple */
  html.dark .bg-teal-500,
  html.dark .bg-indigo-500,
  html.dark .bg-blue-600,
  html.dark .bg-emerald-500,
  html.dark .bg-green-500 { background-color: #7c83ff !important; }
  html.dark .hover\:bg-teal-600:hover,
  html.dark .hover\:bg-indigo-600:hover,
  html.dark .hover\:bg-blue-700:hover { background-color: #6a70ff !important; }
</style>


<style>
  /* ===== v6 FINAL: Match reference bright-purple UX ===== */

  :root {
    --background: #111827;
    --sidebar:    #1f2937;
    --card:       #374151;
    --border:     #4b5563;
    --text-primary:   #f9fafb;   /* bright white */
    --text-secondary: #9ca3af;
    --primary:        #818cf8;   /* indigo-400 */
    --primary-hover:  #6366f1;   /* indigo-500 */
  }

  /* Keep whites truly white */
  html.dark .text-white { color: #ffffff !important; }

  /* --- Reference-style background with vivid purple glow & slow rotation --- */
  html.dark #login-view { position: relative !important; overflow: hidden; background: var(--background) !important; }
  html.dark #login-view::before {
    content: ""; position: absolute; width: 200%; height: 200%;
    top: -50%; left: -50%; z-index: 0; pointer-events: none;
    /* EXACT palette based on the reference: indigo-500 & purple-500 with alpha */
    background:
      radial-gradient(circle, rgba(99,102,241,0.40) 0%, rgba(99,102,241,0.00) 60%),
      radial-gradient(circle at top right, rgba(139,92,246,0.50) 0%, rgba(139,92,246,0.00) 50%);
    animation: rotateBG_ref 25s linear infinite;
    filter: saturate(120%) contrast(105%) brightness(108%);
  }
  @keyframes rotateBG_ref { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

  /* Also give the page a subtle fixed base gradient so other routes feel consistent */
  html.dark body {
    background:
      radial-gradient(1200px 800px at 15% 20%, rgba(99,102,241,0.12) 0%, rgba(99,102,241,0) 55%),
      radial-gradient(1000px 700px at 85% 25%, rgba(139,92,246,0.12) 0%, rgba(139,92,246,0) 55%),
      linear-gradient(135deg, #0f172a 0%, #1f2348 100%) !important;
    background-attachment: fixed !important;
  }

  /* --- Glass cards: lighter, airy, with crisp border --- */
  html.dark .bg-white,
  html.dark .bg-card,
  html.dark .bg-sidebar {
    background-color: rgba(31,41,59,0.50) !important;   /* slate-800/50 */
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    border-color: #4b5563 !important;                   /* slate-600 */
  }
  html.dark .border,
  html.dark .border-gray-200,
  html.dark .border-gray-300,
  html.dark .border-slate-200,
  html.dark .border-slate-300 { border-color: #4b5563 !important; }

  html.dark .shadow, html.dark .shadow-md, html.dark .shadow-lg {
    box-shadow: 0 16px 45px rgba(2,6,23,0.45) !important;
  }

  /* Inputs a bit brighter so they don't sink into the card */
  html.dark input[type="text"],
  html.dark input[type="email"],
  html.dark input[type="password"],
  html.dark input[type="number"],
  html.dark input[type="url"],
  html.dark textarea,
  html.dark select {
    background-color: rgba(17,24,39,0.60) !important;   /* slate-900 with alpha */
    border-color: rgba(148,163,184,0.40) !important;     /* slate-400 alpha */
    color: var(--text-primary) !important;
  }
  html.dark ::placeholder { color: rgba(156,163,175,0.90) !important; }

  /* Primary buttons: reference indigo look */
  html.dark .bg-teal-500,
  html.dark .bg-indigo-500,
  html.dark .bg-blue-600,
  html.dark .bg-emerald-500,
  html.dark .bg-green-500 { background-color: var(--primary) !important; }
  html.dark .hover\:bg-teal-600:hover,
  html.dark .hover\:bg-indigo-600:hover,
  html.dark .hover\:bg-blue-700:hover { background-color: var(--primary-hover) !important; }

  /* Sidebar link micro-interactions (reference) */
  html.dark .sidebar-link { transition: all 0.2s; }
  html.dark .sidebar-link:hover,
  html.dark .sidebar-link.active {
    background-color: rgba(75,85,99,0.12);
    color: var(--primary) !important;
    transform: translateX(4px);
    border-left: 3px solid var(--primary);
  }

  /* Logo AI accent: ensure it's vivid and white stays crisp */
  .logo-accent { color: var(--primary); }
  html.dark #login-view h1 span.logo-accent,
  html.dark header h1 span.logo-accent { color: var(--primary) !important; }
</style>
<script>
/* Ensure InfluenceAI -> 'AI' accented if no <span> present */
(function(){
  var nodes = [
    document.querySelector('#login-view h1'),
    document.querySelector('#login-view .text-6xl'),
    document.querySelector('#login-view .text-5xl'),
    document.querySelector('header h1')
  ];
  nodes.forEach(function(h){
    if(!h) return;
    var html = h.innerHTML;
    if(/<span/i.test(html)) return; // already custom
    var text = (h.textContent||'').trim();
    if(/InfluenceAI$/.test(text)){
      h.innerHTML = text.slice(0,-2) + '<span class="logo-accent">AI</span>';
    }
  });
})();
</script>


<style>
  /* === v9: Brighter & more prominent purple animation (minimal, reference-aligned) === */
  html.dark #login-view { position: relative !important; overflow: hidden; background: #111827 !important; }
  html.dark #login-view::before {
    pointer-events: none !important;
    z-index: 0 !important;

    width: 220% !important;
    height: 220% !important;
    top: -60% !important;
    left: -60% !important;

    background:
      radial-gradient(circle, rgba(99, 102, 241, 0.60) 0%, rgba(99, 102, 241, 0.00) 60%),
      radial-gradient(circle at top right, rgba(139, 92, 246, 0.70) 0%, rgba(139, 92, 246, 0.00) 50%);

    filter: saturate(145%) brightness(122%) contrast(112%);
    opacity: 0.80 !important;
    animation: rotateBG_ref 20s linear infinite !important;
    transform-origin: 50% 50%;
  }

  html.dark #login-view > * { position: relative; z-index: 1; }
</style>


<style>
/* ===== v15: Dark-mode global glow for login + role select; lavender AI; auto-hide after choice ===== */

/* Glow layer reused across views */
html.dark .global-glow {
  position: fixed; inset: -60% -60%; width: 220%; height: 220%;
  z-index: 0; pointer-events: none;
  background:
    radial-gradient(circle, rgba(99,102,241,0.60) 0%, rgba(99,102,241,0) 60%),
    radial-gradient(circle at top right, rgba(139,92,246,0.70) 0%, rgba(139,92,246,0) 50%);
  opacity: .80;
  filter: saturate(145%) brightness(122%) contrast(112%);
  animation: rotateGlowV15 22s linear infinite;
}
@keyframes rotateGlowV15 { to { transform: rotate(360deg); } }

/* Keep all content above glow */
html.dark.has-global-glow body > :not(.global-glow):not(.theme-toggle):not(.modal) {
  position: relative;
  z-index: 1;
}

/* Ensure login-view's ::before never blocks clicks; keep its look if you still want it */
html.dark #login-view::before { pointer-events: none !important; z-index: 0 !important; }

/* Lavender AI in dark mode regardless of original Tailwind classes */
:root { --lavender: #c4b5fd; }
html.dark #login-view .text-teal-500,
html.dark #login-view .text-teal-600,
html.dark #login-view .text-green-500,
html.dark #login-view .text-emerald-500,
html.dark #login-view .logo-accent,
html.dark #role-selection-view .text-teal-500,
html.dark #role-selection-view .text-teal-600,
html.dark #role-selection-view .text-green-500,
html.dark #role-selection-view .text-emerald-500,
html.dark #role-selection-view .logo-accent {
  color: var(--lavender) !important;
  text-shadow: 0 0 10px rgba(196,181,253,.28);
}

/* v16 fix: keep theme toggle fixed even under dark + global glow */
html.dark.has-global-glow .theme-toggle{
  position: fixed !important;
  right: 16px !important;
  bottom: 16px !important;
  z-index: 1060 !important;
}

/* v17: Make role-selection page use the same full-page gradient/glow as login */
html.dark #role-selection-view{ background: transparent !important; position: relative !important; overflow:hidden; }
html.dark #role-selection-view .min-h-screen { background: transparent !important; }

/* v17: Role-selection gets the same animated purple overlay as login */
html.dark #role-selection-view::before {
  content: ""; position: absolute; width: 200%; height: 200%;
  top: -50%; left: -50%; z-index: 0; pointer-events: none;
  background:
    radial-gradient(circle, rgba(99,102,241,0.40) 0%, rgba(99,102,241,0.00) 60%),
    radial-gradient(circle at top right, rgba(139,92,246,0.50) 0%, rgba(139,92,246,0.00) 50%);
  animation: rotateBG_ref 25s linear infinite;
  filter: saturate(120%) contrast(105%) brightness(108%);
}
html.dark #role-selection-view > * { position: relative; z-index: 1; }

/* v17 safety: keep content above overlays on role-selection */
html.dark.has-global-glow #role-selection-view > * { position: relative; z-index: 1; }


/* v18: Login intro scroll section (glassy marketing hero + features), stays under same background/glow */
html.dark #login-view .intro-wrap { max-width: 1200px; margin: 0 auto; padding: 32px 16px 56px; }
html.dark #login-view .hero-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 24px; align-items: center; }
@media (max-width: 980px){ html.dark #login-view .hero-grid { grid-template-columns: 1fr; } }

html.dark #login-view .badge { display:inline-flex; gap:8px; align-items:center; padding:8px 12px;
  border-radius:999px; border:1px solid rgba(148,163,184,.35); background: rgba(15,23,42,.35); color:#cbd5ff; }
html.dark #login-view .hero-title { font-size: 44px; line-height: 1.06; font-weight: 800; margin: 10px 0 12px; color:#e6ecff; }
html.dark #login-view .hero-sub { color:#9aa3b2; font-size: 18px; }
html.dark #login-view .chips { display:flex; flex-wrap:wrap; gap:10px; margin-top:14px; }
html.dark #login-view .chip { display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid rgba(148,163,184,.35); background: rgba(15,23,42,.35); color:#cbd5ff; }

html.dark #login-view .glass-card { background: rgba(31,41,59,0.50); border:1px solid rgba(148,163,184,.35);
  -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); border-radius: 14px; box-shadow: 0 16px 45px rgba(2,6,23,0.45); }
html.dark #login-view .feature-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top: 26px; }
@media (max-width: 980px){ html.dark #login-view .feature-grid { grid-template-columns: 1fr; } }
html.dark #login-view .feature-card { padding:20px; }
html.dark #login-view .cta-band { margin-top: 26px; padding: 22px; display:flex; justify-content:space-between; gap:16px; align-items:center; flex-wrap: wrap; }
html.dark #login-view .btn-primary { display:inline-block; padding:12px 18px; font-weight:700; border-radius:12px; background:#7c83ff; color:#fff; border:none; }
html.dark #login-view .btn-primary:hover { background:#6a70ff; }



/* v19: Professional scroll-triggered motion system (opacity+transform only) */
:root {
  --motion-duration: 900ms;
  --motion-distance: 24px;
  --motion-scale: .98;
  --motion-ease: cubic-bezier(.22,.61,.36,1);
}

/* base state */
.reveal { opacity: 0; transform: translateY(var(--motion-distance)) scale(var(--motion-scale)); will-change: transform, opacity; }
/* visible state */
.reveal.is-visible { opacity: 1; transform: translateY(0) scale(1); transition: transform var(--motion-duration) var(--motion-ease), opacity var(--motion-duration) var(--motion-ease); }

/* variants */
.reveal.slide-right { transform: translateX(-var(--motion-distance)); }
.reveal.slide-right.is-visible { transform: translateX(0); }

.reveal.slide-left { transform: translateX(var(--motion-distance)); }
.reveal.slide-left.is-visible { transform: translateX(0); }

.reveal.scale-in { transform: scale(.94); }
.reveal.scale-in.is-visible { transform: scale(1); }

/* stagger via inline style or data-delay attr */
.reveal[data-delay] { transition-delay: var(--delay, 0ms); }

/* reduced motion: show instantly */
@media (prefers-reduced-motion: reduce) {
  .reveal, .reveal.is-visible {
    opacity: 1 !important; transform: none !important; transition: none !important;
  }
}

/* login scroll hint */
.scroll-hint {
  position: absolute; left: 50%; transform: translateX(-50%);
  bottom: 18px; display: inline-flex; align-items: center; gap: 10px;
  padding: 8px 12px; border-radius: 999px; font-weight: 600;
  background: rgba(17,24,39,.55); color: #cbd5ff; border: 1px solid rgba(148,163,184,.35);
  -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
  cursor: pointer; user-select: none;
}
.scroll-hint .chev { display:inline-block; width:12px; height:12px; border-right:2px solid currentColor; border-bottom:2px solid currentColor; transform: rotate(45deg); animation: bob 1.4s ease-in-out infinite; }
@keyframes bob { 0%,100% { transform: translateY(0) rotate(45deg); } 50% { transform: translateY(4px) rotate(45deg);} }

/* subtle parallax of purple glow on scroll */
html.dark .global-glow { transition: transform 600ms var(--motion-ease); will-change: transform; }



/* v20: make login view a true fullscreen hero; intro strictly below the fold */
#login-view .hero-viewport {
  min-height: 100dvh; display: grid; place-items: center; position: relative;
  padding: 24px 16px 96px; /* top padding for nav/logo if needed and bottom for scroll-hint */
}
#login-view .afterfold-spacer { height: 12vh; } /* ensures intro starts below fold across devices */

/* mobile polish */
@media (max-width: 640px){
  html.dark #login-view .hero-title { font-size: 34px; }
  html.dark #login-view .hero-sub { font-size: 16px; }
  html.dark #login-view .feature-grid { grid-template-columns: 1fr; }
  .scroll-hint { bottom: 12px; padding: 6px 10px; }
}



/* v21: base layout + light theme palette for intro */
#login-view .intro-wrap { max-width: 1200px; margin: 0 auto; padding: 32px 16px 56px; }
#login-view .hero-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 24px; align-items: center; }
@media (max-width: 980px){ #login-view .hero-grid { grid-template-columns: 1fr; } }

/* Light theme look */
html:not(.dark) #login-view .badge { display:inline-flex; gap:8px; align-items:center; padding:8px 12px;
  border-radius:999px; border:1px solid rgba(2,6,23,.10); background: rgba(255,255,255,.65); color:#334155; }
html:not(.dark) #login-view .hero-title { font-size: 44px; line-height: 1.06; font-weight: 800; margin: 10px 0 12px; color:#111827; }
html:not(.dark) #login-view .hero-sub { color:#475569; font-size: 18px; }
#login-view .chips { display:flex; flex-wrap:wrap; gap:10px; margin-top:14px; } /* layout shared */
html:not(.dark) #login-view .chip { display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid rgba(2,6,23,.10); background: rgba(255,255,255,.65); color:#334155; }

html:not(.dark) #login-view .glass-card { background: rgba(255,255,255,0.70); border:1px solid rgba(2,6,23,0.08);
  -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); border-radius: 14px; box-shadow: 0 16px 45px rgba(2,6,23,0.08); }
#login-view .feature-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top: 26px; } /* layout shared */
@media (max-width: 980px){ #login-view .feature-grid { grid-template-columns: 1fr; } }
#login-view .feature-card { padding:20px; } /* layout shared */
html:not(.dark) #login-view .cta-band { margin-top: 26px; padding: 22px; display:flex; justify-content:space-between; gap:16px; align-items:center; flex-wrap: wrap; }
html:not(.dark) #login-view .btn-primary { display:inline-block; padding:12px 18px; font-weight:700; border-radius:12px; background:#4f46e5; color:#fff; border:none; }
html:not(.dark) #login-view .btn-primary:hover { background:#4338ca; }



/* v22: center heading + card as one stack */
#login-view .hero-viewport > .flex {
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  justify-content: center;
  gap: 12px;
  width: 100%;
}
#login-view .hero-viewport h1,
#login-view .hero-viewport p.leading-6 {
  text-align: center;
  margin: 0;
}
@media (max-width: 640px){
  #login-view .hero-viewport > .flex { gap: 8px; }
}



/* (b) Light theme accents (teal/gray) + richer typography */
:root{
  --brand-teal: #10b981;          /* emerald 500 like logo green */
  --brand-teal-600: #0ea5a4;      /* custom teal for hover */
  --brand-slate: #475569;         /* slate 600 */
  --brand-decor: #0d9488;         /* teal 600 legacy */
}
html:not(.dark) .brand-green { color: var(--brand-teal); }
html:not(.dark) .brand-muted { color: var(--brand-slate); }
html:not(.dark) .kicker { 
  display:inline-flex; align-items:center; gap:8px; 
  padding:6px 10px; border-radius:999px; 
  background: rgba(16,185,129,0.08); color:#0f766e; border:1px solid rgba(16,185,129,0.18);
}
html:not(.dark) .accent-underline {
  background: linear-gradient(transparent 70%, rgba(16,185,129,.25) 0);
}
html:not(.dark) .btn-primary { background: var(--brand-teal); }
html:not(.dark) .btn-primary:hover { background: var(--brand-teal-600); }

/* (c) Professional light-mode micro-animations */
html:not(.dark) .glass-card { transition: transform .35s cubic-bezier(.22,.61,.36,1), box-shadow .35s; }
html:not(.dark) .glass-card:hover { transform: translateY(-4px); box-shadow: 0 14px 30px rgba(2,6,23,.12); }
html:not(.dark) .chip { transition: transform .25s; }
html:not(.dark) .chip:hover { transform: translateY(-2px); }

/* (d) Ensure reveal animations visible in light theme as well */
html:not(.dark) .reveal.is-visible { will-change: transform, opacity; }



/* (a) Light-mode accents for TOP intro section
   亮色主題的 login-intro 樣式強化（badge / 標題高光 / 副標 / chip） */
html:not(.dark) #login-view .badge { 
  display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px;
  background: rgba(16,185,129,0.08); color:#0f766e; border:1px solid rgba(16,185,129,0.18);
}
html:not(.dark) #login-view .hero-title strong,
html:not(.dark) #login-view .hero-title .brand-green { color: var(--brand-teal); }
html:not(.dark) #login-view .hero-title .accent-underline {
  background: linear-gradient(transparent 70%, rgba(16,185,129,.25) 0);
}
html:not(.dark) #login-view .hero-sub { color: var(--brand-slate); }
html:not(.dark) #login-view .chip { 
  border-color: rgba(16,185,129,.22); 
  background: rgba(16,185,129,.06); 
  color:#0f766e; 
}

</style>







<script>
/* v15 runtime: manage glow on login + role selection; remove glow after choice */
(function(){
  function isVisible(el){
    if(!el) return false;
    var s = getComputedStyle(el);
    return s.display!=='none' && s.visibility!=='hidden' && (el.offsetParent!==null || s.position==='fixed');
  }
  function addGlowLayer(){
    if (!document.querySelector('.global-glow')) {
      var g = document.createElement('div');
      g.className = 'global-glow';
      document.body.prepend(g);
    }
    document.documentElement.classList.add('has-global-glow');
  }
  function removeGlow(){
    var g = document.querySelector('.global-glow'); if(g) g.remove();
    document.documentElement.classList.remove('has-global-glow');
  }
  function showBgAnim(show){
    var bg = document.getElementById('bg-anim');
    if(!bg) return;
    bg.style.display = show ? 'block' : 'none';
  }
  function ensureGlow(){
  const onLogin    = isVisible(document.getElementById('login-view'));
  const onRole     = isVisible(document.getElementById('role-selection-view'));
  const onRegister = isVisible(document.getElementById('register-view'));

  if (onLogin || onRole || onRegister) {
    addGlowLayer();
    showBgAnim(true);
  } else {
    removeGlow();
    showBgAnim(false);
  }
}
  var _navigateTo = window.navigateTo;
  window.navigateTo = function(viewId){
    if(_navigateTo) _navigateTo(viewId);
    setTimeout(ensureGlow, 0);
  };
  var _enterDashboard = window.enterDashboard;
  window.enterDashboard = function(role){
    removeGlow();
    showBgAnim(false);
    if(_enterDashboard) return _enterDashboard(role);
  };
  var _toggle = window.toggleTheme;
  window.toggleTheme = function(){
    if(_toggle) _toggle();
    setTimeout(ensureGlow, 0);
  };
  document.addEventListener('DOMContentLoaded', function(){
    ensureGlow();
    setTimeout(ensureGlow, 200);
  });
  window.addEventListener('hashchange', function(){ setTimeout(ensureGlow,0); });
  window.addEventListener('popstate',  function(){ setTimeout(ensureGlow,0); });
  new MutationObserver(function(){ setTimeout(ensureGlow,0); }).observe(document.body, {childList:true, subtree:true});
})();
</script>


<style>
  /* === Twin glow background (match 前端測試版本_05 style) === */
  #bg-anim{
    position: fixed; inset: 0;
    pointer-events: none; z-index: 0;
  }
  #bg-anim .blob{
    position: absolute; border-radius: 9999px;
    filter: blur(60px);
    animation: pulseSoft 8s ease-in-out infinite;
    will-change: transform, opacity;
  }
  /* Light theme */
  html:not(.dark) #bg-anim .blob-1{
    top: -20vh; left: -20vw; width: 50vmax; height: 50vmax;
    opacity: .40;
    background: linear-gradient(to top right,
      rgba(99,102,241,.95) 0%,
      rgba(125,211,252,.85) 50%,
      rgba(94,234,212,.85) 100%);
  }
  html:not(.dark) #bg-anim .blob-2{
    bottom: 0; right: 0; width: 45vmax; height: 45vmax;
    opacity: .30;
    background: linear-gradient(to bottom right,
      rgba(232,121,249,.95) 0%,
      rgba(192,132,252,.85) 50%,
      rgba(147,197,253,.85) 100%);
    animation-delay: -2s;
  }

  /* Dark theme */
  html.dark #bg-anim .blob-1{
    top: -20vh; left: -20vw; width: 50vmax; height: 50vmax;
    opacity: .30;
    background: linear-gradient(to top right,
      rgba(67,56,202,.95) 0%,
      rgba(2,132,199,.80) 50%,
      rgba(13,148,136,.80) 100%);
  }
  html.dark #bg-anim .blob-2{
    bottom: 0; right: 0; width: 45vmax; height: 45vmax;
    opacity: .20;
    background: linear-gradient(to bottom right,
      rgba(162,28,175,.95) 0%,
      rgba(126,34,206,.80) 50%,
      rgba(29,78,216,.80) 100%);
    animation-delay: -2s;
  }

  /* Optional: slightly reduce when global glow also present */
  html.dark.has-global-glow #bg-anim{ opacity: .70; }

  @keyframes pulseSoft{
    0%,100%{ opacity: .30; transform: scale(1); }
    50%    { opacity: .60; transform: scale(1.05); }
  }
</style>


<style>
/* ===== Ambient blobs drawn INSIDE login view using pseudo-elements (no DOM wrap) ===== */
#login-view .min-h-screen{ position: relative; }
#login-view .min-h-screen::before,
#login-view .min-h-screen::after{
  content:""; position:fixed; pointer-events:none;
  border-radius:9999px; filter:blur(60px);
  animation: pulseSoft 8s ease-in-out infinite;
  z-index:0; /* keep them under content */
  will-change: transform, opacity; /* smoother on fixed layer */
}

/* Light theme */
html:not(.dark) #login-view .min-h-screen::before{
  top:2vh; left:-15vw; width:50vmax; height:50vmax;
  background: linear-gradient(to top right,
    rgba(99,102,241,.97) 0%,
    rgba(125,211,252,.87) 50%,
    rgba(94,234,212,.87) 100%);
  opacity:.40;
}
html:not(.dark) #login-view .min-h-screen::after{
  bottom:0; right:0; width:45vmax; height:45vmax;
  background: linear-gradient(to bottom right,
    rgba(232,121,249,.80) 0%,
    rgba(192,132,252,.70) 50%,
    rgba(147,197,253,.70) 100%);
  opacity:.30; animation-delay:-2s;
}

/* Dark theme */
html.dark #login-view .min-h-screen::before{
  top:2vh; left:-15vw; width:50vmax; height:50vmax;
  background: linear-gradient(to top right,
    rgba(67,56,202,.97) 0%,
    rgba(2,132,199,.87) 50%,
    rgba(13,148,136,.87) 100%);
  opacity:.30;
}
html.dark #login-view .min-h-screen::after{
  bottom:0; right:0; width:45vmax; height:45vmax;
  background: linear-gradient(to bottom right,
    rgba(162,28,175,.85) 0%,
    rgba(126,34,206,.75) 50%,
    rgba(29,78,216,.75) 100%);
  opacity:.20; animation-delay:-2s;
}
html.dark #register-view .min-h-screen {
  background: transparent !important;
}
/* Ensure the login card sits above the blobs */
#login-view .min-h-screen .w-full.max-w-md,
#login-view .min-h-screen .glass-card,
#login-view .min-h-screen form,
#login-view .min-h-screen header,
#login-view .min-h-screen .card {
  position:relative; z-index:1;
}
</style>

<style>
.scroll-hint{
  position: fixed !important;
  left: 50% !important; transform: translateX(-50%) !important;
  bottom: 18px !important;
  z-index: 1050 !important; /* below theme toggle */
  opacity: 0; pointer-events: none;
  transition: opacity .25s ease;
}
.scroll-hint.is-visible{ opacity:1; pointer-events:auto; }
</style>

<style>
/* --- Final layering: page bg < blobs(0) < content(1) < theme-toggle --- */
#login-view .min-h-screen::before,
#login-view .min-h-screen::after{
  z-index: 0 !important; /* blobs stay visible but below content */
}
/* Elevate hero/logo/login card and any glass cards so they sit above blobs */
header,
#login-view .w-full.max-w-md,
#login-view .glass-card,
#login-view .hero-viewport,
#login-view .card,
#login-view .content,
#login-view .container,
#login-view h1, 
#login-view p,
#login-view img {
  position: relative;
  z-index: 1;
}
</style>

<style>
#bg-anim{opacity:0; transition: opacity .5s ease;}
body.glow-on #bg-anim{opacity:1;}
</style>


<style>
/* v6: hide bg-anim when not glowing */
body:not(.glow-on) #bg-anim{ display:none !important; opacity:0 !important; }
</style>

</head>
<body>

    <div id="bg-anim" style="display:none" aria-hidden="true"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

<div id="app">

        <div id="login-view" class="view active">
            <div class="min-h-screen bg-slate-100 flex flex-col justify-center items-center p-4">
                <div class="text-4xl font-bold text-gray-800 mb-2">Influence<span class="text-teal-500">AI</span></div>
                <p class="text-gray-600 mb-8">用 AI 預見行銷成效</p>
                <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-slate-800">登入您的帳號</h2>
                    <form id="login-form" class="space-y-4" onsubmit="return false;">
                        <div>
                            <label for="email" class="text-sm font-medium text-gray-700">電子郵件</label>
                            <input id="email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        </div>

                        <div>
                            <label for="password" class="text-sm font-medium text-gray-700">密碼</label>
                            <input id="password" name="password" type="password" autocomplete="current-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div class="text-right text-sm"> <a href="#" onclick="openModal('forgot-password-modal')" class="font-medium text-teal-600 hover:text-teal-500">
                                忘記密碼？
                            </a>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button type="button" onclick="handleLogin()" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 transition-colors">登入</button>
                            <button type="button" onclick="navigateTo('register-view')" class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition-colors">註冊新帳號</button>                        </div>
                        <div class="relative flex py-3 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-400 text-sm">或</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>

                        <button type="button" onclick="handleGoogleLogin()" class="w-full flex justify-center items-center bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 transition-colors">
                            <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                                <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.021,35.592,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                            </svg>
                            使用 Google 帳號登入
                        </button>
                    </form>

                </div>
            
                <!-- v18: scrolling marketing intro section (reference-style) -->
                
<div class="scroll-hint" onclick="(function(){
  var target = document.getElementById('intro') || document.querySelector('#login-view + #intro') || document.querySelector('[id*=intro]');
  if(target){ target.scrollIntoView({behavior:'smooth', block:'start'}); }
})()">
  <span class="chev" aria-hidden="true"></span> 向下捲動以瞭解更多
</div>

<div id="intro" class="intro-wrap">
                  <div class="hero-grid reveal">
                    <div>
                      <div class="badge">以 10× 效率，完成 100 位網紅的精準合作</div>
                      <h2 class="hero-title reveal" data-delay="40ms">讓「品牌需求 × 網紅供給」自動配對，<br/>不再用人力一個個對接。</h2>
                      <p class="hero-sub reveal" data-delay="80ms">InfluenceLink 使用資料爬取、AI 評估與透明計分，為商家找出「最合適、CP 值最高」的創作者；創作者只要連動平台，即可一鍵展現價值並接單。</p>
                      <div class="chips reveal" data-delay="120ms">
                        <span class="chip">YouTube</span>
                        <span class="chip">Instagram</span>
                        <span class="chip">Facebook</span>
                        <span class="chip">TikTok</span>
                        <span class="chip">小紅書</span>
                      </div>
                    </div>
                    <div class="glass-card reveal slide-left" style="padding:18px;" data-delay="150ms">
                      <img src="https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1200&auto=format&fit=crop" alt="demo" style="width:100%; border-radius:12px;" />
                      <div style="padding:10px 4px; color:#9aa3b2;">資料驅動的透明配對：分類、受眾、地區、CPM、互動率</div>
                    </div>
                  </div>

                  <div class="feature-grid">
                    <div class="glass-card feature-card reveal scale-in" data-delay="0ms">
                      <h3>商家：對話式建立需求</h3>
                      <p style="color:#9aa3b2;">用聊天框描述你的目標（如：曝光 10 萬、女性 25–34、台灣、美妝類），系統即時生成預算、建議平台、與預估成效。</p>
                    </div>
                    <div class="glass-card feature-card reveal scale-in" data-delay="120ms">
                      <h3>網紅：連動帳號 → 自動評估</h3>
                      <p style="color:#9aa3b2;">連接社群帳號後，即可看到「綜合價值分數」、報價建議與合作建議；可一鍵接單、管理合約與素材。</p>
                    </div>
                    <div class="glass-card feature-card reveal scale-in" data-delay="240ms">
                      <h3>平台：透明計分與抽成</h3>
                      <p style="color:#9aa3b2;">以類 Jaccard / 互動率 / CPM 適配度 / 地區與平台偏好等加權計分；接單成功平台收取 10–15% 抽成。</p>
                    </div>
                  </div>

                  <div class="glass-card cta-band reveal slide-right" data-delay="120ms">
                    <div>
                      <h3>準備好用 1 人完成過去 10 人才做得到的對接嗎？</h3>
                      <div style="color:#9aa3b2;">現在加入，立即體驗自動化配對流程。</div>
                    </div>
                    <button class="btn-primary" type="button" onclick="navigateTo('register-view')">免費註冊</button>
                  </div>
                </div>

        
        <!-- v22: AI Explainer section -->
        <section id="ai-explainer" class="intro-wrap" style="padding-top: 12vh;">
          <div class="reveal"><span class="badge">我們的 AI 怎麼幫你</span></div>
          <h2 class="hero-title reveal" data-delay="60ms">從「需求」→「配對」→「成效」全自動</h2>
          <p class="hero-sub reveal" data-delay="120ms">三個引擎協同運作：資料爬取與清理、適配度與報價模型、透明成效預估。你只要敘述目標，其餘交給模型。</p>

          <div class="feature-grid" style="margin-top: 18px;">
            <div class="glass-card feature-card reveal slide-right" data-delay="0ms">
              <h3>1) 資料引擎（Crawler + Clean）</h3>
              <p style="color:#9aa3b2;">跨平台收集創作者與受眾資料，做正規化、去重與風險檢測（買粉、異常互動）。輸出乾淨特徵，供模型使用。</p>
            </div>
            <div class="glass-card feature-card reveal scale-in" data-delay="120ms">
              <h3>2) 適配與報價（Match + Price）</h3>
              <p style="color:#9aa3b2;">以主題相似度、受眾重疊、地區與CPM曲線建模，輸出「配對分數」與建議報價；可針對預算自動最佳化組合。</p>
            </div>
            <div class="glass-card feature-card reveal slide-left" data-delay="240ms">
              <h3>3) 成效預估（Lift + Risk）</h3>
              <p style="color:#9aa3b2;">根據歷史轉換、互動、投放類型建立 uplift 預測，提供可信區間；自動標示風險與備選方案。</p>
            </div>
          </div>

          <div class="glass-card cta-band reveal" data-delay="160ms">
            <div>
              <h3>想看模型如何選人＋如何估價？</h3>
              <div style="color:#9aa3b2;">提供你的目標與預算，我們會輸出配對名單、預估成效與透明拆解。</div>
            </div>
            <button class="btn-primary" type="button" onclick="navigateTo('register-view')">立即試試</button>
          </div>
        </section>


                <!-- v23: Influencer Monetization Story -->
        <section id="influencer-story" class="intro-wrap" style="padding-top: 12vh;">
          <div class="reveal"><span class="kicker">我們如何幫助「網紅」賺到錢</span></div>
          <h2 class="hero-title reveal" data-delay="60ms"><span class="accent-underline">用 AI 把內容影響力<span class="brand-green">變現</span></span></h2>
          <p class="hero-sub reveal" data-delay="120ms">從被動等待合作 → 主動被推薦。系統會在你睡覺時替你跑資料、比對品牌需求、計算報價與預估成效，讓你<u>把時間花在創作</u>。</p>
          
          <!-- Flow Diagram -->
          <div class="glass-card reveal scale-in" data-delay="160ms" style="padding:20px;">
            <h3 class="mb-2">一條龍變現流程</h3>
            <div class="grid lg:grid-cols-5 md:grid-cols-3 grid-cols-1 gap-4 items-stretch">
              <div class="p-4 rounded-lg border brand-step"><h4>① 連動帳號</h4><p class="text-sm brand-muted">YouTube/IG/TikTok 等讀取公開數據</p></div>
              <div class="p-4 rounded-lg border brand-step"><h4>② 清理建模</h4><p class="text-sm brand-muted">去重/反作弊/受眾特徵提取</p></div>
              <div class="p-4 rounded-lg border brand-step"><h4>③ 適配配對</h4><p class="text-sm brand-muted">比對品牌目標與你的受眾</p></div>
              <div class="p-4 rounded-lg border brand-step"><h4>④ 智能報價</h4><p class="text-sm brand-muted">依類別/CPM 曲線與互動率</p></div>
              <div class="p-4 rounded-lg border brand-step"><h4>⑤ 合約&結算</h4><p class="text-sm brand-muted">素材上傳、里程碑、對帳</p></div>
            </div>
          </div>

          <!-- Tech Diagram (SVG) -->
          <div class="grid md:grid-cols-2 gap-6 mt-6">
            <div class="glass-card feature-card reveal slide-right" data-delay="0ms">
              <h3>技術：MatchAI 三引擎</h3>
              <svg viewBox="0 0 600 280" width="100%" height="180">
                <defs>
                  <linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#10b981"/><stop offset="1" stop-color="#0ea5a4"/></linearGradient>
                </defs>
                <rect x="12" y="30" width="180" height="60" rx="12" fill="url(#g1)" opacity="0.2"/>
                <text x="24" y="66" fill="#0f766e" font-size="14">資料引擎</text>
                <rect x="210" y="30" width="180" height="60" rx="12" fill="url(#g1)" opacity="0.2"/>
                <text x="222" y="66" fill="#0f766e" font-size="14">適配/報價</text>
                <rect x="408" y="30" width="180" height="60" rx="12" fill="url(#g1)" opacity="0.2"/>
                <text x="420" y="66" fill="#0f766e" font-size="14">成效預估</text>
                <path d="M192 60 L210 60 M390 60 L408 60" stroke="#0ea5a4" stroke-width="2"/>
                <rect x="12" y="130" width="576" height="120" rx="14" fill="none" stroke="#94a3b8" stroke-dasharray="6,6"/>
                <text x="24" y="156" fill="#475569" font-size="14">資料來源：平台 API / 公開貼文 / 互動 / 受眾</text>
                <text x="24" y="180" fill="#475569" font-size="14">推論：主題相似度、受眾重疊、地區、CPM、異常偵測</text>
                <text x="24" y="204" fill="#475569" font-size="14">輸出：配對名單、建議報價、預估轉換（含可信區間）</text>
              </svg>
            </div>
            <div class="glass-card feature-card reveal slide-left" data-delay="140ms">
              <h3>收益機制：公平、透明、可追蹤</h3>
              <ul class="list-disc pl-5 text-sm brand-muted">
                <li>成案抽成 10–15%（案型不同略有差異）</li>
                <li>平台提供「計分明細」：你知道為什麼自己被推薦／沒被推薦</li>
                <li>每案皆有里程碑與驗收，避免拖款與爭議</li>
              </ul>
              <img alt="收入示意" style="width:100%; border-radius:12px; margin-top:10px"
                   src="https://images.unsplash.com/photo-1553729459-efe14ef6055d?q=80&w=1200&auto=format&fit=crop"/>
            </div>
          </div>

          <!-- Storytelling -->
          <div class="glass-card cta-band reveal" data-delay="200ms" style="margin-top: 18px;">
            <div>
              <h3>故事：一位 5 萬粉的創作者</h3>
              <div class="brand-muted">她原本每月只接 1–2 案；啟用 InfluenceAI 後，系統主動推薦給符合她受眾的保養品牌，建議她調整報價與素材格式。三個月內，平均每月接 5 案，單案報酬提升 38%。</div>
            </div>
            <button class="btn-primary" type="button" onclick="navigateTo('register-view')">我也要開始變現</button>
          </div>
        </section>

</div>
        </div>
        
        <div id="register-view" class="view">
            <div class="min-h-screen bg-slate-100 flex flex-col justify-center items-center p-4">
                <div class="text-4xl font-bold text-gray-800 mb-2">Influence<span class="text-teal-500">AI</span></div>
                <p class="text-gray-600 mb-8">建立您的 AI 行銷帳號</p>
                
                <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-slate-800">註冊新帳號</h2>
                    <form id="register-form" class="space-y-4" onsubmit="return false;">
                        <div>
                            <label for="register-email" class="text-sm font-medium text-gray-700">電子郵件</label>
                            <input id="register-email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div>
                            <label for="register-password" class="text-sm font-medium text-gray-700">設定密碼</label>
                            <input id="register-password" name="password" type="password" autocomplete="new-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div>
                            <label for="register-password-confirm" class="text-sm font-medium text-gray-700">確認密碼</label>
                            <input id="register-password-confirm" name="password-confirm" type="password" autocomplete="new-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        
                        <div class="flex flex-col space-y-2 pt-2">
                            <button type="button" onclick="handlePerformRegistration()" class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition-colors">
                                建立帳號
                            </button>
                        </div>
                        
                        <div class="text-center text-sm text-gray-600">
                            已經有帳號了？
                            <a href="#" onclick="navigateTo('login-view')" class="font-medium text-teal-600 hover:text-teal-500">
                                點此登入
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <div id="role-selection-view" class="view">
            <div class="min-h-screen bg-slate-100 flex flex-col justify-center items-center p-4">
                <div class="text-4xl font-bold text-gray-800 mb-2">Influence<span class="text-teal-500">AI</span></div>
                <p class="text-gray-600 mb-8">用 AI 預見行銷成效</p>
                <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-slate-800">請選擇您的身分</h2>
                    <div class="flex flex-col space-y-4">
                        <button onclick="enterDashboard('merchant')" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 transition-colors">我是商家</button>
                        <button onclick="enterDashboard('influencer')" class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition-colors">我是網紅</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="merchant-dashboard-view" class="view">
            <div class="flex h-screen bg-slate-50">
                <div id="merchant-sidebar" class="w-64 bg-white shadow-md flex-shrink-0 fixed inset-y-0 left-0 z-30 transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0">
                    <div class="p-6 text-2xl font-bold text-gray-800 border-b">Influence<span class="text-teal-500">AI</span></div>
                    <nav class="mt-6">
                        <a href="#" onclick="switchTab('merchant', 'dashboard')" class="sidebar-link active block py-3 px-6 text-gray-600 font-semibold">總覽</a>
                        <a href="#" onclick="switchTab('merchant', 'campaigns')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">行銷活動</a>
                        <a href="#" onclick="switchTab('merchant', 'reports')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">成效報告</a>
                        <a href="#" onclick="switchTab('merchant', 'finance')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">財務管理</a>
                        <a href="#" onclick="switchTab('merchant', 'settings')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">設定</a>
                        <a href="#" onclick="handleLogout()" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold mt-10">登出</a>
                        <button onclick="navigateTo('role-selection-view')" class="mt-4 ml-4 text-sm text-teal-600 border border-teal-800 px-6 py-2 rounded hover:bg-teal-50">⇄ 切換身分</button>

                    </nav>
                </div>

                <div class="flex-1 flex flex-col overflow-hidden w-full">
                    <header class="flex justify-between items-center p-4 bg-white border-b flex-shrink-0">
                        <button onclick="toggleMenu('merchant')" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-800 z-40">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                                </svg>
                            </button>
                        <h1 id="merchant-header-title" class="text-2xl font-bold text-slate-800">總覽</h1>
                        <div class="flex items-center space-x-4">
                            <span id="user-email-display" class="text-gray-600"></span>
                            <button onclick="handleLogout()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 hidden">登出</button>
                        </div>
                    </header>

                    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-50 p-8">
<div id="merchant-dashboard-content" class="dashboard-content active">
    <div class="mb-8 flex justify-between items-end">
        <div>
            <h2 class="text-3xl font-bold text-slate-800">早安，<span id="m-dash-name">商家</span> 👋</h2>
            <p class="text-gray-500 mt-1">這是您目前的行銷活動概況</p>
        </div>
        <div class="text-right">
            <p class="text-sm text-gray-400" id="current-date">2023/10/24</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">進行中活動</h3>
            <p id="m-stat-active" class="text-3xl font-bold text-slate-800 mt-2">0</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow border-l-4 border-yellow-500">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">待審核網紅</h3>
            <p id="m-stat-pending" class="text-3xl font-bold text-slate-800 mt-2">0</p>
            <p class="text-xs text-yellow-600 mt-1">請盡快處理</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow border-l-4 border-green-500">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">累積總花費</h3>
            <p id="m-stat-spend" class="text-3xl font-bold text-slate-800 mt-2">NT$ 0</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow border-l-4 border-purple-500">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">總觸及人數 (預估)</h3>
            <p id="m-stat-reach" class="text-3xl font-bold text-slate-800 mt-2">0</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 bg-white rounded-xl shadow p-6">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <span class="w-2 h-6 bg-teal-500 rounded-full"></span> 待辦事項 (Action Items)
            </h3>
            <div id="m-action-list" class="space-y-3">
                <p class="text-gray-400 text-center py-4">目前沒有待辦事項 🎉</p>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 text-white shadow-lg">
                <h3 class="font-bold text-lg mb-2">發起新活動</h3>
                <p class="text-slate-400 text-sm mb-4">透過 AI 快速媒合適合的網紅人選。</p>
                <button onclick="openModal('new-campaign-modal')" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 rounded-lg transition">＋ 建立活動</button>
            </div>
            
            <div id="company-card" class="bg-white p-6 rounded-xl shadow hidden">
                <div class="flex items-start gap-4">
                    <img id="company-card-logo" class="w-14 h-14 rounded-lg object-cover bg-slate-100" src="" alt="">
                    <div class="flex-1">
                        <h3 id="company-card-name" class="text-xl font-bold text-slate-800"></h3>
                        <a id="company-card-website" class="text-teal-600 hover:underline text-sm" target="_blank"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                        
                        <div id="merchant-campaign-detail-content" class="dashboard-content"></div>

                        <div id="merchant-campaigns-content" class="dashboard-content">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-slate-800">所有行銷活動</h2>
                                <button onclick="openModal('new-campaign-modal')" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800 transition-colors flex items-center space-x-2">
                                <span>+</span>
                                <span>建立新活動</span>
                            </button>                           
                            </div>
                          
                            <div id="campaigns-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- v3: 活動卡片會由 renderCampaigns() 動態插入這裡 -->
                            </div>
                        </div>                        

                        <div id="merchant-reports-content" class="dashboard-content">
                            <div class="bg-white rounded-xl shadow p-6"><h3 class="font-bold text-slate-800 mb-4">曝光 & 點擊趨勢</h3><div class="h-80"><canvas id="performanceLineChart"></canvas></div></div>
                        </div>
                        
                        <!-- v2 (本次修改): 財務管理介面更新 -->
                        <div id="merchant-finance-content" class="dashboard-content">
                             <!-- 帳戶餘額：ID (finance-account-balance) 用於 JS 更新，預設為 0 -->
                             <div class="bg-white rounded-xl shadow p-6 mb-6">
                                 <h3 class="text-lg font-medium text-gray-500">帳戶餘額</h3>
                                 <p id="finance-account-balance" class="text-4xl font-bold text-slate-800 mt-2">NT$ 0</p>
                             </div>
                             
                             <div class="bg-white rounded-xl shadow p-8">
                                 <h2 class="text-xl font-bold text-slate-800 mb-4">線上儲值 (入金)</h2>
                                 
                                 <!-- 儲值方式按鈕：加上 ID 與 onclick -->
                                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                     <button id="btn-pay-bank" onclick="selectPaymentMethod('bank')" class="payment-btn border border-gray-300 p-4 rounded-lg font-semibold transition-all">
                                         銀行轉帳
                                     </button>
                                     <button id="btn-pay-card" onclick="selectPaymentMethod('card')" class="payment-btn border border-gray-300 p-4 rounded-lg font-semibold transition-all">
                                         信用卡
                                     </button>
                                     <button id="btn-pay-epay" onclick="selectPaymentMethod('epay')" class="payment-btn border border-gray-300 p-4 rounded-lg font-semibold transition-all">
                                         電子支付
                                     </button>
                                 </div>
                                 
                                 <!-- 銀行轉帳詳細資訊：預設隱藏 -->
                                 <div id="bank-transfer-details" class="hidden space-y-6 border-t pt-6">
                                     <div>
                                         <h3 class="text-lg font-semibold text-slate-800">匯款帳戶資訊</h3>
                                         <p class="text-sm text-gray-600">請匯款至以下帳戶，並上傳您的匯款截圖或收據照片，我們將在 1-2 個工作天內為您加值。</p>
                                         <div class="mt-3 bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-1">
                                             <p><strong>銀行：</strong> xx銀行 (007)</p>
                                             <p><strong>戶名：</strong> MatchAI、xx科技、林頌宜帳戶</p>
                                             <p><strong>帳號：</strong> 123-456-789012</p>
                                         </div>
                                     </div>

                                     <div>
                                         <label for="transfer-amount" class="block text-sm font-medium text-gray-700">您的匯款金額 (NT$)</label>
                                         <input type="number" id="transfer-amount" placeholder="請輸入您實際匯款的金額" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                     </div>

                                     <div>
                                         <label for="transfer-proof-file" class="block text-sm font-medium text-gray-700">上傳匯款截圖/照片</label>
                                         <input type="file" id="transfer-proof-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                                     </div>
                                     
                                     <div class="flex items-center gap-3">
                                          <button id="submit-transfer-proof-btn" onclick="handleSubmitTransferProof()" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 transition-colors">
                                              提交匯款證明
                                          </button>
                                          <progress id="transfer-upload-progress" value="0" max="100" class="w-full hidden"></progress>
                                     </div>
                                     <span id="transfer-upload-status" class="text-sm text-center block text-gray-600"></span>
                                 </div>
                             </div>
                        </div>
                        <!-- v2 修改結束 -->


                        <div id="merchant-settings-content" class="dashboard-content">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 表單 -->
    <div class="bg-white rounded-xl shadow p-8 lg:col-span-2">
      <h2 class="text-xl font-bold text-slate-800 mb-6">公司設定</h2>
      <form id="company-form" class="space-y-5" onsubmit="return false;">
        <div>
          <label class="block text-sm font-medium text-gray-700">公司名稱</label>
          <input id="company-name" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例：InfluenceAI Inc.">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">統一編號</label>
            <input id="company-regno" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例：12345678">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">聯絡電話</label>
            <input id="company-phone" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例：02-1234-5678">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">公司地址</label>
          <input id="company-address" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例：台北市大安區…">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">公司官網</label>
          <input id="company-website" type="url" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="https://example.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Logo 圖片 URL</label>
          <input id="company-logo" type="url" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="https://…/logo.png">
          <p class="text-xs text-gray-500 mt-1">你也可以直接上傳檔案（如下），完成後會自動填入這個欄位。</p>
        </div>
        <div class="mt-3">
          <label class="block text-sm font-medium text-gray-700">或上傳 Logo 檔案</label>
          <input id="company-logo-file" type="file" accept="image/*" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
          <div class="flex items-center gap-3 mt-2">
            <button id="upload-logo-btn" type="button" class="bg-teal-600 text-white font-semibold py-1.5 px-3 rounded hover:bg-teal-700" onclick="uploadCompanyLogo()">上傳 Logo</button>
            <progress id="logo-upload-progress" value="0" max="100" class="w-40"></progress>
            <span id="logo-upload-status" class="text-xs text-gray-600"></span>
          </div>
          <p class="text-xs text-gray-500 mt-1">上傳完成後，會自動把下載連結填入上面的「Logo 圖片 URL」。</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">公司描述</label>
          <textarea id="company-desc" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="簡述你的品牌與產品…"></textarea>
        </div>
        <div class="flex gap-3 pt-2">
          <button id="company-save-btn" type="button" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800" onclick="handleSaveCompany()">儲存</button>
          <button class="bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200" onclick="resetCompanyForm()">重設</button>
          <span id="company-save-hint" class="text-sm text-gray-500 self-center hidden">已儲存！</span>
        </div>
      </form>
    </div>

    <!-- 預覽 -->
    <div class="bg-white rounded-xl shadow p-8">
      <h3 class="font-bold text-slate-800 mb-4">即時預覽</h3>
      <div id="company-preview" class="border rounded-lg p-4 flex items-start gap-4">
        <img id="company-preview-logo" class="w-16 h-16 rounded-lg object-cover bg-slate-100" src="" alt="">
        <div>
          <div id="company-preview-name" class="text-lg font-bold text-slate-800">（尚未設定）</div>
          <div id="company-preview-lines" class="text-sm text-gray-600 space-y-0.5">
            <div id="preview-line-phone"></div>
            <div id="preview-line-address"></div>
            <a id="preview-line-website" class="text-teal-600 hover:underline" target="_blank" rel="noopener"></a>
          </div>
          <p id="company-preview-desc" class="text-sm text-gray-600 mt-2"></p>
        </div>
      </div>
    </div>
  </div>
</div></div>
                    </main>
                </div>
            </div>
         <div id="merchant-sidebar-overlay" onclick="toggleMenu('merchant')" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        </div>

        
        <div id="influencer-dashboard-view" class="view">
             <div class="flex h-screen bg-slate-50">
                <div id="influencer-sidebar" class="w-64 bg-white shadow-md flex-shrink-0 fixed inset-y-0 left-0 z-30 transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0">
                    <div class="p-6 text-2xl font-bold text-gray-800 border-b">Influence<span class="text-teal-500">AI</span></div>
                    <nav class="mt-6">
                        <a href="#" onclick="switchTab('influencer', 'dashboard')" class="sidebar-link active block py-3 px-6 text-gray-600 font-semibold">總覽</a>
                        <a href="#" onclick="switchTab('influencer', 'value')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">我的價值</a>
                        <a href="#" onclick="switchTab('influencer', 'invitations')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">合作邀請</a>
                        <a href="#" onclick="switchTab('influencer', 'finance')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">財務管理</a>
                        <a href="#" onclick="switchTab('influencer', 'settings')" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold">設定</a>
                        <a href="#" onclick="handleLogout()" class="sidebar-link block py-3 px-6 text-gray-600 font-semibold mt-10">登出</a>
                        <button onclick="navigateTo('role-selection-view')" class="mt-4 ml-4 text-sm text-teal-600 border border-teal-800 px-6 py-2 rounded hover:bg-teal-50">⇄ 切換身分</button>
                    </nav>
                </div>

                
                <div class="flex-1 flex flex-col overflow-hidden w-full">
                    
                    <header class="flex justify-between items-center p-4 bg-white border-b flex-shrink-0">
                        <button onclick="toggleMenu('influencer')" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-800 z-40">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                             </svg>
                         </button>

                        <h1 id="influencer-header-title" class="text-2xl font-bold text-slate-800">總覽</h1>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-600"></span>
                            <button onclick="handleLogout()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 hidden">登出</button>
                        </div>
                    </header>

                    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-50 p-8">
                        <div id="influencer-dashboard-content" class="dashboard-content active">
    <div id="inf-dashboard-card-container" class="bg-white rounded-xl shadow p-6 mb-8 flex flex-col md:flex-row items-center gap-6">
        <div class="relative">
            <img id="dash-inf-avatar" src="https://placehold.co/100" class="w-24 h-24 rounded-full object-cover border-4 border-slate-50 shadow-md">
            <div class="absolute bottom-0 right-0 bg-green-500 w-6 h-6 rounded-full border-4 border-white" title="Active"></div>
        </div>
        <div class="flex-1 text-center md:text-left">
            <h2 id="dash-inf-name" class="text-2xl font-bold text-slate-800">歡迎回來</h2>
            <p id="dash-inf-bio" class="text-gray-500 text-sm mt-1 line-clamp-1">正在載入個人資料...</p>
            <div class="flex gap-2 justify-center md:justify-start mt-3">
                <span class="px-3 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-600">🔥 活躍創作者</span>
                <span class="px-3 py-1 bg-teal-50 text-teal-700 rounded-full text-xs font-bold" id="dash-collab-count">合作 0 次</span>
            </div>
        </div>
        <button onclick="switchTab('influencer', 'settings')" class="text-sm text-gray-500 border px-4 py-2 rounded hover:bg-gray-50">編輯檔案</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow border-t-4 border-teal-500">
            <p class="text-gray-500 text-xs font-bold uppercase">本月預估收益</p>
            <p id="inf-stat-income" class="text-3xl font-bold text-slate-800 mt-2">NT$ 0</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow border-t-4 border-blue-500">
            <p class="text-gray-500 text-xs font-bold uppercase">進行中合作</p>
            <p id="inf-stat-active" class="text-3xl font-bold text-slate-800 mt-2">0</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow border-t-4 border-purple-500">
            <p class="text-gray-500 text-xs font-bold uppercase">綜合價值分數</p>
            <p id="inf-stat-score" class="text-3xl font-bold text-slate-800 mt-2">--</p>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">進行中的工作 (Active Jobs)</h3>
        <div id="influencer-active-jobs-list" class="space-y-6">
            <p class="text-gray-500 text-center py-8">目前沒有進行中的工作</p>
        </div>
    </div>
</div>
                        <div id="influencer-value-content" class="dashboard-content">
    
    <div class="bg-white rounded-xl shadow p-6 mb-8">
        <h3 class="text-xl font-bold text-slate-800 mb-4">連結社交平台帳戶</h3>
        <p class="text-gray-500 text-sm mb-6">連結後，系統將自動分析您的粉絲輪廓與互動數據，為您生成「價值報告」並推薦更適合的廠商。</p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="border rounded-xl p-4 flex items-center justify-between hover:shadow-md transition bg-slate-50" id="card-connect-ig">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 text-white flex items-center justify-center text-xl"><i class="fab fa-instagram"></i></div>
                    <div>
                        <p class="font-bold text-slate-700">Instagram</p>
                        <p class="text-xs text-gray-400" id="status-ig">尚未連結</p>
                    </div>
                </div>
                <button onclick="connectInstagram()" class="..." id="btn-connect-ig">
                    真實連結 IG
                </button>
            </div>

            <div class="border rounded-xl p-4 flex items-center justify-between hover:shadow-md transition bg-slate-50" id="card-connect-yt">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-red-600 text-white flex items-center justify-center text-xl"><i class="fab fa-youtube"></i></div>
                    <div>
                        <p class="font-bold text-slate-700">YouTube</p>
                        <p class="text-xs text-gray-400" id="status-yt">尚未連結</p>
                    </div>
                </div>
                <button onclick="simulateConnect('yt')" class="text-xs bg-white border border-gray-300 px-3 py-1.5 rounded-lg font-bold text-slate-600 hover:bg-slate-100" id="btn-connect-yt">連結</button>
            </div>

            <div class="border rounded-xl p-4 flex items-center justify-between hover:shadow-md transition bg-slate-50" id="card-connect-tt">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center text-xl"><i class="fab fa-tiktok"></i></div>
                    <div>
                        <p class="font-bold text-slate-700">TikTok</p>
                        <p class="text-xs text-gray-400" id="status-tt">尚未連結</p>
                    </div>
                </div>
                <button onclick="simulateConnect('tt')" class="text-xs bg-white border border-gray-300 px-3 py-1.5 rounded-lg font-bold text-slate-600 hover:bg-slate-100" id="btn-connect-tt">連結</button>
            </div>

            <div class="border rounded-xl p-4 flex items-center justify-between hover:shadow-md transition bg-slate-50" id="card-connect-fb">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center text-xl"><i class="fab fa-facebook-f"></i></div>
                    <div>
                        <p class="font-bold text-slate-700">Facebook</p>
                        <p class="text-xs text-gray-400" id="status-fb">尚未連結</p>
                    </div>
                </div>
                <button onclick="simulateConnect('fb')" class="text-xs bg-white border border-gray-300 px-3 py-1.5 rounded-lg font-bold text-slate-600 hover:bg-slate-100" id="btn-connect-fb">連結</button>
            </div>
        </div>
    </div>

    <div id="analytics-dashboard" class="hidden space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                <p class="text-indigo-100 text-sm font-bold uppercase">AI 綜合影響力分數</p>
                <div class="flex items-end gap-2 mt-2">
                    <span class="text-5xl font-extrabold" id="score-val">85</span>
                    <span class="text-lg text-indigo-200 mb-1">/ 100</span>
                </div>
                <p class="text-xs text-indigo-200 mt-2">超越了 72% 的同類創作者</p>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6 flex flex-col justify-center items-center">
                <p class="text-gray-500 text-xs font-bold uppercase mb-2">總粉絲數 (Total Fans)</p>
                <p class="text-3xl font-bold text-slate-800" id="total-fans">0</p>
                <p class="text-green-500 text-xs mt-1">↑ 2.4% last 30 days</p>
            </div>

            <div class="bg-white rounded-xl shadow p-6 flex flex-col justify-center items-center">
                <p class="text-gray-500 text-xs font-bold uppercase mb-2">平均互動率 (Avg. ER)</p>
                <p class="text-3xl font-bold text-slate-800" id="avg-er">0%</p>
                <p class="text-green-500 text-xs mt-1">表現優異</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="font-bold text-slate-800 mb-4">粉絲成長趨勢 (Follower Growth)</h3>
                <div class="h-64"><canvas id="chart-followers"></canvas></div>
            </div>
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="font-bold text-slate-800 mb-4">受眾年齡分佈 (Demographics)</h3>
                <div class="h-64"><canvas id="chart-demo"></canvas></div>
            </div>
        </div>
    </div>
</div>
                        <div id="influencer-invitations-content" class="dashboard-content">
                          <h2 class="text-xl font-bold text-slate-800 mb-6">合作邀請 (新活動)</h2>
                          <div id="influencer-invitations-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <p class="text-gray-500">目前沒有新的合作邀請。</p>
                          </div>
                        </div>
<div id="influencer-finance-content" class="dashboard-content">
    <div class="bg-white rounded-xl shadow p-6 mb-6 border-l-4 border-green-500">
        <h3 class="text-lg font-medium text-gray-500">目前可提領金額 (未稅)</h3>
        <p id="inf-balance-display" class="text-4xl font-bold text-slate-800 mt-2">NT$ 0</p>
        <p class="text-xs text-gray-400 mt-1">※ 此金額由系統根據您已完成的案件自動計算</p>
    </div>

    <div class="bg-white rounded-xl shadow p-8">
        <h2 class="text-xl font-bold text-slate-800 mb-4">申請提領 (出金)</h2>
        <div class="space-y-5 bg-slate-50 p-6 rounded-lg">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">提領銀行</label>
                    <select id="inf-withdraw-bank" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">請選擇銀行</option>
                        <option value="822">中國信託 (822)</option>
                        <option value="013">國泰世華 (013)</option>
                        <option value="700">中華郵政 (700)</option>
                        <option value="004">台灣銀行 (004)</option>
                        <option value="812">台新銀行 (812)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">銀行帳號</label>
                    <input id="inf-withdraw-account" type="text" placeholder="請輸入存摺帳號" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">提領金額 (NT$)</label>
                <input id="inf-withdraw-amount" type="number" placeholder="最低提領單位為 1,000 元" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                <p class="text-xs text-red-500 mt-1">* 提領金額必須是 1,000 的倍數，且不得大於可提領餘額。</p>
            </div>

            <button onclick="handleInfluencerWithdraw()" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors shadow-lg">
                確認送出提領申請
            </button>
        </div>
    </div>
</div>

<div id="influencer-settings-content" class="dashboard-content">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow p-8 lg:col-span-2">
            <h2 class="text-xl font-bold text-slate-800 mb-6">網紅個人資料設定</h2>
            <form id="influencer-profile-form" class="space-y-5" onsubmit="return false;">
                
                <div class="flex items-center gap-4">
                    <div class="shrink-0">
                        <img id="inf-avatar-preview-form" class="h-16 w-16 object-cover rounded-full border border-gray-200" src="https://placehold.co/100?text=Avatar" alt="Avatar">
                    </div>
                    <label class="block">
                        <span class="sr-only">選擇大頭貼</span>
                        <input type="file" id="inf-avatar-file" accept="image/*" class="block w-full text-sm text-slate-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-full file:border-0
                          file:text-sm file:font-semibold
                          file:bg-teal-50 file:text-teal-700
                          hover:file:bg-teal-100
                        "/>
                    </label>
                    <button type="button" onclick="uploadInfluencerAvatar()" class="text-xs bg-slate-200 px-3 py-1 rounded hover:bg-slate-300">上傳</button>
                    <span id="inf-upload-status" class="text-xs text-gray-500"></span>
                </div>
                <input type="hidden" id="inf-avatar-url">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">名字/暱稱</label>
                        <input id="inf-name" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">聯絡 Email (公開)</label>
                        <input id="inf-contact-email" type="email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="＠gmail.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">電話</label>
                        <input id="inf-name" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例：02-1234-5678">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">公關品配送地址</label>
                        <input id="inf-name" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例：台北市大安區…">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">個人簡介 / 風格描述</label>
                    <textarea id="inf-bio" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
                </div>

                <div class="border-t pt-4">
                    <h3 class="font-bold text-gray-700 mb-3">社交平台帳號連結</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs text-gray-500">Instagram ID</label>
                            <input id="inf-ig" type="text" placeholder="@username" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">facebook ID</label>
                            <input id="inf-yt" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">TikTok ID</label>
                            <input id="inf-tt" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-4">
                    <button onclick="handleSaveInfluencerProfile()" class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700">儲存設定</button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-xl shadow p-8">
            <h3 class="font-bold text-slate-800 mb-4">總覽卡片預覽</h3>
            <div id="inf-card-preview" class="border rounded-xl p-6 flex flex-col items-center text-center bg-white shadow-sm">
                <img id="inf-card-avatar" src="https://placehold.co/100?text=Avatar" class="w-24 h-24 rounded-full object-cover mb-4 border-4 border-slate-50">
                <h3 id="inf-card-name" class="text-xl font-bold text-slate-800">（尚未設定暱稱）</h3>
                <p id="inf-card-email" class="text-sm text-gray-500 mb-4">email@example.com</p>
                
                <div class="flex justify-center gap-3 mb-4">
                    <span id="badge-ig" class="hidden px-2 py-1 bg-pink-100 text-pink-700 text-xs rounded-full">IG</span>
                    <span id="badge-yt" class="hidden px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full">facebook ID</span>
                    <span id="badge-tt" class="hidden px-2 py-1 bg-black text-white text-xs rounded-full">TikTok</span>
                </div>

                <p id="inf-card-bio" class="text-sm text-gray-600 line-clamp-3">（個人簡介將顯示於此...）</p>
            </div>
        </div>
    </div>
</div>



                    </main>
                </div>
            </div>
        <div id="influencer-sidebar-overlay" onclick="toggleMenu('influencer')" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        </div>

        <div id="new-campaign-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col h-[90vh] transform scale-95 transition-transform duration-300">
        
        <div class="p-5 border-b flex justify-between items-center flex-shrink-0">
            <h2 class="text-xl font-bold text-slate-800">建立新的行銷需求</h2>
            <button onclick="closeModal('new-campaign-modal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>

        <form id="campaign-form" class="flex-1 flex flex-col overflow-hidden" onsubmit="event.preventDefault(); handleSaveBrief();">
            
            <div class="flex-1 p-6 overflow-y-auto space-y-6">
                <div>
                    <label for="brief-product-name" class="block text-sm font-medium text-gray-700">產品名稱</label>
                    <input type="text" id="brief-product-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例如：我的酷炫無線耳機">
                </div>
                <div class="mt-4">
                    <label for="brief-category" class="block text-sm font-medium text-gray-700">產品類別</label>
                    <select id="brief-category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        <option value="一般">一般</option>
                        <option value="美妝保養">美妝保養</option>
                        <option value="3C科技">3C科技</option>
                        <option value="美食旅遊">美食旅遊</option>
                    </select>
                </div>
                <div>
                    <label for="brief-product-desc" class="block text-sm font-medium text-gray-700">產品描述與特色</label>
                    <textarea id="brief-product-desc" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="描述您的產品，以及希望網紅強調的賣點"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="brief-impressions" class="block text-sm font-medium text-gray-700">預期曝光次數</label>
                        <input type="number" id="brief-impressions" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例如：100000">
                    </div>
                    <div>
                        <label for="brief-budget" class="block text-sm font-medium text-gray-700">預算範圍 (NT$)</label>
                        <input type="number" id="brief-budget" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例如：50000">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="brief-influencer-count" class="block text-sm font-medium text-gray-700">希望網紅數量</label>
                        <input type="number" id="brief-influencer-count" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="例如：10">
                    </div>
                    <div>
                        <label for="brief-follower-range" class="block text-sm font-medium text-gray-700">網紅粉絲數區間</label>
                        <select id="brief-follower-range" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            <option>不限</option>
                            <option>1萬 - 5萬</option>
                            <option>5萬 - 10萬</option>
                            <option>10萬以上</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">希望發布平台</label>
                    <div id="brief-platforms" class="mt-2 flex flex-wrap gap-4">
                        <label class="inline-flex items-center"><input type="checkbox" value="Instagram" class="rounded border-gray-300"> <span class="ml-2">Instagram</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" value="YouTube" class="rounded border-gray-300"> <span class="ml-2">YouTube</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" value="Facebook" class="rounded border-gray-300"> <span class="ml-2">Facebook</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" value="TikTok" class="rounded border-gray-300"> <span class="ml-2">TikTok</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" value="XiaoHongShu" class="rounded border-gray-300"> <span class="ml-2">小紅書</span></label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">上傳行銷素材(圖片或影片，可多選)</label>
                    <input type="file" id="campaign-images" multiple accept="image/*,video/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                    
                    <div class="flex items-center gap-3 mt-3">
                        <button type="button" id="upload-images-btn" onclick="handleUploadCampaignImages()" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700">
                            上傳選取的圖片
                        </button>
                        <span id="upload-status-text" class="text-sm text-gray-600"></span>
                    </div>
                    
                    <div id="image-preview-area" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                        </div>
                    <progress id="upload-progress-bar" value="0" max="100" class="w-full mt-2 hidden"></progress>
                </div>
                </div> <div class="p-5 border-t bg-slate-50 flex-shrink-0">
                <button type="submit" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 transition-colors">
                    儲存需求並開始配對
                </button>
            </div>
            
        </form> </div>
</div>




        <div id="ai-chat-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col h-[70vh] transform scale-95 transition-transform duration-300"><div class="p-4 border-b flex justify-between items-center"><h2 class="text-lg font-bold text-slate-800">AI 行銷顧問</h2><button onclick="closeAIChat()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4"></div><div class="p-4 border-t"><div class="flex space-x-2"><input id="chat-input" type="text" class="flex-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="請輸入您的回覆..."><button onclick="sendChatMessage()" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800">發送</button></div></div></div></div>
        <div id="platform-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0">
          <div id="platform-detail-content" class="bg-slate-50 rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col transform scale-95 transition-transform duration-300">           
          </div>
        </div>


        <div id="platform-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0">
            <div id="platform-detail-content" class="bg-slate-50 rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col transform scale-95 transition-transform duration-300"></div>
        </div>

        <div id="brief-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl flex flex-col h-[85vh] transform scale-95 transition-transform duration-300">
                <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                    <h2 id="modal-brief-title" class="text-2xl font-bold text-slate-800">活動標題</h2>
                    <button onclick="closeModal('brief-detail-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div class="flex-1 p-6 overflow-y-auto space-y-6">
                    <div class="flex gap-2 flex-wrap" id="modal-brief-tags"></div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-2">商家需求描述</h3>
                        <p id="modal-brief-desc" class="text-gray-700 whitespace-pre-wrap"></p>
                    </div>

                    <div>
                        <h3 class="font-bold text-slate-800 mb-3 text-lg border-l-4 border-teal-500 pl-3">行銷素材與參考資料</h3>
                        <div id="modal-brief-assets" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-6">
                        <div class="text-center p-3 bg-slate-50 rounded">
                            <p class="text-xs text-gray-500">預算</p>
                            <p id="modal-brief-budget" class="font-bold text-teal-600 text-xl"></p>
                        </div>
                        <div class="text-center p-3 bg-slate-50 rounded">
                            <p class="text-xs text-gray-500">需求人數</p>
                            <p id="modal-brief-count" class="font-bold text-slate-700 text-xl"></p>
                        </div>
                        <div class="text-center p-3 bg-slate-50 rounded">
                            <p class="text-xs text-gray-500">平台</p>
                            <p id="modal-brief-platform" class="font-bold text-slate-700 text-sm mt-1"></p>
                        </div>
                    </div>
                </div>
                <div class="p-5 border-t bg-slate-50 flex justify-end gap-3 rounded-b-xl">
                    <button onclick="closeModal('brief-detail-modal')" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold">關閉</button>
                    <button id="modal-btn-accept" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-bold hidden">確認接單</button>
                </div>
            </div>
        </div>
    </div>

    <div id="merchant-review-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300 p-6 flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold text-slate-800 mb-4" id="review-modal-title">審核操作</h3>
            
            <div class="flex-1 overflow-y-auto space-y-4 pr-2">
                <div id="review-change-area" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">修改建議 (文字)</label>
                        <textarea id="review-comment" rows="3" class="w-full border border-gray-300 rounded p-2 focus:ring-teal-500 focus:border-teal-500" placeholder="請具體說明需要修改的地方..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">參考素材 (圖片或影片，可多選)</label>
                        <input type="file" id="review-file" multiple accept="image/*,video/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200" onchange="previewReviewFiles()">
                    </div>

                    <div id="review-files-preview" class="grid grid-cols-3 gap-2"></div>
                </div>

                <p id="review-confirm-text" class="text-gray-600 mb-6 hidden"></p>
            </div>

            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button onclick="closeModal('merchant-review-modal')" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 font-bold text-gray-600">取消</button>
                <button id="btn-confirm-review" class="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-900 font-bold">確認送出</button>
            </div>
        </div>
    </div>


    <div id="forgot-password-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50 opacity-0">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300">
                <div class="p-5 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800">重設您的密碼</h2>
                    <button onclick="closeModal('forgot-password-modal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-gray-600">請輸入您註冊時使用的電子郵件，我們將會寄送一封密碼重設信件給您。</p>
                    <form id="forgot-password-form" onsubmit="return false;">
                        <div>
                            <label for="forgot-email" class="text-sm font-medium text-gray-700">電子郵件</label>
                            <input id="forgot-email" type="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        </div>
                    </form>
                </div>
                <div class="p-5 border-t bg-slate-50">
                    <button onclick="handleForgotPassword()" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-800 transition-colors">
                        寄送重設信件
                    </button>
                </div>
            </div>
        </div>

    <!-- 
      v2 (本次修改): 
      - 在主要的 script module 中，同時 import storage 相關功能
      - 這是為了讓後續新增的 handleSubmitTransferProof 函式可以順利運作
    -->
    <script type="module">
    // --- v2 (本次修改): 從 firebase/storage 匯入必要功能 ---
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js';

    // --- 1. Firebase 初始化 (這部分不變) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            GoogleAuthProvider, 
            signInWithRedirect, 
            getRedirectResult,
            signInWithPopup,
            sendPasswordResetEmail,
            FacebookAuthProvider
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    // === 修改部分 START：從 Firestore 匯入更多我們需要的功能 ===
        import { 
            getFirestore, 
            collection, 
            addDoc,
            query,
            where,
            getDocs,
            doc,
            getDoc,
            setDoc,
            updateDoc,       // 新增：用於更新文件 (例如：軟刪除)
            onSnapshot,      // 新增：用於即時監聽資料變化
            orderBy,       // 新增：用於排序查詢結果
            serverTimestamp,   // ⬅️ 新增
            limit
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

      let influencerSelectedFiles = {};



    // === 新增：執行註冊的函式 (給 register-view 使用) ===
        window.handlePerformRegistration = async function() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;

            if (!email || !password || !confirmPassword) {
                alert('請填寫所有欄位！');
                return;
            }
            if (password !== confirmPassword) {
                alert('兩次輸入的密碼不一致！');
                return;
            }
            if (password.length < 6) {
                alert('密碼長度至少需要 6 個字元。');
                return;
            }

            try {
                // 使用我們匯入的 createUserWithEmailAndPassword
                await createUserWithEmailAndPassword(auth, email, password);
                alert('註冊成功！將為您導向登入頁面。');
                navigateTo('login-view'); // 註冊成功後跳回登入頁
                document.getElementById('register-form').reset(); // 清空註冊表單
                document.getElementById('email').value = email; // 貼心地幫使用者填上 email
            } catch (error) {
                console.error("註冊失敗:", error);
                if (error.code === 'auth/email-already-in-use') {
                    alert('註冊失敗：這個 Email 已經被註冊了。');
                } else {
                    alert('註冊失敗：' + error.message);
                }
            }
        };

        // === 新增：處理忘記密碼的函式 ===
        window.handleForgotPassword = async function() {
            const email = document.getElementById('forgot-email').value;
            if (!email) {
                alert('請輸入您的電子郵件！');
                return;
            }

            try {
                // 使用我們匯入的 sendPasswordResetEmail
                await sendPasswordResetEmail(auth, email);
                alert('密碼重設信件已寄出，請檢查您的信箱 (包含垃圾郵件匣)。');
                closeModal('forgot-password-modal');
                document.getElementById('forgot-password-form').reset();
            } catch (error) {
                console.error("寄送重設信件失敗:", error);
                if (error.code === 'auth/user-not-found') {
                    alert('寄送失敗：找不到使用這個 Email 註冊的用戶。');
                } else {
                    alert('寄送失敗：' + error.message);
                }
            }
        };    
    // === 修改部分 END ===

        const firebaseConfig = {
          apiKey: "AIzaSyCtOwoKYJfrSshSfkipfMH9lTngRsfQLDc",
          authDomain: "influenceai.tw ",
          projectId: "test-b493a",
          //storageBucket: "test-b493a.appspot.com",
          storageBucket: "test-b493a.firebasestorage.app",
          messagingSenderId: "1089014108157",
          appId: "1:1089014108157:web:2ac36c728f861795909394",
          measurementId: "G-1GY922PWL9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth; // expose for console
        const db = getFirestore(app);
        const storage = getStorage(app); // v2 (本次修改): 初始化 Storage

        // v3 (新功能): 用於暫存 "建立新活動" 時上傳的圖片 URL
        let uploadedImageUrls = []; 

        getRedirectResult(auth)
            .then((result) => {
                if (result) {
                    console.log('Google 重新導向登入成功:', result.user);
                }
            }).catch((error) => {
                console.error('Google 重新導向失敗:', error);
                alert('Google 登入時發生錯誤：' + error.message);
            });

/* 功能：在單頁應用（SPA）中切換 .view 區塊的顯示狀態，並回到頁面頂部。*/
    // --- 2. 核心 UI 導航與控制函式 ---
        function navigateTo(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            }
            window.scrollTo(0, 0);
        }

        const headerTitles = {
            merchant: { dashboard: '總覽', campaigns: '行銷活動', reports: '成效報告', finance: '財務管理', settings: '設定' },
            influencer: { dashboard: '總覽', value: '我的價值', invitations: '合作邀請', finance: '財務管理', settings: '設定' }
        };
    
// === 修改後的 switchTab (切換分頁時，順便載入資料) ===
    window.switchTab = function(role, tabId) {
        // 1. 處理側邊欄按鈕樣式 (Active 狀態)
        const sidebarLinks = document.querySelectorAll(`#${role}-dashboard-view .sidebar-link`);
        sidebarLinks.forEach(link => {
            link.classList.remove('active');
            // 特殊處理：如果是詳情頁 (campaign-detail)，側邊欄維持在 'campaigns' 亮起
            const linkTab = tabId === 'campaign-detail' ? 'campaigns' : tabId;
            // 檢查 onclick 屬性是否包含目標 tab
            if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`'${linkTab}'`)) {
                link.classList.add('active');
            }
        });

        // 2. 處理內容區塊顯示 (隱藏其他，顯示目前的)
        const contents = document.querySelectorAll(`#${role}-dashboard-view .dashboard-content`);
        contents.forEach(content => content.classList.remove('active'));
        
        const activeContent = document.getElementById(`${role}-${tabId}-content`);
        if (activeContent) activeContent.classList.add('active');
    
        // 3. 更新頁面標題 (Header Title)
        const headerTitle = document.getElementById(`${role}-header-title`);
        // 確保 headerTitles 物件存在 (這是全域變數)
        if (typeof headerTitles !== 'undefined' && headerTitles[role] && headerTitles[role][tabId]) {
            headerTitle.textContent = headerTitles[role][tabId];
        }

        // ==========================================
        // NEW: 這裡就是新增的邏輯！
        // 當切換到特定分頁時，自動觸發資料載入函式
        // ==========================================
        if (role === 'influencer') {
            if (tabId === 'invitations') {
                // 如果切換到「合作邀請」，就去資料庫撈邀請
                if (typeof renderInfluencerInvitations === 'function') {
                    renderInfluencerInvitations();
                }
            } else if (tabId === 'dashboard') {
                // 如果切換到「總覽」，就去資料庫撈進行中的工作
                if (typeof renderInfluencerActiveJobs === 'function') {
                    renderInfluencerActiveJobs();
                }
            }
        }
    };


    window.toggleMenu = function(role) {
        const sidebar = document.getElementById(`${role}-sidebar`);
        const overlay = document.getElementById(`${role}-sidebar-overlay`);
        if (sidebar) sidebar.classList.toggle('-translate-x-full');
        if (overlay) overlay.classList.toggle('hidden');
    };
    
    // 確保 navigateTo 也有被掛載 (保留原本邏輯)
    window.navigateTo = navigateTo;



        window.openModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('div > div').classList.remove('scale-95');
                }, 10);
            }
/* 功能：關閉對話框（加回 opacity-0 / scale-95，結束後加回 hidden）。*/
        }
        
        // === v3 (新功能): 修改 closeModal，使其在關閉 "new-campaign-modal" 時清空暫存 ===
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.add('opacity-0');
                modal.querySelector('div > div').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    
                    // v3: 清空 "建立新活動" 表單的暫存資料
                    if (modalId === 'new-campaign-modal') {
                        uploadedImageUrls = []; // 清空 URL 陣列
                        document.getElementById('image-preview-area').innerHTML = ''; // 清空預覽
                        document.getElementById('upload-status-text').textContent = ''; // 清空狀態
                        document.getElementById('upload-progress-bar').classList.add('hidden'); // 隱藏進度條
                        document.getElementById('campaign-form').reset(); // 重設表單
                    }
                }, 300);
            }
        }

// ========== Gemini Chat（Firestore 擴充程式）整合 ==========

// 讓聊天快取目前的監聽器，關閉視窗時取消監聽
let chatUnsub = null;

// 將一則訊息渲染到視窗
function appendChatBubble(text, role = 'bot') {
  const $chat = document.getElementById('chat-window');
  if (!$chat) return;
  const wrap = document.createElement('div');
  wrap.className = role === 'me'
    ? 'bg-slate-700 text-white rounded-xl px-4 py-3 max-w-[80%] ml-auto'
    : 'bg-slate-100 text-slate-800 rounded-xl px-4 py-3 max-w-[80%]';
  wrap.textContent = text;
  const row = document.createElement('div');
  row.className = 'w-full flex ' + (role === 'me' ? 'justify-end' : 'justify-start');
  row.appendChild(wrap);
  $chat.appendChild(row);
  $chat.scrollTop = $chat.scrollHeight;
}

// 清空視窗
function resetChatWindow() {
  const $chat = document.getElementById('chat-window');
  if ($chat) $chat.innerHTML = '';
}

// 啟動監聽：依 createTime 由小到大顯示最新 100 則
function startChatListener(uid) {
  if (chatUnsub) chatUnsub(); // 先關舊監聽，避免重複

  const msgsRef = collection(db, 'users', uid, 'messages');
  // ✅ 用 createTimeMs 排序，立即穩定
  const q = query(msgsRef, orderBy('createTimeMs', 'asc'), limit(100));

  chatUnsub = onSnapshot(q, (snap) => {
    // ✅ 全量重繪，永遠會吃到 modified 後的 response
    const $chat = document.getElementById('chat-window');
    if (!$chat) return;
    $chat.innerHTML = '';

    snap.docs.forEach(docSnap => {
      const d = docSnap.data();
      if (d.prompt) appendChatBubble(d.prompt, 'me');
      if (d.response) appendChatBubble(d.response, 'bot');
      else if (d.status) appendChatBubble(`（狀態：${d.status}）`, 'bot');
    });

    $chat.scrollTop = $chat.scrollHeight;
  }, (err) => {
    console.error('聊天監聽失敗：', err);
    appendChatBubble('系統：監聽訊息時發生錯誤，請稍後重試。', 'bot');
  });
}

// === 給 HTML 呼叫的 3 個函式 ===
window.openAIChat = function openAIChat() {
  const user = auth.currentUser;
  if (!user) {
    alert('請先登入後再使用 AI 顧問');
    return;
  }
  // 打開 modal（沿用你現有的開關動畫邏輯）
  const modal = document.getElementById('ai-chat-modal');
  modal.classList.remove('hidden');
  setTimeout(() => {
    modal.classList.remove('opacity-0');
    modal.querySelector('div > div').classList.remove('scale-95');
  }, 10);

  resetChatWindow();
  appendChatBubble('👋 我是你的 AI 行銷顧問，輸入你的需求吧！', 'bot');

  // 開始監聽 Firestore 訊息
  startChatListener(user.uid);
};

window.closeAIChat = function closeAIChat() {
  // 關閉監聽
  if (chatUnsub) { chatUnsub(); chatUnsub = null; }

  // 關閉 modal（沿用你現有的動畫）
  const modal = document.getElementById('ai-chat-modal');
  modal.classList.add('opacity-0');
  modal.querySelector('div > div').classList.add('scale-95');
  setTimeout(() => { modal.classList.add('hidden'); }, 300);
};

window.sendChatMessage = async function sendChatMessage() {
  const user = auth.currentUser;
  if (!user) return alert('請先登入');

  const $input = document.getElementById('chat-input');
  const text = ($input.value || '').trim();
  if (!text) return;

  // 立刻在前端先顯示使用者訊息（好有即時感）
  appendChatBubble(text, 'me');

  try {
    const msgsRef = collection(db, 'users', user.uid, 'messages');
    await addDoc(msgsRef, {
      prompt: text,              // 擴充程式讀這個欄位
      createTime: serverTimestamp(),
      createTimeMs: Date.now() 
      // 你也可在這裡嘗試擴充程式支援的參數（若版本支援）：
      // temperature: 0.4, topP: 0.95, topK: 32,
    });
    // 擴充程式會在背景呼叫 Gemini，幾秒後把 response 寫回同筆文件
  } catch (err) {
    console.error('送出失敗：', err);
    appendChatBubble('（送出失敗，請稍後重試）', 'bot');
  } finally {
    $input.value = '';
    $input.focus();
  }
};

    // === 新增部分 START: 這裡是所有新增加用來顯示、刪除、查看活動的功能 ===

    // === v3 (新功能): 上傳行銷活動圖片 (Request 2) ===
    // === 修正版：上傳行銷素材 (路徑改回 logos，並支援影片預覽) ===
    window.handleUploadCampaignImages = async function() {
        const user = auth.currentUser;
        if (!user) return alert('請先登入');

        const fileInput = document.getElementById('campaign-images');
        const files = fileInput.files;
        if (!files || files.length === 0) return alert('請選擇檔案');

        const statusEl = document.getElementById('upload-status-text');
        const previewEl = document.getElementById('image-preview-area');
        const uploadBtn = document.getElementById('upload-images-btn');
        const progressEl = document.getElementById('upload-progress-bar'); // 確保進度條存在

        uploadBtn.disabled = true;
        uploadBtn.textContent = '上傳中...';
        statusEl.textContent = '準備上傳...';
        if(progressEl) progressEl.classList.remove('hidden');

        // 使用 Promise 來包裝每一個上傳任務
        const uploadPromises = Array.from(files).map(file => {
            return new Promise((resolve, reject) => {
                // ★ 關鍵修正 1：改回原本的路徑結構 (logos/...) 避免權限錯誤
                const path = `logos/${user.uid}/campaign_uploads/${Date.now()}_${file.name}`;
                const ref = storageRef(storage, path);
                const uploadTask = uploadBytesResumable(ref, file);

                // ★ 關鍵修正 2：改回使用 .on('state_changed') 監聽，這是最穩定的寫法
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // 顯示進度
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        statusEl.textContent = `上傳中... ${Math.round(progress)}%`;
                        if(progressEl) progressEl.value = progress;
                    },
                    (error) => {
                        console.error("上傳單檔失敗:", error);
                        reject(error);
                    },
                    async () => {
                        // 上傳成功！開始處理預覽圖
                        const url = await getDownloadURL(uploadTask.snapshot.ref);
                        
                        // ★ 這裡插入「影片 vs 圖片」的判斷邏輯
                        const isVideo = file.type.startsWith('video');
                        
                        const el = isVideo 
                            ? document.createElement('video') 
                            : document.createElement('img');
                        
                        el.src = url;
                        el.className = 'w-20 h-20 object-cover rounded border bg-black';
                        
                        if (isVideo) {
                            el.muted = true;      // 靜音
                            el.autoplay = false;  // 不自動播放
                            el.controls = true;   // 顯示播放控制條 (讓商家可以點擊檢查)
                        }

                        previewEl.appendChild(el);
                        resolve(url); // 回傳網址
                    }
                );
            });
        });

        try {
            const newUrls = await Promise.all(uploadPromises);
            uploadedImageUrls = uploadedImageUrls.concat(newUrls);
            statusEl.textContent = `成功上傳 ${newUrls.length} 個檔案！`;
            fileInput.value = ''; // 清空選擇
        } catch (e) {
            console.error("上傳過程發生錯誤:", e);
            statusEl.textContent = '上傳失敗，請查看 Console 錯誤訊息';
            alert('上傳失敗，可能是網路問題或權限不足');
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = '上傳選取的圖片';
            if(progressEl) progressEl.classList.add('hidden');
        }
    };

// === 修正版：商家活動列表 (支援影片封面) ===
    function renderCampaigns(campaigns) {
        const listElement = document.getElementById('campaigns-list');
        if (!listElement) return;

        if (campaigns.length === 0) {
            listElement.innerHTML = `<div class="col-span-full text-center py-10"><p class="text-gray-500 mb-4">目前沒有任何行銷活動</p><button onclick="openModal('new-campaign-modal')" class="bg-teal-600 text-white px-6 py-2 rounded-lg">立即建立第一個活動</button></div>`;
            return;
        }

        let campaignsHTML = '';
        campaigns.forEach(campaign => {
            const data = campaign.data;
            const id = campaign.id;

            // --- ★ 修改開始：智慧封面 ---
            let coverImage = `<div class="w-full h-32 bg-slate-100 flex items-center justify-center text-gray-400">無封面</div>`;
            
            if (data.imageUrls && data.imageUrls.length > 0) {
                const url = data.imageUrls[0];
                const isVideo = url.toLowerCase().includes('.mp4') || 
                              url.toLowerCase().includes('.mov') || 
                              url.toLowerCase().includes('.webm');
                
                if (isVideo) {
                    // 影片封面：滑鼠滑過自動播放
                    coverImage = `
                        <video src="${url}" class="w-full h-32 object-cover bg-black" 
                            muted loop playsinline
                            onmouseover="this.play()" 
                            onmouseout="this.pause();this.currentTime=0;"
                        ></video>`;
                } else {
                    // 圖片封面
                    coverImage = `<img src="${url}" alt="${data.productName}" class="w-full h-32 object-cover" onerror="this.style.display='none'">`;
                }
            }
            // --- ★ 修改結束 ---

            // 狀態標籤
            const statusMap = {
                'pending_match': { text: '正在配對中', color: 'bg-yellow-100 text-yellow-800' },
                'matched': { text: '配對完成', color: 'bg-green-100 text-green-800' },
                'in_progress': { text: '執行中', color: 'bg-blue-100 text-blue-800' }
            };
            const st = statusMap[data.status] || { text: '未知', color: 'bg-gray-100 text-gray-800' };
            const statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${st.color}">${st.text}</span>`;

            // 刪除按鈕邏輯
            let deleteButtonHTML = '';
            const now = Date.now();
            const createdTime = data.createdAt ? data.createdAt.toMillis() : 0;
            const diffMinutes = (now - createdTime) / 1000 / 60;

            if (data.status === 'pending_match') {
                if (diffMinutes <= 10) {
                    deleteButtonHTML = `<button onclick="handleDeleteCampaign('${id}', ${createdTime})" class="w-1/2 text-center bg-red-50 py-2 rounded-lg font-semibold text-red-600 hover:bg-red-100 text-xs">刪除 (剩${Math.round(10 - diffMinutes)}分)</button>`;
                } else {
                    deleteButtonHTML = `<button disabled class="w-1/2 text-center bg-gray-100 py-2 rounded-lg font-semibold text-gray-400 cursor-not-allowed text-xs">已鎖定</button>`;
                }
            }

            campaignsHTML += `
                <div class="bg-white rounded-xl shadow flex flex-col justify-between overflow-hidden hover:shadow-md transition-shadow">
                    ${coverImage}
                    <div class="p-5 flex-1 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start">
                                ${statusBadge}
                                <span class="text-xs text-gray-400">${new Date(createdTime).toLocaleDateString()}</span>
                            </div>
                            <h3 class="font-bold text-lg mt-2 text-slate-800 line-clamp-1">${data.productName}</h3>
                            <p class="text-sm text-gray-500 mt-1">預算: NT$ ${data.budget.toLocaleString()}</p>
                            <p class="text-sm text-gray-500 mt-1">需求: ${data.influencerCount} 位</p>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button onclick="showCampaignDetail('${id}')" class="w-full text-center bg-gray-100 py-2 rounded-lg font-semibold text-gray-700 hover:bg-gray-200 text-xs">查看詳情</button>
                            ${deleteButtonHTML}
                        </div>
                    </div>
                </div>
            `;
        });
        listElement.innerHTML = campaignsHTML;
    }

    // 功能 2: 建立一個即時監聽器，當資料庫有變化時自動更新畫面
        let unsubscribeCampaigns = null; 
        function listenForCampaigns() {
            const user = auth.currentUser;
            if (!user) return;
            if (unsubscribeCampaigns) unsubscribeCampaigns();

            const briefsRef = collection(db, "briefs");
            const q = query(briefsRef, 
                where("merchantId", "==", user.uid),// 只查詢屬於當前商家的
                where("isDeleted", "==", false),// 只查詢未被軟刪除的
                orderBy("createdAt", "desc")
            );

            unsubscribeCampaigns = onSnapshot(q, (querySnapshot) => {
                const campaigns = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderCampaigns(campaigns);// 將獲取的資料傳遞給渲染函式
            }, (error) => {
                console.error("監聽活動失敗: ", error);
                 // 可以在此處加入錯誤提示 UI
            });
        }

// === 修正版：商家詳情頁 (支援影片顯示) ===
    window.showCampaignDetail = async function(campaignId) {
        if (!campaignId) return;
        try {
            const docSnap = await getDoc(doc(db, "briefs", campaignId));
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // --- ★ 修改開始：智慧判斷素材類型 ---
                let imagesHTML = '<p class="text-gray-500">無素材</p>';
                
                if (data.imageUrls && data.imageUrls.length > 0) {
                    const items = data.imageUrls.map(url => {
                        // 判斷副檔名
                        const isVideo = url.toLowerCase().includes('.mp4') || 
                                      url.toLowerCase().includes('.mov') || 
                                      url.toLowerCase().includes('.webm');
                        
                        if (isVideo) {
                            // 如果是影片：顯示播放器 (controls)
                            return `<video src="${url}" class="w-full h-24 object-cover rounded-md border bg-black" controls></video>`;
                        } else {
                            // 如果是圖片：維持原本的點擊放大
                            return `<a href="${url}" target="_blank"><img src="${url}" class="w-full h-24 object-cover rounded-md border hover:opacity-80"></a>`;
                        }
                    }).join('');
                    
                    imagesHTML = `<div class="grid grid-cols-4 gap-2">${items}</div>`;
                }
                // --- ★ 修改結束 ---

                // 設定 HTML 框架
                const contentArea = document.getElementById('merchant-campaign-detail-content');
                contentArea.innerHTML = `
                    <div class="bg-white rounded-xl shadow p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-slate-800">${data.productName}</h2>
                            <button onclick="switchTab('merchant', 'campaigns')" class="text-sm text-blue-600 hover:underline">← 返回列表</button>
                        </div>
                        
                        <div class="mb-6 p-4 bg-slate-50 rounded-lg">
                            <h3 class="font-bold text-slate-700 mb-2">專案進度 (目標: ${data.influencerCount} 人)</h3>
                            <div class="flex h-4 overflow-hidden rounded-full bg-gray-200 text-xs font-bold text-white text-center" id="status-bar-container">
                                <div style="width: 0%" class="bg-gray-400 flex items-center justify-center">0</div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-2" id="status-legend">
                                <span>載入數據中...</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-2 space-y-4">
                                <div><label class="text-xs text-gray-500">描述</label><p class="text-gray-800">${data.productDesc}</p></div>
                                <div><label class="text-xs text-gray-500">行銷素材</label>${imagesHTML}</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg space-y-2 text-sm">
                                <div class="flex justify-between"><span>預算</span><span class="font-bold">NT$ ${data.budget.toLocaleString()}</span></div>
                                <div class="flex justify-between"><span>預期曝光</span><span class="font-bold">${data.impressions.toLocaleString()}</span></div>
                                <div class="flex justify-between"><span>狀態</span><span class="font-bold">${data.status}</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow mt-6">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 text-lg">合作網紅牆 (Influencer Wall)</h3>
                        </div>
                        <div id="collab-list-${campaignId}" class="p-6 bg-slate-50 min-h-[300px]">
                            <p class="text-center text-gray-500 py-10">載入網紅資料中...</p>
                        </div>
                    </div>
                `;
                
                switchTab('merchant', 'campaign-detail');
                renderCampaignCollaborations(campaignId, `collab-list-${campaignId}`, data.influencerCount);

            } else { alert("找不到活動資料"); }
        } catch (e) { console.error(e); alert("讀取詳情錯誤"); }
    };



    // === v3 (新功能): 修改 handleSaveBrief 以儲存 imageUrls ===
        window.handleSaveBrief = async function() {
            const user = auth.currentUser;
            if (!user) return alert('請先登入！');

            const briefData = {
                productName: document.getElementById('brief-product-name').value,
                productDesc: document.getElementById('brief-product-desc').value,
                category: document.getElementById('brief-category').value,
                impressions: parseInt(document.getElementById('brief-impressions').value) || 0,
                budget: parseInt(document.getElementById('brief-budget').value) || 0,
                influencerCount: parseInt(document.getElementById('brief-influencer-count').value) || 0,
                followerRange: document.getElementById('brief-follower-range').value,
                platforms: Array.from(document.querySelectorAll('#brief-platforms input:checked')).map(el => el.value),
                imageUrls: uploadedImageUrls, // v3: 儲存上傳的圖片 URL
                status: 'pending_match',
                isDeleted: false, // 新增：軟刪除標記
                merchantId: user.uid,
                merchantEmail: user.email,
                createdAt: serverTimestamp() // v2 (本次修改): 使用 serverTimestamp()
            };

            if (!briefData.productName) return alert('請至少填寫產品名稱！');

            try {
                await addDoc(collection(db, "briefs"), briefData);
                alert('您的需求已成功送出！');
                closeModal('new-campaign-modal'); // closeModal 會自動清空表單和暫存
            } catch (error) {
                console.error("儲存需求單失敗:", error);
                alert('儲存失敗，請查看 console 的錯誤訊息。');
            }
        }
    // === 修改部分 END ===


        // === 新增功能：打開活動詳情彈窗 ===
    window.openBriefDetail = async function(briefId, showAcceptBtn = false) {
        try {
            const docRef = doc(db, 'briefs', briefId);
            const snap = await getDoc(docRef);
            
            if(!snap.exists()) return alert('找不到此活動資料');
            
            const data = snap.data();
            
            // 1. 填寫文字資料
            document.getElementById('modal-brief-title').textContent = data.productName;
            document.getElementById('modal-brief-desc').textContent = data.productDesc;
            document.getElementById('modal-brief-budget').textContent = `NT$ ${data.budget.toLocaleString()}`;
            document.getElementById('modal-brief-count').textContent = `${data.influencerCount} 人`;
            document.getElementById('modal-brief-platform').textContent = data.platforms ? data.platforms.join(', ') : '不限';

            // 2. 處理標籤
            const tagContainer = document.getElementById('modal-brief-tags');
            tagContainer.innerHTML = `
                <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-sm font-medium">#${data.category}</span>
                <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-sm font-medium">預估曝光: ${data.impressions}</span>
            `;

            // 3. 處理素材 (圖片/影片)
            const assetContainer = document.getElementById('modal-brief-assets');
            if (data.imageUrls && data.imageUrls.length > 0) {
                let assetsHtml = '';
                data.imageUrls.forEach(url => {
                    const isVideo = url.toLowerCase().includes('.mp4') || url.toLowerCase().includes('.mov') || url.toLowerCase().includes('.webm');
                    if(isVideo) {
                        assetsHtml += `
                            <div class="relative group">
                                <video src="${url}" class="w-full h-40 object-cover rounded-lg bg-black" controls></video>
                            </div>`;
                    } else {
                        assetsHtml += `
                            <div class="relative group">
                                <a href="${url}" target="_blank">
                                    <img src="${url}" class="w-full h-40 object-cover rounded-lg border hover:opacity-80 transition cursor-zoom-in">
                                </a>
                            </div>`;
                    }
                });
                assetContainer.innerHTML = assetsHtml;
            } else {
                assetContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center py-4">商家未上傳參考素材</p>';
            }

            // 4. 設定接單按鈕 (如果是從「合作邀請」點進來，顯示按鈕；如果是「已接單」點進來，隱藏按鈕)
            const acceptBtn = document.getElementById('modal-btn-accept');
            if(showAcceptBtn) {
                acceptBtn.classList.remove('hidden');
                // 綁定接單事件
                acceptBtn.onclick = function() {
                    handleAcceptInvite(briefId, data.merchantId);
                    closeModal('brief-detail-modal');
                };
            } else {
                acceptBtn.classList.add('hidden');
            }

            openModal('brief-detail-modal');

        } catch(e) {
            console.error(e);
            alert('讀取失敗');
        }
    };







  // ==========================================
    //  NEW: 網紅端 - 合作流程核心邏輯 (貼在 handleSaveBrief 之後)
    // ==========================================

// ============================================================
    //  修復後的網紅端邏輯 (解決 ... 問題、重複接單問題、修改上傳問題)
    // ============================================================



    // === 修正版：網紅合作邀請列表 (修復影片破圖問題) ===
    window.renderInfluencerInvitations = async function() {
        const user = auth.currentUser;
        const listEl = document.getElementById('influencer-invitations-list');
        if (!listEl || !user) return;
        
        listEl.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">正在尋找適合您的機會...</div>';

        try {
            // 步驟 A: 先查出「我已經接過」的 briefId
            const myCollabsSnap = await getDocs(query(collection(db, "collaborations"), where("influencerId", "==", user.uid)));
            const myJoinedBriefIds = new Set(myCollabsSnap.docs.map(doc => doc.data().briefId));

            // 步驟 B: 查出所有待媒合 (pending_match) 的活動
            const q = query(collection(db, "briefs"), 
                           where("status", "==", "pending_match"),
                           where("isDeleted", "==", false));
            
            const snapshot = await getDocs(q);
            
            let html = '';
            let count = 0;

            snapshot.docs.forEach(docSnap => {
                const briefId = docSnap.id;
                const brief = docSnap.data();

                // 過濾：如果我已經接過這個單，就跳過
                if (myJoinedBriefIds.has(briefId)) return;

                count++;
                
                // --- ★ 修改重點：智慧封面 (圖片/影片判斷) ---
                let coverImg = `<div class="w-24 h-24 bg-slate-200 rounded-lg flex-shrink-0 flex items-center justify-center text-gray-400 text-xs">無素材</div>`;
                
                if (brief.imageUrls && brief.imageUrls.length > 0) {
                    const url = brief.imageUrls[0];
                    // 簡單判斷副檔名
                    const isVideo = url.toLowerCase().includes('.mp4') || 
                                  url.toLowerCase().includes('.mov') || 
                                  url.toLowerCase().includes('.webm');
                    
                    if (isVideo) {
                        // 影片：滑鼠滑過預覽播放
                        coverImg = `
                            <video src="${url}" 
                                class="w-24 h-24 object-cover rounded-lg flex-shrink-0 bg-black border" 
                                muted loop playsinline
                                onmouseover="this.play()" 
                                onmouseout="this.pause();this.currentTime=0;"
                            ></video>`;
                    } else {
                        // 圖片
                        coverImg = `<img src="${url}" class="w-24 h-24 object-cover rounded-lg flex-shrink-0 bg-slate-200 border">`;
                    }
                }
                // ------------------------------------------

                html += `
                    <div class="bg-white rounded-xl shadow p-6 flex flex-col md:flex-row gap-6 items-start hover:shadow-lg transition-shadow border border-gray-100">
                        <div class="cursor-pointer" onclick="openBriefDetail('${briefId}', true)">
                            ${coverImg}
                        </div>
                        <div class="flex-1 w-full">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800 cursor-pointer hover:text-teal-600" onclick="openBriefDetail('${briefId}', true)">
                                        ${brief.productName}
                                    </h3>
                                    <div class="flex gap-2 mt-1">
                                        <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100">
                                            類別: ${brief.category || '一般'}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-500 mt-2 line-clamp-2">${brief.productDesc}</p>
                                </div>
                                <div class="flex flex-col items-end gap-1">
                                    <span class="bg-teal-50 text-teal-700 text-sm px-3 py-1 rounded-full font-bold border border-teal-100">
                                        預算: $${brief.budget.toLocaleString()}
                                    </span>
                                </div>
                            </div>
                            <div class="mt-4 flex flex-wrap gap-2 text-xs text-gray-600">
                                <span class="bg-slate-100 px-2 py-1 rounded">需求: ${brief.influencerCount} 人</span>
                                <span class="bg-slate-100 px-2 py-1 rounded">平台: ${brief.platforms ? brief.platforms.join(', ') : '不限'}</span>
                            </div>

                            <div class="mt-4 flex justify-end gap-3">
                                <button onclick="openBriefDetail('${briefId}', true)" 
                                        class="px-4 py-2 border border-gray-300 text-gray-600 font-bold rounded-lg hover:bg-gray-50 transition-colors text-sm">
                                    查看完整內容
                                </button>
                                
                                <button onclick="handleAcceptInvite('${briefId}', '${brief.merchantId}')" 
                                        class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 active:scale-95">
                                    接單合作
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (count === 0) {
                listEl.innerHTML = '<div class="col-span-full text-center py-12 bg-white rounded-xl shadow border border-dashed border-gray-300"><p class="text-4xl mb-2">📭</p><p class="text-gray-500 text-lg">目前沒有新的合作邀請，晚點再來看看！</p></div>';
            } else {
                listEl.innerHTML = html;
            }

        } catch (error) {
            console.error("載入失敗:", error);
            // 這裡也加上友善的錯誤提示，如果是索引錯誤就引導使用者
            if(error.message.includes("index")) {
                listEl.innerHTML = `<p class="text-red-500 col-span-full text-center">系統升級中 (缺少索引)，請管理員至 Console 點擊連結建立。</p>`;
            } else {
                listEl.innerHTML = `<p class="text-red-500 col-span-full text-center">載入失敗: ${error.message}</p>`;
            }
        }
    };


    // === 改良版：接單功能 (含除錯訊息) ===
    window.handleAcceptInvite = async function(briefId, merchantId) {
        console.log("1. 點擊了接單按鈕", briefId, merchantId); // 除錯訊息

        const user = auth.currentUser;
        if (!user) return alert('請先登入');

        // 確保 merchantId 有值，如果是 'undefined' 字串或空值，給個預設
        if(!merchantId || merchantId === 'undefined') {
            console.warn("商家 ID 缺失，可能是舊資料");
            // 視情況決定是否要擋下，或是繼續
        }
        
        // 使用 try-catch 包裹 confirm，防止某些瀏覽器阻擋
        try {
            if(!confirm('確定要接受這個合作邀請嗎？')) {
                console.log("使用者取消接單");
                return;
            }
        } catch(e) {
            console.error("Confirm 視窗錯誤:", e);
        }

        console.log("2. 開始檢查是否重複接單...");

        try {
            // ★ 這裡可能會因為缺索引而報錯，請看 Console 紅字
            const q = query(collection(db, "collaborations"), 
                where("briefId", "==", briefId), 
                where("influencerId", "==", user.uid));
            
            const existing = await getDocs(q);
            
            if (!existing.empty) {
                console.log("檢查結果：已接過單");
                return alert('您已經接受過這個邀請了，請至「總覽」查看進行中的工作。');
            }

            console.log("3. 檢查通過，正在寫入資料庫...");

            // 寫入 collaborations
            await addDoc(collection(db, "collaborations"), {
                briefId: briefId,
                merchantId: merchantId || 'unknown', // 防止 undefined
                influencerId: user.uid,
                influencerEmail: user.email,
                status: 'accepted',
                changeRequestCount: 0,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            });

            console.log("4. 寫入成功！");
            alert('接單成功！請至「總覽」分頁查看並開始製作素材。');
            
            // 切換分頁
            switchTab('influencer', 'dashboard'); 

        } catch (error) {
            console.error("接單流程發生錯誤:", error); // 這行會在 Console 顯示詳細錯誤
            
            // 如果是索引錯誤，提示使用者
            if(error.message.includes("requires an index")) {
                alert("系統升級中：請打開 F12 Console 點擊連結建立索引 (Index)。");
            } else {
                alert("接單失敗: " + error.message);
            }
        }
    };

// 2. 渲染「進行中的工作」 (修復：狀態判斷與修改上傳表單)
    // === 網紅端：渲染進行中的工作 (含歷史紀錄、檔案刪除、成果上傳) ===
    window.renderInfluencerActiveJobs = async function() {
        const user = auth.currentUser;
        if (!user) return;
        const listEl = document.getElementById('influencer-active-jobs-list');
        if (!listEl) return;

        const q = query(collection(db, "collaborations"), where("influencerId", "==", user.uid));
        
        onSnapshot(q, async (snapshot) => {
            if (snapshot.empty) {
                listEl.innerHTML = '<p class="text-gray-500">目前沒有進行中的工作。</p>';
                return;
            }

            let html = '';
            for (const docSnap of snapshot.docs) {
                const collab = docSnap.data();
                const collabId = docSnap.id;
                
                // 讀取標題
                let briefTitle = '載入中...';
                try {
                    const briefSnap = await getDoc(doc(db, 'briefs', collab.briefId));
                    if (briefSnap.exists()) briefTitle = briefSnap.data().productName;
                } catch(e){}

                // --- 1. 歷史紀錄渲染 ---
                let historyHtml = '';
                if (collab.history && collab.history.length > 0) {
                    historyHtml = `<div class="bg-slate-50 rounded-lg p-3 mb-4 max-h-60 overflow-y-auto border border-slate-200 space-y-3">
                        <p class="text-xs text-gray-400 font-bold mb-2">--- 溝通紀錄 ---</p>`;
                    
                    collab.history.forEach(item => {
                        const isMe = item.role === 'influencer';
                        const align = isMe ? 'ml-auto bg-teal-50 border-teal-100' : 'mr-auto bg-white border-gray-200';
                        const title = isMe ? '我 (提交)' : '商家 (建議)';
                        
                        // 歷史檔案顯示
                        let fileLink = '';
                        if(item.files && item.files.length > 0){
                            item.files.forEach(f => {
                                if(f.type === 'image') fileLink += `<br><a href="${f.url}" target="_blank" class="text-blue-500 text-xs underline">[圖片]</a>`;
                                else fileLink += `<br><a href="${f.url}" target="_blank" class="text-blue-500 text-xs underline">[影片]</a>`;
                            });
                        }

                        historyHtml += `
                            <div class="w-[85%] ${align} border p-2 rounded-lg text-sm">
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>${title}</span>
                                    <span>${new Date(item.time.toMillis()).toLocaleString()}</span>
                                </div>
                                <div class="text-slate-700">${item.text || '(無文字)'}</div>
                                ${fileLink}
                            </div>
                        `;
                    });
                    historyHtml += `</div>`;
                }

                // --- 2. 狀態 UI 與 連結邏輯 ---
                let statusBadge = '';
                let actionArea = '';

                if (collab.status === 'accepted' || collab.status === 'changes_requested') {
                    // === 提交/修改區塊 ===
                    if (collab.status === 'changes_requested') {
                        statusBadge = '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs font-bold">需修改 ⚠️</span>';
                    } else {
                        statusBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-bold">製作中 🛠️</span>';
                    }

                    // 檔案選擇與預覽區 (使用全域變數 influencerSelectedFiles)
                    // 初始化該 ID 的陣列
                    if(!influencerSelectedFiles[collabId]) influencerSelectedFiles[collabId] = [];
                    
                    // 產生預覽 HTML
                    let previewHtml = '';
                    if(influencerSelectedFiles[collabId].length > 0){
                        influencerSelectedFiles[collabId].forEach((f, idx) => {
                            previewHtml += `
                                <div class="flex items-center justify-between bg-gray-100 px-2 py-1 rounded text-xs mt-1">
                                    <span class="truncate max-w-[200px]">${f.name}</span>
                                    <button onclick="removeInfFile('${collabId}', ${idx})" class="text-red-500 font-bold ml-2">✕</button>
                                </div>`;
                        });
                    }

                    actionArea = `
                        <div class="bg-white border rounded-lg p-4 shadow-sm">
                            <p class="text-sm font-bold mb-2 text-slate-700">上傳您的創作素材</p>
                            <div class="space-y-3">
                                <input type="file" id="files-${collabId}" multiple accept="image/*,video/*" class="hidden" onchange="handleInfFileSelect('${collabId}', this)">
                                
                                <button onclick="document.getElementById('files-${collabId}').click()" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-300">
                                    + 選擇檔案
                                </button>
                                
                                <div id="preview-${collabId}">${previewHtml}</div>

                                <textarea id="text-${collabId}" placeholder="說明..." class="w-full border border-gray-300 rounded p-2 text-sm"></textarea>
                                
                                <div class="flex items-center gap-3">
                                    <button onclick="handleSubmitContent('${collabId}')" class="bg-teal-600 text-white py-2 px-6 rounded-lg text-sm font-bold hover:bg-teal-700 shadow-sm">
                                        ${collab.status === 'changes_requested' ? '提交修正' : '提交作品'}
                                    </button>
                                    <div id="progress-${collabId}" class="hidden text-xs text-teal-600 animate-pulse">上傳中...</div>
                                </div>
                            </div>
                        </div>
                    `;

                } else if (collab.status === 'reviewing' || collab.status === 'submitting') {
                    statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-bold">審核中 ⏳</span>';
                    actionArea = `<div class="p-3 bg-yellow-50 text-yellow-800 text-sm rounded border border-yellow-200">已提交素材，請等待商家審核。</div>`;
                
                } else if (collab.status === 'approved') {
                    // === 需求 4: 連結生成邏輯 ===
                    statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">已確認 ✅</span>';
                    
                    if (!collab.marketingLink) {
                        // 階段 1: 等待產生連結
                        actionArea = `
                            <div class="p-4 bg-green-50 rounded border border-green-200 text-center space-y-2">
                                <p class="text-green-800 font-bold">商家已通過您的素材！</p>
                                <p class="text-sm text-gray-600 animate-pulse">⚙️ 系統正在產生專屬行銷連結，請稍候...</p>
                            </div>`;
                    } else {
                        // 階段 2: 連結已產生 + 需求 5: 成果上傳
                        actionArea = `
                            <div class="space-y-4">
                                <div class="p-4 bg-green-100 rounded border border-green-300 text-center">
                                    <p class="text-green-900 font-bold text-lg">🎉 合作完成！</p>
                                    <p class="text-sm text-green-700 mb-2">商家已通過您的素材，並產生連結：</p>
                                    <div class="bg-white p-2 rounded border border-green-200 text-teal-600 font-mono text-sm break-all select-all">
                                        ${collab.marketingLink}
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">${collab.marketingNote || ''}</p>
                                </div>

                                <div class="border-t pt-4">
                                    <h4 class="font-bold text-slate-800 mb-2">📈 上傳行銷成果 (截圖/錄影)</h4>
                                    <div class="bg-slate-50 p-4 rounded border">
                                        <input type="file" id="result-file-${collabId}" multiple accept="image/*,video/*" class="block w-full text-sm mb-2">
                                        <button onclick="handleUploadResults('${collabId}', '${collab.briefId}', '${user.uid}')" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700">
                                            上傳成果
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                    }
                } else if (collab.status === 'rejected') {
                    statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-bold">已終止 ❌</span>';
                    actionArea = `<div class="p-3 bg-red-50 text-red-700 text-sm rounded border border-red-200">此合作案已被終止。</div>`;
                }

                html += `
                    <div class="bg-white rounded-xl shadow p-6 mb-4 border-l-4 ${collab.status === 'changes_requested' ? 'border-orange-500' : (collab.status === 'approved' ? 'border-green-500' : 'border-indigo-500')}">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <div class="flex items-center gap-3">
                                <h3 class="font-bold text-lg text-slate-800">${briefTitle}</h3>
                                <button onclick="openBriefDetail('${collab.briefId}', false)" class="text-xs text-blue-600 hover:underline bg-blue-50 px-2 py-1 rounded">📄 原始需求</button>
                            </div>
                            ${statusBadge}
                        </div>
                        ${historyHtml}
                        ${actionArea}
                    </div>
                `;
            }
            listEl.innerHTML = html;
        });
    };

    // --- 輔助函式：檔案選擇與刪除 ---
    window.handleInfFileSelect = function(collabId, input) {
        if(input.files && input.files.length > 0){
            if(!influencerSelectedFiles[collabId]) influencerSelectedFiles[collabId] = [];
            // 將新選的檔案加入陣列
            Array.from(input.files).forEach(f => influencerSelectedFiles[collabId].push(f));
            // 重新渲染該區塊 (這裡偷懶直接重新觸發 render，實務上可用 DOM 操作優化，但這樣最保險)
            // 由於 render 是監聽 snapshot，我們這裡暫時只能手動更新 UI，或是等待下一次 snapshot
            // 為了簡單，我們直接操作 DOM 更新預覽區
            updateInfFilePreview(collabId);
        }
        input.value = ''; // 清空 input 讓同個檔案可再選
    };

    window.removeInfFile = function(collabId, index) {
        if(influencerSelectedFiles[collabId]) {
            influencerSelectedFiles[collabId].splice(index, 1);
            updateInfFilePreview(collabId);
        }
    };

    function updateInfFilePreview(collabId) {
        const container = document.getElementById(`preview-${collabId}`);
        if(!container) return;
        let html = '';
        influencerSelectedFiles[collabId].forEach((f, idx) => {
            html += `
                <div class="flex items-center justify-between bg-gray-100 px-2 py-1 rounded text-xs mt-1">
                    <span class="truncate max-w-[200px]">${f.name}</span>
                    <button onclick="removeInfFile('${collabId}', ${idx})" class="text-red-500 font-bold ml-2">✕</button>
                </div>`;
        });
        container.innerHTML = html;
    }

    // 4. 網紅上傳素材 (圖片或影片)
// === 修改後：處理多檔上傳 ===
    // === 修正版：網紅提交素材 (修復讀不到檔案與時間錯誤問題) ===
    window.handleSubmitContent = async function(collabId) {
        // 1. 抓取 HTML 元素
        const textInput = document.getElementById(`text-${collabId}`);
        const fileInput = document.getElementById(`files-${collabId}`); // 這是原本的 input
        const progressDiv = document.getElementById(`progress-${collabId}`);
        const user = auth.currentUser;
        
        let files = [];

        // 1) 先把 input 裡「還沒進預覽」的檔案撈出來（以防萬一）
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
            files = files.concat(Array.from(fileInput.files));
        }

        // 2) 再把你存到預覽用陣列裡的檔案也加進來（★關鍵修正）
        if (influencerSelectedFiles[collabId] && influencerSelectedFiles[collabId].length > 0) {
            files = files.concat(influencerSelectedFiles[collabId]);
        }

        const text = textInput.value;

        if (files.length === 0 && !text) {
            return alert('請至少上傳一種檔案或說明'); // 文案隨你
        }

        progressDiv.classList.remove('hidden');
        progressDiv.textContent = `準備上傳 ${files.length} 個檔案...`;

        try {
            // 3. 上傳檔案到 Storage
            const uploadPromises = files.map(file => {
                return new Promise((resolve, reject) => {
                    // 路徑加上時間戳記避免檔名重複
                    const storagePath = `collaborations/${collabId}/${Date.now()}_${file.name}`;
                    const ref = storageRef(storage, storagePath);
                    const task = uploadBytesResumable(ref, file);
                    
                    task.on('state_changed', 
                        (snapshot) => {
                            const pc = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            progressDiv.textContent = `上傳中... ${pc}%`;
                        }, 
                        (error) => reject(error), 
                        async () => {
                            const url = await getDownloadURL(task.snapshot.ref);
                            resolve({
                                url: url,
                                type: file.type.startsWith('video/') ? 'video' : 'image',
                                name: file.name
                            });
                        }
                    );
                });
            });

            // 等待所有檔案上傳完畢
            const newFilesData = await Promise.all(uploadPromises);

            // 4. 更新 Firestore 資料庫
            const docRef = doc(db, "collaborations", collabId);
            
            // 步驟 A: 先讀取目前的資料 (為了拿到舊的 history)
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) throw new Error("找不到該合作案");
            
            const currentData = docSnap.data();
            const currentHistory = currentData.history || [];

            // 步驟 B: 建立新的歷史紀錄物件
            const newHistoryItem = {
                role: 'influencer',
                action: 'submit',
                text: text,
                files: newFilesData,
                // ★ 關鍵修正：改用 new Date()，解決 Timestamp is not defined 錯誤
                time: new Date() 
            };

            // 步驟 C: 將新紀錄加入陣列
            currentHistory.push(newHistoryItem);

            // 步驟 D: 更新資料庫
            await updateDoc(docRef, {
                contentData: newFilesData, // 更新主要顯示區 (顯示最新的)
                history: currentHistory,   // 更新歷史紀錄陣列
                status: 'reviewing',       // 狀態改為審核中
                updatedAt: serverTimestamp() // 使用伺服器時間
            });
            
            alert('提交成功！等待商家審核。');

            influencerSelectedFiles[collabId] = [];
            updateInfFilePreview(collabId);
            if (fileInput) fileInput.value = '';
            textInput.value = '';
            progressDiv.classList.add('hidden');
            
            // 5. 清空輸入框與隱藏進度條
            fileInput.value = '';
            textInput.value = '';
            // 如果有全域變數也要清空
            if(typeof influencerSelectedFiles !== 'undefined') {
                influencerSelectedFiles[collabId] = [];
                // 如果有預覽區塊也要清空 (假設函式存在)
                if(typeof updateInfFilePreview === 'function') updateInfFilePreview(collabId);
            }
            progressDiv.classList.add('hidden');

        } catch (error) {
            console.error("提交失敗:", error);
            // 這裡如果是權限錯誤，會顯示出來
            alert("提交失敗: " + error.message);
            progressDiv.classList.add('hidden');
        }
    };


    // ==========================================
    //  NEW: 商家端 - 審核流程 (接續在網紅邏輯後)
    // ==========================================

    // === 更新版：渲染網紅牆與狀態條 ===
// 1. 商家詳細頁渲染 (網紅牆 + 狀態條) (Requirement #3 & #4)
    // === 大改版：商家網紅牆 (含自動審核檢查 + 完整素材顯示) ===
    window.renderCampaignCollaborations = function(briefId, containerId, targetCount = 10) {
        const container = document.getElementById(containerId);
        if(!container) return;

        const q = query(collection(db, "collaborations"), where("briefId", "==", briefId));
        
        onSnapshot(q, (snapshot) => {
            let stats = { accepted: 0, reviewing: 0, changes: 0, approved: 0, rejected: 0 };
            const currentTotal = snapshot.size;
            
            // --- 準備 HTML ---
            let cardsHtml = '';

            snapshot.docs.forEach(docSnap => {
                const collab = docSnap.data();
                const cid = docSnap.id;
                
                // === 需求 4: 3天自動通過檢查 (Lazy Check) ===
                if (collab.status === 'reviewing' || collab.status === 'submitting') {
                    const now = Date.now();
                    const lastUpdate = collab.updatedAt ? collab.updatedAt.toMillis() : now;
                    const diffHours = (now - lastUpdate) / (1000 * 60 * 60);
                    
                    // 如果超過 72 小時 (3天)
                    if (diffHours > 72) {
                        console.log(`單號 ${cid} 超過 3 天未審核，自動通過。`);
                        updateDoc(doc(db, "collaborations", cid), {
                            status: 'approved',
                            updatedAt: serverTimestamp(),
                            autoApproved: true // 做個記號
                        });
                        // 這裡不需繼續渲染，因為 updateDoc 會觸發新的 snapshot，直接 return 等下次更新
                        return; 
                    }
                }
                // ============================================

                // 統計狀態
                if (collab.status === 'accepted') stats.accepted++;
                else if (collab.status === 'reviewing' || collab.status === 'submitting') stats.reviewing++;
                else if (collab.status === 'changes_requested') stats.changes++;
                else if (collab.status === 'approved') stats.approved++;
                else if (collab.status === 'rejected') stats.rejected++;

                // === 需求 5: 顯示所有素材 (Loop Rendering) ===
                let contentPreview = '';
                let contentDataArr = Array.isArray(collab.contentData) ? collab.contentData : (collab.contentData ? [collab.contentData] : []);
                
                if (contentDataArr.length > 0) {
                    contentPreview = `<div class="space-y-3 mt-3">`;
                    contentDataArr.forEach((item, idx) => {
                        let mediaHtml = '';
                        if (item.type === 'video') {
                            mediaHtml = `<video src="${item.url}" class="w-full h-48 object-cover bg-black rounded-lg border" controls></video>`;
                        } else {
                            mediaHtml = `<a href="${item.url}" target="_blank"><img src="${item.url}" class="w-full h-48 object-cover rounded-lg border hover:opacity-90"></a>`;
                        }
                        
                        contentPreview += `
                            <div class="bg-slate-50 p-2 rounded border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">素材 #${idx + 1}</div>
                                ${mediaHtml}
                                ${item.text ? `<p class="text-sm text-gray-700 mt-2 p-2 bg-white rounded border">${item.text}</p>` : ''}
                            </div>
                        `;
                    });
                    contentPreview += `</div>`;
                } else {
                    contentPreview = '<div class="h-20 bg-slate-50 rounded-lg flex items-center justify-center text-gray-400 text-sm mt-3">尚未上傳素材</div>';
                }
                // ==========================================

                // === 需求 3: 修改按鈕邏輯 (次數限制) ===
                let actions = '';
                // 讀取已修改次數，預設 0
                const changeCount = collab.changeRequestCount || 0;
                const maxChanges = 2;
                const remainingChanges = maxChanges - changeCount;

                // 定義狀態 UI
                const statusConfig = {
                    'accepted': { class: 'bg-blue-100 text-blue-800', label: '製作中' },
                    'reviewing': { class: 'bg-yellow-100 text-yellow-800', label: '待審核' },
                    'submitting': { class: 'bg-yellow-100 text-yellow-800', label: '待審核' },
                    'changes_requested': { class: 'bg-orange-100 text-orange-800', label: '修改中' },
                    'approved': { class: 'bg-green-100 text-green-800', label: '已確認' },
                    'rejected': { class: 'bg-red-100 text-red-800', label: '已拒絕' }
                };
                const st = statusConfig[collab.status] || { class: 'bg-gray-100', label: collab.status };

                if (collab.status === 'reviewing' || collab.status === 'submitting') {
                    // 修改按鈕邏輯：如果有剩餘次數才顯示按鈕
                    let changeBtnHtml = '';
                    if (remainingChanges > 0) {
                        changeBtnHtml = `<button onclick="handleMerchantReview('${cid}', 'request_change', ${changeCount})" class="bg-orange-500 text-white text-xs font-bold py-2 px-3 rounded hover:bg-orange-600 flex-1">修改 (剩${remainingChanges}次)</button>`;
                    } else {
                        // 次數用完，不顯示按鈕，或者顯示禁用按鈕
                        changeBtnHtml = `<button disabled class="bg-gray-300 text-white text-xs font-bold py-2 px-3 rounded cursor-not-allowed flex-1">修改次數已盡</button>`;
                    }

                    actions = `
                        <div class="mt-4 flex gap-2">
                            <button onclick="handleMerchantReview('${cid}', 'approve', ${changeCount})" class="bg-green-600 text-white text-xs font-bold py-2 px-3 rounded hover:bg-green-700 flex-1">通過</button>
                            ${changeBtnHtml}
                            <button onclick="handleMerchantReview('${cid}', 'reject', ${changeCount})" class="bg-red-500 text-white text-xs font-bold py-2 px-3 rounded hover:bg-red-600 flex-1">拒絕</button>
                        </div>
                    `;
                } else if (collab.status === 'changes_requested') {
                    actions = `<div class="mt-3 text-xs text-orange-700 bg-orange-50 p-2 rounded border border-orange-200">
                        <span class="font-bold">修改建議：</span>${collab.merchantMessage}
                        <div class="mt-1 text-right text-gray-400">已使用修改: ${changeCount}/2</div>
                    </div>`;
                } else if (collab.status === 'approved' && collab.autoApproved) {
                     actions = `<div class="mt-3 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-200 text-center">系統自動通過 (超過3天未審核)</div>`;
                }

                // 組裝卡片
                cardsHtml += `
                    <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-all flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-teal-400 to-blue-500 flex items-center justify-center text-white font-bold text-xs flex-shrink-0">
                                    ${collab.influencerEmail ? collab.influencerEmail[0].toUpperCase() : 'U'}
                                </div>
                                <div class="text-sm font-bold text-slate-700 truncate" title="${collab.influencerEmail}">
                                    ${collab.influencerEmail}
                                </div>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full font-bold whitespace-nowrap ${st.class}">${st.label}</span>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto max-h-[400px] scrollbar-hide">
                            ${contentPreview}
                        </div>
                        
                        ${actions}
                    </div>
                `;
            }); // end forEach

            cardsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${cardsHtml}</div>`;
            
            if (snapshot.empty) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                        <p class="text-4xl mb-2">📭</p>
                        <p class="text-gray-500">目前尚無網紅接單</p>
                    </div>`;
            } else {
                container.innerHTML = cardsHtml;
            }

            // 更新狀態條 (Status Bar) - 這部分代碼不變，維持原本的邏輯即可
            const activeCount = currentTotal - stats.rejected;
            const remainingSlots = Math.max(0, targetCount - activeCount);
            const barContainer = document.getElementById('status-bar-container');
            const legendContainer = document.getElementById('status-legend');
            if (barContainer) {
                const base = Math.max(targetCount, activeCount); 
                const p = (num) => (num / base) * 100;
                barContainer.innerHTML = `
                    <div style="width: ${p(stats.approved)}%" class="bg-green-500 shadow-none"></div>
                    <div style="width: ${p(stats.reviewing)}%" class="bg-yellow-400 shadow-none"></div>
                    <div style="width: ${p(stats.changes)}%" class="bg-orange-400 shadow-none"></div>
                    <div style="width: ${p(stats.accepted)}%" class="bg-blue-400 shadow-none"></div>
                `;
                legendContainer.innerHTML = `
                    <div class="flex flex-wrap gap-4 text-xs font-medium">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> 已確認 ${stats.approved}</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> 審核中 ${stats.reviewing}</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-400"></span> 修改中 ${stats.changes}</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> 製作中 ${stats.accepted}</span>
                        <span class="flex items-center gap-1 text-gray-400"><span class="w-2 h-2 rounded-full bg-gray-300"></span> 剩餘名額 ${remainingSlots}</span>
                    </div>
                `;
            }
        });
    };

// === 全新：商家審核處理 (呼叫 Modal) ===
    let currentReviewCollabId = null;
    let currentReviewChangeCount = 0;

    window.handleMerchantReview = function(collabId, action, currentChangeCount = 0) {
        currentReviewCollabId = collabId;
        currentReviewChangeCount = currentChangeCount;

        const modal = document.getElementById('merchant-review-modal');
        const title = document.getElementById('review-modal-title');
        const changeArea = document.getElementById('review-change-area');
        const confirmText = document.getElementById('review-confirm-text');
        const btn = document.getElementById('btn-confirm-review');

        // 重置 UI
        changeArea.classList.add('hidden');
        confirmText.classList.add('hidden');
        document.getElementById('review-comment').value = '';
        document.getElementById('review-file').value = '';

        if (action === 'request_change') {
            if (currentChangeCount >= 2) return alert('修改次數已達上限。');
            
            title.textContent = `要求修改 (剩 ${2 - currentChangeCount} 次)`;
            changeArea.classList.remove('hidden');
            btn.onclick = () => submitMerchantReview('changes_requested');
            
        } else if (action === 'approve') {
            title.textContent = '確認通過';
            confirmText.textContent = '確定要通過此素材嗎？通過後將進入連結產生階段。';
            confirmText.classList.remove('hidden');
            btn.onclick = () => submitMerchantReview('approved');

        } else if (action === 'reject') {
            title.textContent = '確認拒絕';
            confirmText.textContent = '確定要拒絕此合作嗎？此操作無法復原。';
            confirmText.classList.remove('hidden');
            confirmText.classList.add('text-red-600');
            btn.onclick = () => submitMerchantReview('rejected');
        }

        // 顯示 Modal
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('div').classList.remove('scale-95');
        }, 10);
    };

    // 1. 新增：商家選擇檔案後的預覽功能
    window.previewReviewFiles = function() {
        const input = document.getElementById('review-file');
        const container = document.getElementById('review-files-preview');
        container.innerHTML = ''; // 清空舊預覽

        if (input.files) {
            Array.from(input.files).forEach(file => {
                const isVideo = file.type.startsWith('video');
                const url = URL.createObjectURL(file);
                
                const el = document.createElement('div');
                el.className = "relative group h-20 w-full rounded-lg overflow-hidden border border-gray-200";
                
                if (isVideo) {
                    el.innerHTML = `<video src="${url}" class="h-full w-full object-cover bg-black"></video><div class="absolute inset-0 flex items-center justify-center text-white bg-black/30">▶</div>`;
                } else {
                    el.innerHTML = `<img src="${url}" class="h-full w-full object-cover">`;
                }
                container.appendChild(el);
            });
        }
    };

    // 2. 修改後：商家送出審核 (支援多檔上傳)
    async function submitMerchantReview(status) {
        if(!currentReviewCollabId) return;
        
        const btn = document.getElementById('btn-confirm-review');
        const comment = document.getElementById('review-comment').value;
        const fileInput = document.getElementById('review-file');
        const titleEl = document.getElementById('review-modal-title'); // 為了顯示進度
        
        btn.disabled = true;
        btn.textContent = '處理中...';

        try {
            let uploadedFiles = [];

            // 如果是要求修改，且有選擇檔案 -> 進行多檔上傳
            if (status === 'changes_requested' && fileInput.files.length > 0) {
                const files = Array.from(fileInput.files);
                titleEl.textContent = `正在上傳 ${files.length} 個檔案...`;

                const uploadPromises = files.map(file => {
                    return new Promise((resolve, reject) => {
                        // 存到 reviews 資料夾
                        const storagePath = `reviews/${currentReviewCollabId}/${Date.now()}_${file.name}`;
                        const ref = storageRef(storage, storagePath);
                        const task = uploadBytesResumable(ref, file);

                        task.on('state_changed', null, reject, async () => {
                            const url = await getDownloadURL(task.snapshot.ref);
                            resolve({
                                url: url,
                                type: file.type.startsWith('video/') ? 'video' : 'image',
                                name: file.name
                            });
                        });
                    });
                });

                uploadedFiles = await Promise.all(uploadPromises);
            }

            // 建構歷史紀錄物件
            const newHistoryItem = {
                role: 'merchant',
                action: status,
                text: status === 'changes_requested' ? comment : (status === 'approved' ? '商家已通過' : '商家已拒絕'),
                files: uploadedFiles, // 這裡現在是陣列了
                time: new Date()
            };

            const docRef = doc(db, "collaborations", currentReviewCollabId);
            
            // 準備更新資料
            let updateData = {
                status: status,
                updatedAt: serverTimestamp()
            };

            if (status === 'changes_requested') {
                updateData.merchantMessage = comment; 
                updateData.changeRequestCount = currentReviewChangeCount + 1;
            }

            // 更新 DB (狀態)
            await updateDoc(docRef, updateData);
            
            // 更新 DB (歷史紀錄)
            // 先讀取舊的，再 Push 新的 (比較穩定的做法)
            const snap = await getDoc(docRef);
            let currentHistory = snap.data().history || [];
            currentHistory.push(newHistoryItem);
            
            await updateDoc(docRef, { history: currentHistory });

            alert('操作成功！');
            
            // 清空預覽區
            document.getElementById('review-files-preview').innerHTML = '';
            closeModal('merchant-review-modal');

        } catch (e) {
            console.error(e);
            alert('發生錯誤: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = '確認送出';
            // 還原標題
            document.getElementById('review-modal-title').textContent = '審核操作';
        }
    }

    
    // 3. 刪除活動 (Requirement #1: 10分鐘軟刪除限制)
    window.handleDeleteCampaign = async function(id, createdTimeMillis) {
        const now = Date.now();
        const diffMinutes = (now - createdTimeMillis) / 1000 / 60;
        
        if (diffMinutes > 10) {
            alert('錯誤：活動建立已超過 10 分鐘，無法刪除 (只能在 10 分鐘內刪除)。');
            return;
        }

        if(!confirm('確定要刪除這個活動嗎？此操作無法復原。')) return;

        try {
            // 執行軟刪除
            await updateDoc(doc(db, "briefs", id), {
                isDeleted: true
            });
            alert('活動已刪除');
        } catch (error) {
            console.error("刪除失敗:", error);
            alert('刪除失敗');
        }
    };



    // === v2 (本次修改): 財務管理相關函式 START ===

    // 1. 切換付款方式 UI
    window.selectPaymentMethod = function(method) {
        // 重設所有按鈕樣式
        document.querySelectorAll('.payment-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 隱藏所有詳情區塊
        const bankDetails = document.getElementById('bank-transfer-details');
        if (bankDetails) bankDetails.classList.add('hidden');
        // (未來可在此處新增其他支付方式的區塊)

        // 啟用選中的項目
        if (method === 'bank') {
            document.getElementById('btn-pay-bank').classList.add('active');
            if (bankDetails) bankDetails.classList.remove('hidden');
        } else if (method === 'card') {
            document.getElementById('btn-pay-card').classList.add('active');
            // (顯示信用卡表單)
        } else if (method === 'epay') {
            document.getElementById('btn-pay-epay').classList.add('active');
            // (顯示電子支付選項)
        }
    }

    // 2. 提交銀行轉帳證明
    window.handleSubmitTransferProof = async function() {
        const user = auth.currentUser;
        if (!user) {
            alert('請先登入後再提交！');
            return;
        }

        const amountInput = document.getElementById('transfer-amount');
        const fileInput = document.getElementById('transfer-proof-file');
        const statusEl = document.getElementById('transfer-upload-status');
        const progressEl = document.getElementById('transfer-upload-progress');
        const submitBtn = document.getElementById('submit-transfer-proof-btn');

        const amount = parseInt(amountInput.value);
        const file = fileInput.files[0];

        // 驗證
        if (!amount || amount <= 0) {
            alert('請輸入有效的匯款金額！');
            return;
        }
        if (!file) {
            alert('請選擇要上傳的匯款截圖！');
            return;
        }

        try {
            submitBtn.disabled = true;
            submitBtn.textContent = '上傳中...';
            statusEl.textContent = '上傳中... 0%';
            progressEl.classList.remove('hidden');
            progressEl.value = 0;

            // 1. 上傳圖片至 Storage
            // 檔案路徑符合您的 Storage 規則: /logos/{userId}/{allPaths=**}
            const filePath = `logos/${user.uid}/transfer_proofs/${Date.now()}_${file.name}`;
            const fileRef = storageRef(storage, filePath);
            const uploadTask = uploadBytesResumable(fileRef, file);

            // 監聽上傳進度
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressEl.value = progress;
                    statusEl.textContent = `上傳中... ${Math.round(progress)}%`;
                }, 
                (error) => {
                    // 處理上傳失敗
                    console.error('檔案上傳失敗:', error);
                    alert('檔案上傳失敗，請稍後再試。');
                    statusEl.textContent = '上傳失敗，請重試。';
                    submitBtn.disabled = false;
                    submitBtn.textContent = '提交匯款證明';
                    progressEl.classList.add('hidden');
                }, 
                async () => {
                    // 2. 上傳成功，取得下載 URL
                    statusEl.textContent = '上傳完成，正在儲存紀錄...';
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    
                    // 3. 將紀錄寫入 Firestore
                    // 資料路徑符合您的 Firestore 規則: /users/{userId}/{document=**}
                    const transferDocRef = doc(collection(db, 'users', user.uid, 'transfers'));
                    
                    await setDoc(transferDocRef, {
                        amount: amount,
                        proofImageUrl: downloadURL,
                        status: 'pending', // 待審核
                        createdAt: serverTimestamp(),
                        userId: user.uid,
                        userEmail: user.email
                    });

                    // 4. 完成後的回饋
                    alert('匯款證明已提交！我們將盡快為您審核並加值。');
                    amountInput.value = '';
                    fileInput.value = null;
                    statusEl.textContent = '提交成功！';
                    submitBtn.disabled = false;
                    submitBtn.textContent = '提交匯款證明';
                    progressEl.classList.add('hidden');
                    selectPaymentMethod(null); // 隱藏銀行轉帳區塊
                }
            );

        } catch (error) {
            console.error('提交匯款證明時發生錯誤:', error);
            alert('提交失敗，請稍後再試。');
            statusEl.textContent = '提交失敗，請重試。';
            submitBtn.disabled = false;
            submitBtn.textContent = '提交匯款證明';
            progressEl.classList.add('hidden');
        }
    }

    // 3. 監聽帳戶餘額
    let unsubscribeBalance = null; // 用來儲存取消監聽的函式
    function listenForAccountBalance(userId) {
        if (unsubscribeBalance) unsubscribeBalance(); // 取消舊的監聽

        const balanceEl = document.getElementById('finance-account-balance');
        if (!balanceEl) return;
        
        // 假設餘額文件儲存在 /users/{userId}/finance/balance
        const balanceDocRef = doc(db, 'users', userId, 'finance', 'balance');

        unsubscribeBalance = onSnapshot(balanceDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                const balance = data.currentBalance || 0;
                balanceEl.textContent = `NT$ ${balance.toLocaleString()}`;
            } else {
                // 如果文件不存在，顯示 0
                balanceEl.textContent = 'NT$ 0';
                console.log('尚未建立餘額文件 (finance/balance)。');
            }
        }, (error) => {
            console.error('監聽餘額失敗:', error);
            balanceEl.textContent = 'NT$ ---';
        });
    }
    // === v2 (本次修改): 財務管理相關函式 END ===


        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('登入失敗：' + error.message);
            }
/* 功能：登出目前使用者，並處理錯誤訊息顯示。*/
        };

        window.handleLogout = async function() {
            try {
            await signOut(auth);
            } catch (error) {
                alert('登出失敗：' + error.message);
            }
/* 功能：以 Google 彈出視窗進行登入，成功後進入認證狀態。*/
        };

        window.handleGoogleLogin = async function() {
            const provider = new GoogleAuthProvider();
            try {
                // 直接使用我們在頂部匯入的 signInWithPopup
                const result = await signInWithPopup(auth, provider);
                console.log("Google 彈出視窗登入成功:", result.user);
            } catch (error) {
                console.error("Google 登入失敗，錯誤訊息:", error);
                alert("Google 登入時發生錯誤: " + error.message);
            }
        };


    // === 新增：真實連結 Instagram 的函式 ===
    window.connectInstagram = async function() {
        const user = auth.currentUser;
        if (!user) return alert('請先登入');

        const provider = new FacebookAuthProvider();
        // 這些權限很重要，確保有申請到讀取數據的權限
        provider.addScope('instagram_basic');
        provider.addScope('instagram_manage_insights');
        provider.addScope('pages_show_list');
        provider.addScope('pages_read_engagement');

        try {
            // 這行會彈出正確的 FB 視窗
            const result = await signInWithPopup(auth, provider);

            const credential = FacebookAuthProvider.credentialFromResult(result);
            const accessToken = credential.accessToken;

            console.log("拿到 Token 了！準備存入資料庫...");

            // 存入資料庫觸發後端
            // 注意：這裡使用了 doc, setDoc, serverTimestamp，請確認這三個也都有在上方 import 進來
            // (你的檔案原本應該已經有 import 這三個了)
            const userRef = doc(db, 'users', user.uid, 'tokens', 'facebook');
            await setDoc(userRef, {
                accessToken: accessToken,
                updatedAt: serverTimestamp()
            });

            alert("連結成功！後端正在分析數據...");

        } catch (error) {
            console.error("連結失敗:", error);
            alert("連結失敗: " + error.message);
        }
    };


// === 網紅財務變數 ===
    let currentInfluencerBalance = 0; // 用來暫存從資料庫讀到的餘額
    let unsubInfBalance = null; // 監聽器

    // 1. 監聽網紅的可提領餘額
    // 資料位置：users/{uid}/finance/influencer_balance (欄位: amount)
    // === 修改後的除錯版本 ===
    window.listenForInfluencerBalance = function(uid) {
        if (unsubInfBalance) unsubInfBalance(); 

        console.log("正在監聽網紅財務，目標 UID:", uid); // 檢查 1: 確認監聽的 ID 對不對


        const docRef = doc(db, 'users', uid, 'finance', 'influencer_balance');
        unsubInfBalance = onSnapshot(docRef, (docSnap) => {
            const el = document.getElementById('inf-balance-display');
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                console.log("找到資料了！內容是:", data); // 檢查 2: 確認有抓到資料
                
                // 確保 amount 是數字，避免 undefined
                currentInfluencerBalance = data.amount || 0;
            } else {
                console.warn("找不到資料！請確認資料庫路徑是否為:", docRef.path); // 檢查 3: 路徑錯誤提示
                currentInfluencerBalance = 0;
            }
            
            // 更新畫面
            if(el) {
                el.textContent = `NT$ ${currentInfluencerBalance.toLocaleString()}`;
                console.log("畫面已更新為:", el.textContent);
            } else {
                console.error("找不到畫面上的顯示元素 (id='inf-balance-display')");
            }
        });
    };




    // 2. 處理提領申請
    window.handleInfluencerWithdraw = async function() {
        const user = auth.currentUser;
        if (!user) return alert('請先登入');

        const bankCode = document.getElementById('inf-withdraw-bank').value;
        const account = document.getElementById('inf-withdraw-account').value;
        const amountStr = document.getElementById('inf-withdraw-amount').value;
        const amount = parseInt(amountStr);

        // --- 驗證邏輯 ---
        if (!bankCode) return alert('請選擇提領銀行');
        if (!account) return alert('請輸入銀行帳號');
        if (!amount || amount <= 0) return alert('請輸入有效的金額');
        
        // 規則 A: 金額是否大於餘額
        if (amount > currentInfluencerBalance) {
            return alert(`提領失敗：您的餘額不足 (目前餘額: ${currentInfluencerBalance})`);
        }

        // 規則 B: 是否為 1000 的倍數
        if (amount % 1000 !== 0) {
            return alert('提領失敗：金額必須是 1,000 的倍數 (例如 1000, 2000, 5000)');
        }

        if (!confirm(`確定要申請提領 NT$ ${amount.toLocaleString()} 至銀行帳號 (${bankCode}) ${account} 嗎？`)) {
            return;
        }

        try {
        // ✅ 修改這裡：寫在 user 底下的 withdrawals 子集合
        await addDoc(
            collection(db, "users", user.uid, "withdrawals"),
            {
                userId: user.uid,
                userEmail: user.email,
                role: 'influencer',
                amount: amount,
                bankCode: bankCode,
                bankAccount: account,
                status: 'pending',      // pending(待審核), approved(已撥款), rejected(拒絕)
                createdAt: serverTimestamp()
            }
        );


            alert('提領申請已送出！我們將由專人進行審核。');
            // 清空輸入框
            document.getElementById('inf-withdraw-amount').value = '';
        } catch (error) {
            console.error("提領申請失敗:", error);
            alert('系統忙碌中，請稍後再試');
        }
    };






        // ============================================================
    //  ★ 網紅個人資料與設定功能 (修復版：已搬入 Module 內)
    // ============================================================

    // 1. 上傳頭像功能
    window.uploadInfluencerAvatar = function() {
        const user = auth.currentUser;
        if (!user) return alert('請先登入');
        
        const file = document.getElementById('inf-avatar-file').files[0];
        if (!file) return alert('請先選擇圖片');

        const statusEl = document.getElementById('inf-upload-status');
        statusEl.textContent = '上傳中...';

        // 設定路徑：logos/使用者ID/檔名
        // 注意：這裡使用 storageRef 就不會報錯了，因為我們在 module 裡面
        const path = `logos/${user.uid}/influencer_avatar_${Date.now()}.png`;
        const ref = storageRef(storage, path); 
        const task = uploadBytesResumable(ref, file);

        task.on('state_changed', null, 
            (err) => {
                console.error(err);
                statusEl.textContent = '失敗';
                alert('上傳失敗');
            },
            async () => {
                // 上傳成功，取得網址
                const url = await getDownloadURL(task.snapshot.ref);
                
                // 1. 填入隱藏欄位 (為了存檔用)
                document.getElementById('inf-avatar-url').value = url;
                // 2. 更新目前表單上的預覽圖
                document.getElementById('inf-avatar-preview-form').src = url;
                // 3. 更新右側預覽卡片的圖 (如果有的話)
                const cardAvatar = document.getElementById('inf-card-avatar');
                if(cardAvatar) cardAvatar.src = url;
                
                statusEl.textContent = '完成';
            }
        );
    };


    // === 新增：網紅上傳行銷成果 ===
    window.handleUploadResults = async function(collabId, briefId, influencerId) {
        const fileInput = document.getElementById(`result-file-${collabId}`);
        if (!fileInput.files || fileInput.files.length === 0) return alert('請選擇檔案');

        if(!confirm('確定要上傳這些成果檔案嗎？')) return;

        try {
            const uploadPromises = Array.from(fileInput.files).map(file => {
                return new Promise((resolve, reject) => {
                    // 需求路徑：briefs/{briefId}/results/{influencerId}/{fileName}
                    // 但因為 briefs 結構我們可能不想動，或者你想用資料夾結構
                    // 建議使用：campaign_results/{briefId}/{influencerId}/{fileName} 比較獨立清晰
                    const path = `campaign_results/${briefId}/${influencerId}/${Date.now()}_${file.name}`;
                    const ref = storageRef(storage, path);
                    const task = uploadBytesResumable(ref, file);
                    
                    task.on('state_changed', null, reject, async () => {
                        const url = await getDownloadURL(task.snapshot.ref);
                        resolve({ name: file.name, url: url, type: file.type });
                    });
                });
            });

            const results = await Promise.all(uploadPromises);

            // 寫入資料庫
            // 寫在 collaborations 裡面做個紀錄
            await updateDoc(doc(db, "collaborations", collabId), {
                finalResults: results, // 儲存成果連結
                status: 'completed', // 標記為完全結束
                updatedAt: serverTimestamp()
            });

            // 也可以依照需求寫入 briefs 底下的子集合 (如果需要商家在 Brief 頁面看)
            // const resultRef = doc(collection(db, 'briefs', briefId, 'results'), influencerId);
            // await setDoc(resultRef, { files: results, influencerId: influencerId }, { merge: true });

            alert('成果上傳成功！');

        } catch (e) {
            console.error(e);
            alert('上傳失敗');
        }
    };


    // 2. 儲存個人資料功能
    window.handleSaveInfluencerProfile = async function() {
        const user = auth.currentUser;
        if(!user) return alert('請先登入');
        
        const ref = doc(db, 'users', user.uid, 'influencer', 'profile');
        
        const data = {
            name: document.getElementById('inf-name').value,
            contactEmail: document.getElementById('inf-contact-email').value,
            bio: document.getElementById('inf-bio').value,
            avatarUrl: document.getElementById('inf-avatar-url').value, // 記得存頭像
            socials: {
                instagram: document.getElementById('inf-ig').value,
                youtube: document.getElementById('inf-yt').value,
                tiktok: document.getElementById('inf-tt').value
            },
            updatedAt: serverTimestamp()
        };

        try {
            await setDoc(ref, data, { merge: true });
            alert('個人資料已更新！');
            // 這裡不需要手動更新卡片，因為下面的監聽器會自動處理
        } catch(e) {
            console.error(e);
            alert('儲存失敗: ' + e.message);
        }
    };

// === 1. 商家總覽邏輯 (統計數據 + 待辦事項) ===
    function initMerchantDashboard(uid) {
        // 設定日期
        document.getElementById('current-date').textContent = new Date().toLocaleDateString();
        
        // 監聽 Briefs (計算花費與總數)
        const qBriefs = query(collection(db, "briefs"), where("merchantId", "==", uid), where("isDeleted", "==", false));
        onSnapshot(qBriefs, (snap) => {
            let activeCount = 0;
            let totalSpend = 0;
            let totalImpressions = 0;
            
            snap.forEach(doc => {
                const data = doc.data();
                if (data.status === 'in_progress' || data.status === 'pending_match') activeCount++;
                totalSpend += (data.budget || 0);
                totalImpressions += (data.impressions || 0);
            });

            document.getElementById('m-stat-active').textContent = activeCount;
            document.getElementById('m-stat-spend').textContent = `NT$ ${totalSpend.toLocaleString()}`;
            document.getElementById('m-stat-reach').textContent = totalImpressions.toLocaleString();
        });

        // 監聽 Collaborations (找出待審核的)
        // 注意：這裡需要複合索引，如果報錯請按 Console 連結建立
        const qCollabs = query(collection(db, "collaborations"), where("merchantId", "==", uid));
        onSnapshot(qCollabs, (snap) => {
            const listEl = document.getElementById('m-action-list');
            listEl.innerHTML = '';
            let pendingReviewCount = 0;

            snap.forEach(docSnap => {
                const col = docSnap.data();
                // 待審核狀態
                if (col.status === 'reviewing' || col.status === 'submitting') {
                    pendingReviewCount++;
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 bg-yellow-50 border border-yellow-100 rounded-lg hover:bg-yellow-100 transition cursor-pointer';
                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                            <div>
                                <p class="text-sm font-bold text-slate-700">網紅提交了新素材</p>
                                <p class="text-xs text-gray-500">${col.influencerEmail}</p>
                            </div>
                        </div>
                        <button class="text-xs bg-white border border-gray-300 px-3 py-1 rounded shadow-sm">前往審核</button>
                    `;
                    item.onclick = () => switchTab('merchant', 'campaigns'); // 簡單導向
                    listEl.appendChild(item);
                }
            });

            document.getElementById('m-stat-pending').textContent = pendingReviewCount;
            
            if (pendingReviewCount === 0) {
                listEl.innerHTML = '<p class="text-gray-400 text-center py-4 text-sm">目前沒有待辦事項，一切順利！🎉</p>';
            }
        });
    }

    // === 2. 網紅總覽邏輯 (統計收益 + 個人資料) ===
    function initInfluencerDashboard(uid) {
        // 監聽合作案統計
        const q = query(collection(db, "collaborations"), where("influencerId", "==", uid));
        onSnapshot(q, (snap) => {
            let activeCount = 0;
            let totalCount = 0;
            // 這裡無法直接算收益，因為 collab 沒存金額 (金額在 brief)，簡化顯示
            // 實務上應該在接單時把 price 寫入 collaboration
            
            snap.forEach(doc => {
                const s = doc.data().status;
                totalCount++;
                if (s === 'accepted' || s === 'changes_requested' || s === 'reviewing') activeCount++;
            });

            document.getElementById('inf-stat-active').textContent = activeCount;
            document.getElementById('dash-collab-count').textContent = `合作 ${totalCount} 次`;
            
            // 順便呼叫渲染列表 (原本的函式)
            if(typeof renderInfluencerActiveJobs === 'function') {
                renderInfluencerActiveJobs();
            }
        });

        // 監聽財務 (餘額) -> 顯示本月收益
        // 這裡直接讀取我們之前做的 influencer_balance
        const financeRef = doc(db, 'users', uid, 'finance', 'influencer_balance');
        onSnapshot(financeRef, (snap) => {
            if(snap.exists()) {
                const amt = snap.data().amount || 0;
                document.getElementById('inf-stat-income').textContent = `NT$ ${amt.toLocaleString()}`;
            }
        });
    }




    // 3. ★ 監聽並即時更新「總覽頁面」與「設定頁面」
    let unsubInfProfile = null;
    function listenInfluencerProfile(uid) {
        if(unsubInfProfile) unsubInfProfile();

        const ref = doc(db, 'users', uid, 'influencer', 'profile');
        
        unsubInfProfile = onSnapshot(ref, (docSnap) => {
            // 取得總覽頁的卡片元素
            const overviewCard = document.getElementById('influencer-overview-card');
            // 取得設定頁的預覽卡片元素
            const settingCard = document.getElementById('inf-card-preview');
            
            if (!docSnap.exists()) {
                if(overviewCard) overviewCard.classList.add('hidden');
                return;
            }
            
            const data = docSnap.data();
            const name = data.name || '網紅';
            const email = data.contactEmail || '';
            const bio = data.bio || '尚無簡介';
            const avatar = data.avatarUrl || 'https://placehold.co/100?text=Me';
            
            // --- A. 更新總覽頁面的卡片 (Dashboard) ---
            if(overviewCard) {
                overviewCard.classList.remove('hidden'); // 顯示卡片
                document.getElementById('overview-inf-name').textContent = name;
                document.getElementById('overview-inf-email').textContent = email;
                document.getElementById('overview-inf-bio').textContent = bio;
                document.getElementById('overview-inf-avatar').src = avatar;
                
                // 產生徽章
                let badges = '';
                const s = data.socials || {};
                if(s.instagram) badges += `<span class="bg-pink-100 text-pink-800 px-2 py-1 rounded text-xs mr-1">IG</span>`;
                if(s.youtube) badges += `<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs mr-1">facebook</span>`;
                if(s.tiktok) badges += `<span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs">TT</span>`;
                document.getElementById('overview-badges').innerHTML = badges;
            }

            // --- B. 更新設定頁面的預覽卡片 (Settings Preview) ---
            if(settingCard) {
                document.getElementById('inf-card-name').textContent = name;
                document.getElementById('inf-card-email').textContent = email;
                document.getElementById('inf-card-bio').textContent = bio;
                document.getElementById('inf-card-avatar').src = avatar;
                
                const s = data.socials || {};
                document.getElementById('badge-ig').classList.toggle('hidden', !s.instagram);
                document.getElementById('badge-yt').classList.toggle('hidden', !s.youtube);
                document.getElementById('badge-tt').classList.toggle('hidden', !s.tiktok);
            }

            // --- C. 自動回填表單 (讓使用者編輯時不用重打) ---
            const nameInput = document.getElementById('inf-name');
            // 只有當欄位是空的時候才回填，避免干擾輸入
            if(nameInput && !nameInput.value) {
                nameInput.value = name === '網紅' ? '' : name;
                document.getElementById('inf-contact-email').value = email;
                document.getElementById('inf-bio').value = bio === '尚無簡介' ? '' : bio;
                if(data.avatarUrl) {
                    document.getElementById('inf-avatar-url').value = data.avatarUrl;
                    document.getElementById('inf-avatar-preview-form').src = data.avatarUrl;
                }
                const s = data.socials || {};
                document.getElementById('inf-ig').value = s.instagram || '';
                document.getElementById('inf-yt').value = s.youtube || '';
                document.getElementById('inf-tt').value = s.tiktok || '';
            }
        });
    }




        window.enterDashboard = function(role) {
            const user = auth.currentUser;
            if (!user) {
                alert('發生錯誤，請重新登入！');
                navigateTo('login-view');
                return;
            }

            if (role === 'merchant') {
                navigateTo('merchant-dashboard-view');
                document.getElementById('user-email-display').textContent = `你好, ${user.email}`;
                document.querySelector('#merchant-dashboard-view header button').classList.remove('hidden');
                switchTab('merchant', 'dashboard');
            } else if (role === 'influencer') {
                navigateTo('influencer-dashboard-view');
                document.querySelector('#influencer-dashboard-view header .text-gray-600').textContent = `你好, ${user.displayName || user.email}`;
                document.querySelector('#influencer-dashboard-view header button').classList.remove('hidden');
                switchTab('influencer', 'dashboard');
            }
        };





    // === 修改部分 START：修改 onAuthStateChanged 以啟動和停止監聽器 ===
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('使用者已登入，開始監聽活動...');
                // 當用戶登入後，立刻開始監聽他/她的活動資料
                listenForCampaigns();
                listenForAccountBalance(user.uid); // v2 (本次修改): 啟動餘額監聽
                // ⭐ 3. 網紅端財務管理：可提領金額
                listenForInfluencerBalance(user.uid);
                listenInfluencerProfile(user.uid);
                initMerchantDashboard(user.uid);   // 新增
                initInfluencerDashboard(user.uid); // 新增
                navigateTo('role-selection-view');
            } else {
                console.log('使用者已登出，停止監聽。');
                // 當用戶登出後，取消監聽，避免不必要的讀取和潛在的錯誤
                if (unsubscribeCampaigns) {
                    unsubscribeCampaigns();
                    unsubscribeCampaigns = null;
                }
                if (unsubscribeBalance) { // v2 (本次修改): 取消餘額監聽
                    unsubscribeBalance();
                    unsubscribeBalance = null;
                }
                // ⭐ 停止監聽網紅可提領金額
                if (unsubInfBalance) {
                    unsubInfBalance();
                    unsubInfBalance = null;
                }
                // v2 (本次修改): 重設餘額顯示
                const balanceEl = document.getElementById('finance-account-balance');
                if (balanceEl) balanceEl.textContent = 'NT$ 0';


                const infEl = document.getElementById('inf-balance-display');
                if (infEl) infEl.textContent = 'NT$ 0';

                navigateTo('login-view');
            }
        });
    // === 修改部分 END ===
    

// === 公司設定：Firestore 文件位置 ===
const companyDocRef = (uid) => doc(db, 'users', uid, 'company', 'profile');

// === Firebase Storage 初始化 (v2: 移到主 script module 頂部) ===
// const storage = getStorage(app); 

// === 公司卡片渲染 ===
function renderCompanyCard(data) {
  const card = document.getElementById('company-card');
  if (!card) return;
  if (!data) { card.classList.add('hidden'); return; }
  const S = (id) => document.getElementById(id);
  const { name, regNo, phone, address, website, logoUrl } = data;
  if (S('company-card-logo')) S('company-card-logo').src = logoUrl || '';
  if (S('company-card-name')) S('company-card-name').textContent = name || '(未命名公司)';
  if (S('company-card-regno')) S('company-card-regno').textContent = regNo ? `統編：${regNo}` : '';
  if (S('company-card-phone')) S('company-card-phone').textContent = phone || '';
  if (S('company-card-address')) S('company-card-address').textContent = address || '';
  if (S('company-card-website')) { S('company-card-website').textContent = website || ''; S('company-card-website').href = website || '#'; }
  card.classList.remove('hidden');
}

// === 設定頁預覽渲染 ===
function renderCompanyPreview(data) {
  const S = (id) => document.getElementById(id);
  if (!data) {
    if (S('company-preview-logo')) S('company-preview-logo').src = '';
    if (S('company-preview-name')) S('company-preview-name').textContent = '（尚未設定）';
    if (S('preview-line-phone')) S('preview-line-phone').textContent = '';
    if (S('preview-line-address')) S('preview-line-address').textContent = '';
    if (S('preview-line-website')) { S('preview-line-website').textContent = ''; S('preview-line-website').href = '#'; }
    if (S('company-preview-desc')) S('company-preview-desc').textContent = '';
    return;
  }
  const { name, phone, address, website, logoUrl, description } = data;
  if (S('company-preview-logo')) S('company-preview-logo').src = logoUrl || '';
  if (S('company-preview-name')) S('company-preview-name').textContent = name || '（尚未設定）';
  if (S('preview-line-phone')) S('preview-line-phone').textContent = phone ? `電話：${phone}` : '';
  if (S('preview-line-address')) S('preview-line-address').textContent = address ? `地址：${address}` : '';
  if (S('preview-line-website')) { S('preview-line-website').textContent = website || ''; S('preview-line-website').href = website || '#'; }
  if (S('company-preview-desc')) S('company-preview-desc').textContent = description || '';
}

// === 帶入表單 ===
function fillCompanyForm(data) {
  const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
  set('company-name', data?.name);
  set('company-regno', data?.regNo);
  set('company-phone', data?.phone);
  set('company-address', data?.address);
  set('company-website', data?.website);
  set('company-logo', data?.logoUrl);
  set('company-desc', data?.description);
}

// === 上傳 Logo 到 Storage ===
window.uploadCompanyLogo = function uploadCompanyLogo() {
  try { if (!auth || !auth.currentUser) { alert('請先登入'); return; } } catch (e) { alert('請先登入'); return; }
  const fileEl = document.getElementById('company-logo-file');
  if (!fileEl?.files?.[0]) { alert('請先選擇圖片檔'); return; }
  const file = fileEl.files[0];
  const uid = auth.currentUser.uid;
  const ext = (file.name.split('.').pop() || 'png').toLowerCase();
  const path = `logos/${uid}/company_logo_${Date.now()}.${ext}`;
  const refObj = storageRef(storage, path);

  const progressEl = document.getElementById('logo-upload-progress');
  const statusEl = document.getElementById('logo-upload-status');

  const task = uploadBytesResumable(refObj, file, { cacheControl: 'public,max-age=31536000' });
  task.on('state_changed',
    snap => {
      const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
      if (progressEl) progressEl.value = pct;
      if (statusEl) statusEl.textContent = `上傳中… ${pct}%`;
    },
    err => {
      console.error('上傳失敗：', err);
      if (statusEl) statusEl.textContent = '上傳失敗';
      alert('上傳失敗，請重試');
    },
    async () => {
      try {
        const url = await getDownloadURL(task.snapshot.ref);
        const urlInput = document.getElementById('company-logo');
        if (urlInput) urlInput.value = url;
        const prevImg = document.getElementById('company-preview-logo');
        if (prevImg) prevImg.src = url;
        if (statusEl) statusEl.textContent = '上傳完成';
        alert('上傳完成！已自動填入 Logo URL，請按「儲存」。');
      } catch (e) {
        console.error('取得下載連結失敗：', e);
        alert('取得下載連結失敗');
      }
    }
  );
};

// === 儲存公司資料到 Firestore ===
window.handleSaveCompany = async function handleSaveCompany() {
  const user = auth?.currentUser;
  if (!user) { alert('請先登入！'); return; }
  const data = {
    name: document.getElementById('company-name')?.value.trim() || '',
    regNo: document.getElementById('company-regno')?.value.trim() || '',
    phone: document.getElementById('company-phone')?.value.trim() || '',
    address: document.getElementById('company-address')?.value.trim() || '',
    website: document.getElementById('company-website')?.value.trim() || '',
    logoUrl: document.getElementById('company-logo')?.value.trim() || '',
    description: document.getElementById('company-desc')?.value.trim() || '',
    updatedAt: serverTimestamp(),
  };
  if (!data.name) { alert('請至少填寫「公司名稱」'); return; }
  try {
    const ref = companyDocRef(user.uid);
    const snap = await getDoc(ref);
    await setDoc(ref, { ...(snap.exists() ? {} : { createdAt: serverTimestamp() }), ...data }, { merge: true });
    const hint = document.getElementById('company-save-hint');
    if (hint) { hint.classList.remove('hidden'); setTimeout(() => hint.classList.add('hidden'), 1500); }
  } catch (e) {
    console.error('儲存公司資料失敗：', e);
    alert('儲存失敗，請稍後再試');
  }
};

// === 登入後監聽公司文件 ===
try {
  onAuthStateChanged(auth, (user) => {
    if (user) {
      if (window.__unsubCompany) { window.__unsubCompany(); window.__unsubCompany = null; }
      window.__unsubCompany = onSnapshot(companyDocRef(user.uid), (snap) => {
        const data = snap.exists() ? snap.data() : null;
        renderCompanyCard(data);
        renderCompanyPreview(data);
        fillCompanyForm(data || {});
      }, (err) => console.error('公司資料監聽失敗：', err));
    } else {
      if (window.__unsubCompany) { window.__unsubCompany(); window.__unsubCompany = null; }
      renderCompanyCard(null);
      renderCompanyPreview(null);
      fillCompanyForm({});
    }
  });
} catch (e) { console.warn('onAuthStateChanged 尚未可用'); }

</script>


<button id="theme-toggle-btn" class="theme-toggle" onclick="toggleTheme()">深/淺色切換</button>


<script>
(function() {
  function applyTheme(theme) {
    const root = document.documentElement;
    if (theme === 'dark') { root.classList.add('dark'); }
    else { root.classList.remove('dark'); }
    try { localStorage.setItem('theme', theme); } catch (e) {}
  }

  window.toggleTheme = function toggleTheme() {
    const current = (function(){ try { return localStorage.getItem('theme'); } catch(e) { return null; } })() || 'light';
    applyTheme(current === 'dark' ? 'light' : 'dark');
  };

  function initTheme() {
    let saved = null;
    try { saved = localStorage.getItem('theme'); } catch (e) { saved = null; }
    if (saved) {
      applyTheme(saved);
    } else {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
    }
  }

  // 初始載入
  initTheme();

  // 偵聽系統主題變化（若使用者未手動切換時才跟隨）
  try {
    const media = window.matchMedia('(prefers-color-scheme: dark)');
    media.addEventListener && media.addEventListener('change', (e) => {
      const saved = localStorage.getItem('theme');
      if (!saved) applyTheme(e.matches ? 'dark' : 'light');
    });
  } catch(e) {}
})();
</script>


<script>
(function() {
  function accentAI(node) {
    if (!node) return;
    var text = (node.textContent || '').trim();
    if (!text) return;
    if (/span/i.test(node.innerHTML)) return; // assume already styled by author
    if (/InfluenceAI/.test(text)) {
      var base = text.slice(0, -2);
      var last = text.slice(-2);
      node.innerHTML = base + '<span class="logo-accent">' + last + '</span>';
    }
  }
  accentAI(document.querySelector('#login-view h1')) ||
  accentAI(document.querySelector('#login-view .text-5xl')) ||
  accentAI(document.querySelector('#login-view .text-6xl'));
  // Also try headers in dashboards:
  accentAI(document.querySelector('header h1'));
  document.querySelectorAll('.sidebar .text-3xl, .sidebar .text-2xl').forEach(accentAI);
})();
</script>





<script>
/* v20: bi-directional reveal (enter = show, leave = hide), keep observing */
(function(){
  var opts = { threshold: [0, 0.12, 0.4, 1], rootMargin: "0px 0px -10% 0px" };
  var observer = new IntersectionObserver(function(entries){
    entries.forEach(function(entry){
      var el = entry.target;
      var d = el.getAttribute('data-delay') || '0ms';
      el.style.setProperty('--delay', d);
      if(entry.intersectionRatio >= 0.12){
        el.classList.add('is-visible');
      } else {
        el.classList.remove('is-visible');
      }
    });
  }, opts);

  function boot(){
    document.querySelectorAll('.reveal').forEach(function(el){ observer.observe(el); });
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>


<script>
(function(){
  const hint = document.querySelector('.scroll-hint');
  const hero = document.querySelector('#login-view .hero-viewport') 
            || document.querySelector('#login-view .min-h-screen');
  if(!hint || !hero) return;
  function update(v){ v ? hint.classList.add('is-visible') : hint.classList.remove('is-visible'); }
  if('IntersectionObserver' in window){
    const io = new IntersectionObserver((ents)=>{
      ents.forEach(e => update(e.isIntersecting));
    }, {threshold: 0.1});
    io.observe(hero);
    const r = hero.getBoundingClientRect();
    update(r.top < innerHeight && r.bottom > 0);
  }else{
    update(true);
    addEventListener('scroll', ()=>{
      const r = hero.getBoundingClientRect();
      update(r.top < innerHeight && r.bottom > 0);
    }, {passive:true});
  }
})();
</script>
<script>
(function(){
  function toggleBodyGlow(on){
    try{
      document.body.classList.toggle('glow-on', !!on);
      var bg = document.getElementById('bg-anim');
      if(bg) bg.style.display = on ? 'block' : 'none';
    }catch(e){}
  }
  // inject into ensureGlow flow by wrapping or redefining ensureGlow
  var _ensureGlow = window.ensureGlow;
  window.ensureGlow = function(){
    function visible(el){ if(!el) return false; var s = getComputedStyle(el); return s.display!=='none' && s.visibility!=='hidden' && (el.offsetParent!==null || s.position==='fixed'); }
    var onLogin = visible(document.getElementById('login-view'));
    var onRole  = visible(document.getElementById('role-selection-view'));
    if(onLogin || onRole){
      toggleBodyGlow(true);
      if(typeof addGlowLayer==='function') addGlowLayer();
    }else{
      toggleBodyGlow(false);
      if(typeof removeGlow==='function') removeGlow();
    }
    if(typeof _ensureGlow==='function'){ try{ _ensureGlow(); }catch(e){} }
  };
  // run once
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(window.ensureGlow,0); });
})();
</script>
<script>
// v5 patch: force-turn-off glow when entering any dashboard
(function(){
  function hardOffGlow(){
    document.body.classList.remove('glow-on');
    var bg = document.getElementById('bg-anim'); if(bg) bg.style.display = 'none';
    var g  = document.querySelector('.global-glow'); if(g) g.remove();
    document.documentElement.classList.remove('has-global-glow');
  }
  var _enterDashboard = window.enterDashboard;
  window.enterDashboard = function(role){
    hardOffGlow();
    if(typeof _enterDashboard === 'function'){
      return _enterDashboard(role);
    }
  };
})();
</script>

<script>
/* v6 hard fix: unified glow controller */
(function(){
  function hardOffGlow(){
    document.body.classList.remove('glow-on');
    var bg = document.getElementById('bg-anim'); if(bg){ bg.style.display='none'; bg.removeAttribute('style'); }
    var g = document.querySelectorAll('.global-glow'); g.forEach(function(x){ x.remove(); });
    document.documentElement.classList.remove('has-global-glow');
  }
  function hardOnGlow(){
    document.body.classList.add('glow-on');
    if(!document.querySelector('.global-glow')){
      var d=document.createElement('div'); d.className='global-glow'; document.body.prepend(d);
    }
  }
  function isVisible(el){
    if(!el) return false;
    var s = getComputedStyle(el);
    return s.display!=='none' && s.visibility!=='hidden' && (el.offsetParent!==null || s.position==='fixed');
  }
  function ensureGlow(){
    var onLogin = isVisible(document.getElementById('login-view'));
    var onRole  = isVisible(document.getElementById('role-selection-view'));
    if(onLogin || onRole){ hardOnGlow(); }
    else{ hardOffGlow(); }
  }
  window.ensureGlow = ensureGlow;
  var _navigateTo = window.navigateTo;
  window.navigateTo = function(viewId){
    if(_navigateTo) _navigateTo(viewId);
    var idStr = String(viewId||'').toLowerCase();
    if(idStr.includes('dashboard')){ hardOffGlow(); } else { ensureGlow(); }
  };
  var _enterDashboard = window.enterDashboard;
  window.enterDashboard = function(role){
    hardOffGlow();
    if(_enterDashboard) return _enterDashboard(role);
  };
  function checkHash(){
    var h = (location.hash||'').toLowerCase();
    if(h.includes('dashboard')) hardOffGlow(); else ensureGlow();
  }
  document.addEventListener('DOMContentLoaded', function(){
    ensureGlow();
    setTimeout(ensureGlow, 200);
  });
  window.addEventListener('hashchange', checkHash);
  window.addEventListener('popstate', checkHash);
  new MutationObserver(function(){ ensureGlow(); }).observe(document.body, {childList:true, subtree:true});
})();

// === 網紅價值：模擬社群連結與數據視覺化 ===
    
    // 模擬資料庫 (Mock Data)
    const mockPlatformData = {
        ig: { followers: 12500, er: 3.2, growth: [12000, 12100, 12250, 12380, 12500] },
        yt: { followers: 5600, er: 4.5, growth: [5400, 5450, 5500, 5550, 5600] },
        tt: { followers: 28000, er: 5.1, growth: [26000, 26500, 27200, 27800, 28000] },
        fb: { followers: 8000, er: 1.8, growth: [7950, 7960, 7980, 7990, 8000] }
    };

    let connectedPlatforms = new Set(); // 暫存已連線的平台

    // === 真實社群連結邏輯 ===

// 1. 定義各平台的授權 URL (請替換為你申請到的 Client ID)
const OAUTH_CONFIG = {
    // Meta (IG/FB) 設定
    ig: {
        authUrl: 'https://api.instagram.com/oauth/authorize',
        clientId: 'Y790282070637943', // ★ 請替換成你的 App ID
        redirectUri: 'https://test-b493a.firebaseapp.com/__/auth/handler', // 你的回調網址
        scope: 'user_profile,user_media'
    },
};

// 2. 發起連結 (取代原本的 simulateConnect)
window.connectRealPlatform = function(platform) {
    const user = auth.currentUser;
    if (!user) return alert('請先登入');

    const config = OAUTH_CONFIG[platform];
    if (!config) return alert('尚未支援此平台');

    // 產生隨機 State 以防止 CSRF 攻擊，並將 userId 藏在裡面以便 callback 時知道是誰
    const state = btoa(JSON.stringify({ uid: user.uid, platform: platform, nonce: Date.now() }));
    localStorage.setItem('oauth_state', state); // 暫存比對用

    let url = '';
    
    if (platform === 'ig') {
        url = `${config.authUrl}?client_id=${config.clientId}&redirect_uri=${encodeURIComponent(config.redirectUri)}&scope=${config.scope}&response_type=code&state=${state}`;
    } else if (platform === 'tt') {
        url = `${config.authUrl}?client_key=${config.clientKey}&redirect_uri=${encodeURIComponent(config.redirectUri)}&scope=${config.scope}&response_type=code&state=${state}`;
    }

    // 開啟授權視窗 (或是直接導頁)
    window.location.href = url; 
};

// 3. 監聽 Firestore 數據並更新圖表 (取代原本的 mock updateAnalyticsUI)
let unsubSocialStats = null;

window.listenForSocialStats = function(uid) {
    if (unsubSocialStats) unsubSocialStats();

    // 假設後端抓完資料後，會存在 users/{uid}/social_stats/current 文件中
    const ref = doc(db, 'users', uid, 'social_stats', 'current');

    unsubSocialStats = onSnapshot(ref, (docSnap) => {
        const dashboard = document.getElementById('analytics-dashboard');
        
        if (!docSnap.exists()) {
            // 如果還沒資料，隱藏儀表板或顯示空狀態
            // dashboard.classList.add('hidden'); 
            return;
        }

        dashboard.classList.remove('hidden');
        const data = docSnap.data();

        // --- 更新 UI 數字 ---
        // 假設資料結構: { ig: { followers: 100, er: 0.05 }, totalFans: 100, avgEr: 0.05 }
        document.getElementById('total-fans').textContent = (data.totalFans || 0).toLocaleString();
        document.getElementById('avg-er').textContent = `${((data.avgEr || 0) * 100).toFixed(2)}%`;
        
        // 計算分數 (簡單範例)
        const score = Math.min(100, Math.round((data.totalFans / 1000) * 0.5 + (data.avgEr * 1000) * 0.5));
        document.getElementById('score-val').textContent = score;

        // --- 更新連結按鈕狀態 ---
        ['ig', 'yt', 'tt', 'fb'].forEach(p => {
            const statusEl = document.getElementById(`status-${p}`);
            const btnEl = document.getElementById(`btn-connect-${p}`);
            
            if (data[p] && data[p].connected) {
                statusEl.textContent = '✅ 已連結';
                statusEl.className = 'text-xs text-green-600 font-bold';
                btnEl.textContent = '更新數據'; // 連結後變更新
                btnEl.onclick = () => alert('請求後端重新抓取數據...');
            }
        });

        // --- 繪製真實圖表 ---
        // 這裡需要後端有存歷史數據 (ex: history array)
        if (data.history) {
            renderCharts(data.history);
        }
    });
};

// 修改 onAuthStateChanged，登入後啟動監聽
// 在原本的 onAuthStateChanged 內加入:
// if (role === 'influencer') { listenForSocialStats(user.uid); }

    function updateAnalyticsUI() {
        const dashboard = document.getElementById('analytics-dashboard');
        if (connectedPlatforms.size > 0) {
            dashboard.classList.remove('hidden');
        }

        // 匯總數據
        let totalFans = 0;
        let totalEr = 0;
        let count = 0;
        let growthData = [0, 0, 0, 0, 0]; // 5 個時間點

        connectedPlatforms.forEach(p => {
            const data = mockPlatformData[p];
            totalFans += data.followers;
            totalEr += data.er;
            count++;
            // 累加成長數據
            data.growth.forEach((val, idx) => growthData[idx] += val);
        });

        const avgEr = count > 0 ? (totalEr / count).toFixed(1) : 0;
        const score = Math.min(100, Math.round(30 + (totalFans / 1000) + (avgEr * 5))); // 隨便算的公式

        // 填入數字
        document.getElementById('score-val').textContent = score;
        document.getElementById('total-fans').textContent = totalFans.toLocaleString();
        document.getElementById('avg-er').textContent = `${avgEr}%`;

        // 繪製圖表 (Chart.js)
        renderCharts(growthData);
    }

    let chartInstanceFollowers = null;
    let chartInstanceDemo = null;

    function renderCharts(growthData) {
        const ctxF = document.getElementById('chart-followers').getContext('2d');
        const ctxD = document.getElementById('chart-demo').getContext('2d');

        // 銷毀舊圖表以防重疊
        if (chartInstanceFollowers) chartInstanceFollowers.destroy();
        if (chartInstanceDemo) chartInstanceDemo.destroy();

        // 1. 粉絲成長折線圖
        chartInstanceFollowers = new Chart(ctxF, {
            type: 'line',
            data: {
                labels: ['4週前', '3週前', '2週前', '上週', '本週'],
                datasets: [{
                    label: '總粉絲數',
                    data: growthData,
                    borderColor: '#0d9488', // Teal
                    backgroundColor: 'rgba(13, 148, 136, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 2. 受眾分佈長條圖 (靜態模擬數據)
        chartInstanceDemo = new Chart(ctxD, {
            type: 'bar',
            data: {
                labels: ['13-17', '18-24', '25-34', '35-44', '45+'],
                datasets: [{
                    label: '男性',
                    data: [5, 15, 20, 10, 5],
                    backgroundColor: '#93c5fd' // Blue
                }, {
                    label: '女性',
                    data: [8, 25, 35, 15, 8],
                    backgroundColor: '#fca5a5' // Pink
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true } }
            }
        });
    }


</script>

</body>
</html>
