<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gemini Chat (Firestore Extension)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Noto Sans TC", sans-serif; background:#f7fafc; margin:0; }
    .app { max-width: 760px; margin: 32px auto; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); overflow:hidden; }
    header { padding:16px 20px; border-bottom:1px solid #eef2f7; display:flex; justify-content:space-between; align-items:center; }
    header h1 { font-size:18px; margin:0; }
    #status { font-size:12px; color:#666; }
    .messages { padding:20px; height:60vh; overflow:auto; }
    .msg { padding:12px 14px; margin-bottom:12px; border-radius:12px; line-height:1.55; white-space:pre-wrap; }
    .me { background:#e8f0fe; align-self:flex-end; }
    .bot { background:#f1f5f9; }
    .sys { background:#fef3c7; }
    .composer { display:flex; gap:8px; padding:16px; border-top:1px solid #eef2f7; }
    .composer input { flex:1; padding:12px 14px; border:1px solid #d9e1ec; border-radius:10px; font-size:16px; }
    .composer button { padding:12px 16px; border:none; border-radius:10px; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
    .composer button:disabled { opacity:.5; cursor:not-allowed; }
    .wrap { display:flex; flex-direction:column; gap:8px; }
    .hint { font-size:12px; color:#666; padding:0 20px 16px; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Gemini Chatbot (via Firebase Extension)</h1>
    <div id="status">尚未登入…</div>
  </header>

  <div class="hint">此頁面會：匿名登入 Firebase → 在 <code>users/{uid}/messages</code> 寫入 <code>prompt</code> → 監聽擴充程式寫回的 <code>response</code>。</div>

  <div id="messages" class="messages"></div>

  <div class="composer">
    <input id="text" placeholder="輸入訊息，例如：幫我用三點整理今天待辦" />
    <button id="send">送出</button>
  </div>
</div>

<script type="module">
  // ---- Firebase SDK (v9 模組版) ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { 
    getAuth, signInAnonymously, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, serverTimestamp, 
    onSnapshot, query, orderBy, limit 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // 1) 這裡換成你的專案設定（Firebase Console→專案設定→一般→你的Web App）
  const firebaseConfig = {
apiKey: "AIzaSyCtOwoKYJfrSshSfkipfMH9lTngRsfQLDc",
authDomain: "test-b493a.firebaseapp.com",
projectId: "test-b493a",
storageBucket: "test-b493a.firebasestorage.app",
messagingSenderId: "1089014108157",
appId: "1:1089014108157:web:2ac36c728f861795909394",
measurementId: "G-1GY922PWL9"
};


  // 2) 初始化
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $status = document.getElementById('status');
  const $messages = document.getElementById('messages');
  const $text = document.getElementById('text');
  const $send = document.getElementById('send');

  let uid = null;
  let msgsUnsub = null;

  function pushMsg(html, cls='bot') {
    const div = document.createElement('div');
    div.className = `msg ${cls}`;
    div.textContent = html;
    $messages.appendChild(div);
    $messages.scrollTop = $messages.scrollHeight;
  }

  // 3) 匿名登入
  signInAnonymously(auth).catch(e => {
    console.error(e);
    $status.textContent = '匿名登入失敗：' + e.message;
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    uid = user.uid;
    $status.textContent = '已登入（匿名）UID：' + uid;

    // 4) 監聽最新訊息（包含模型回覆）
    if (msgsUnsub) msgsUnsub();
    const msgsRef = collection(db, 'users', uid, 'messages');
    const q = query(msgsRef, orderBy('createTime', 'asc'), limit(50));
    msgsUnsub = onSnapshot(q, (snap) => {
      $messages.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        if (d.prompt) pushMsg('你：' + d.prompt, 'me');
        if (d.response) pushMsg('機器人：' + d.response, 'bot');
        if (d.status && !d.response) pushMsg('狀態：' + d.status, 'sys');
      });
    });
  });

  // 5) 送出訊息：在 messages 新增一筆含 prompt 的文件
  async function send() {
    const text = $text.value.trim();
    if (!text || !uid) return;
    $send.disabled = true;

    try {
      const msgsRef = collection(db, 'users', uid, 'messages');
      await addDoc(msgsRef, {
        prompt: text,                     // 擴充程式讀取的欄位
        createTime: serverTimestamp(),    // 用來排序
        // （可選）你也可以嘗試加參數，前提是你的擴充程式版本支援：
        // temperature: 0.4,
        // topK: 32,
        // topP: 0.95,
      });
      $text.value = '';
      // 擴充程式會在背景呼叫 Gemini，幾秒後把 response 寫回同筆文件。
    } catch (e) {
      console.error(e);
      alert('送出失敗：' + e.message);
    } finally {
      $send.disabled = false;
    }
  }

  $send.addEventListener('click', send);
  $text.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') send();
  });

  // 初始引導訊息
  pushMsg('👋 嗨！輸入訊息並送出，我會把它寫到 Firestore 的 users/{uid}/messages。擴充程式會自動用 Gemini 回覆，幾秒後你會看到 response。');
</script>
</body>
</html>
